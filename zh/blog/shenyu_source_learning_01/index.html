<!doctype html><html><head><title>Apache ShenYu网关学习(1)环境配置 · Apache ShenYu</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="The girl on the prairie"><meta name=generator content="Hugo 0.55.5"><link rel="shortcut icon" href=/img/favicon.png type=image/png><link href=https://unpkg.com/purecss@1.0.0/build/base-min.css rel=stylesheet><link href=/css/main.css rel=stylesheet><link href=/css/zoom-image.css rel=stylesheet><script src=/js/iconfont.js></script><script src=/js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script><script>window.SITE_LANGUAGE="zh"</script><script src=/js/app.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-187960192-2','auto');ga('send','pageview');}</script></head><body><header class=ss-header><nav class=navbar role=navigation aria-label="main navigation"><div class=navbar-brand><a class=logo-link style=font-size:25px;margin-right:50px href=/zh/><img class=logo src=/img/logo/apache-shenyu.png></a><div class=-show-mobile><a id=mobile-menu-icon><svg class="icon" aria-hidden="true"><use xlink:href="#icon-menu"/></svg></a><nav id=mobile-menu><div id=js-menu-search-mobile class=navbar-search-mobile><input class=input placeholder=请输入要搜索的关键词><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search"/></svg></div><a href=/zh/projects/shenyu/download/><span>下载</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/zh/projects/shenyu/overview/><span>文档</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/zh/community/subscribe-email/><span>社区</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/zh/news/><span>新闻</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/zh/awesome/><span>Awesome</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/blog/shenyu_source_learning_01/><span>English</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-transfer"/></svg></a></nav></div></div><div class="navbar-menu -hidden-mobile"><div class=navbar-start><a class=navbar-item href=/zh/projects/shenyu/download/>下载</a>
<a class=navbar-item href=/zh/projects/shenyu/overview/>文档</a>
<a class=navbar-item href=/zh/community/subscribe-email/>社区</a>
<a class=navbar-item href=/zh/news/>新闻</a>
<a class=navbar-item href=/zh/awesome/>Awesome</a>
<span class="navbar-item nav-hover"><a>Links</a><div class=dropdown-menu><a class=dropdown-item href=https://www.apache.org/>Apache Software Foundation</a>
<a class=dropdown-item href=https://github.com/apache/incubator-shenyu/issues>GitHub Issue Tracker</a>
<a class=dropdown-item href=https://www.apache.org/>License</a>
<a class=dropdown-item href=http://www.apache.org/events/current-event>Apache Events</a>
<a class=dropdown-item href=https://www.apache.org/licenses/>Security</a>
<a class=dropdown-item href=http://www.apache.org/foundation/sponsorship.html>Sponsor and Donate</a>
<a class=dropdown-item href=http://www.apache.org/foundation/thanks.html>Thanks</a></div></span></div><div class=navbar-end><div class=navbar-item><div id=js-menu-search class=navbar-search><input class=input placeholder=请输入要搜索的关键词><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search"/></svg></div></div><div class=navbar-item><a class=translation href=/blog/shenyu_source_learning_01/>En</a></div></div></div></nav></header><div class=ss-layout-container><main class="ss-layout-main -card"><div class=ss-meta><h1 class=title>Apache ShenYu网关学习(1)环境配置</h1><div class=meta>2021-01-15 ·
陈曦 ·
<span class=tags><a class=tag href=/zh/tags/apache-shenyu/ rel=tag>#Apache ShenYu</a></span></div></div><article class=typo><h1 id=soul源码分析-1-环境配置>Soul源码分析（1） 环境配置</h1><blockquote><p>soul is a High-Performance Java API Gateway</p><p>GitHub：<a href=https://github.com/apache/incubator-shenyu>https://github.com/apache/incubator-shenyu</a></p><p>官方文档：<a href=https://dromara.org/zh-cn/docs/soul/soul.html>https://dromara.org/zh-cn/docs/soul/soul.html</a></p></blockquote><h2 id=1-源代码准备>1. 源代码准备</h2><h3 id=1-1-fork-dromara-soul-https-github-com-apache-incubator-shenyu-git-源代码至自己的仓库-cchenxi-soul-https-github-com-cchenxi-soul-git>1.1. fork <a href=https://github.com/apache/incubator-shenyu.git>dromara/soul</a>源代码至自己的仓库<a href=https://github.com/cchenxi/soul.git>cchenxi/soul</a></h3><h3 id=1-2-clone自己仓库中的soul源代码至本地>1.2. clone自己仓库中的soul源代码至本地</h3><pre><code class=language-shell>git clone https://github.com/cchenxi/soul.git
</code></pre><h3 id=1-3-使用idea打开soul源代码>1.3.使用idea打开soul源代码</h3><h3 id=1-4-编译soul源代码>1.4.编译soul源代码</h3><p>执行以下maven命令，等待编译完成</p><p><img src=/img/shenyu/01/16106054898861.jpg alt=-w1723></p><pre><code class=language-shell>mvn clean package install -Dmaven.test.skip=true -Dmaven.javadoc.skip=true -Drat.skip=true -Dcheckstyle.skip=true
</code></pre><h2 id=2-启动-soul>2. 启动 <code>soul</code></h2><h3 id=2-1-启动-soul-admin-模块>2.1. 启动<code>soul-admin</code>模块</h3><blockquote><p><code>soul-admin</code>是soul网关的后台管理系统</p></blockquote><p>选择使用MySQL数据库存储网关数据，修改数据源配置为自己的数据库配置。</p><p><img src=/img/shenyu/01/16106065488032.jpg alt=-w1186></p><p>运行启动类 <code>org.dromara.soul.admin.SoulAdminBootstrap</code>。</p><p>启动成功后，访问地址 <a href=http://localhost:9095/>http://localhost:9095/</a> ，跳转到登录页↓</p><p><img src=/img/shenyu/01/16106069731233.jpg alt=-w593></p><p>使用用户名<code>admin</code>，密码 <code>123456</code> 登录。</p><p><img src=/img/shenyu/01/16106073045599.jpg alt=-w1262></p><h3 id=2-2-启动-soul-bootstrap-模块>2.2. 启动<code>soul-bootstrap</code>模块</h3><blockquote><p><code>soul-bootstrap</code>是网关系统的核心</p></blockquote><p>检查<code>soul-bootstrap</code>的配置</p><p><img src=/img/shenyu/01/16106076385761.jpg alt=-w917></p><p>这里需要配置成 <code>soul-admin</code>的ip和端口</p><p>控制台输出如下内容表示 <code>soul-bootstrap</code>启动成功</p><pre><code class=language-plain>2021-01-14 15:01:15.832  INFO 17943 --- [           main] b.s.s.d.w.WebsocketSyncDataConfiguration : you use websocket sync soul data.......
2021-01-14 15:01:15.924  INFO 17943 --- [           main] o.d.s.p.s.d.w.WebsocketSyncDataService   : websocket connection is successful.....
2021-01-14 15:01:16.113  INFO 17943 --- [           main] o.s.b.a.e.web.EndpointLinksResolver      : Exposing 2 endpoint(s) beneath base path '/actuator'
log4j:WARN No appenders could be found for logger (com.alibaba.dubbo.common.logger.LoggerFactory).
log4j:WARN Please initialize the log4j system properly.
log4j:WARN See http://logging.apache.org/log4j/1.2/faq.html#noconfig for more info.
2021-01-14 15:01:17.150  INFO 17943 --- [           main] o.s.b.web.embedded.netty.NettyWebServer  : Netty started on port(s): 9195
2021-01-14 15:01:17.154  INFO 17943 --- [           main] o.d.s.b.SoulBootstrapApplication         : Started SoulBootstrapApplication in 5.508 seconds (JVM running for 6.762)
</code></pre><h2 id=3-测试http请求转发>3. 测试http请求转发</h2><blockquote><p>为了方便测试，把<code>soul-examples</code>模块添加到soul的pom里</p></blockquote><h3 id=3-1-启动一个服务>3.1. 启动一个服务</h3><p>启动<code>soul-examples-http</code>项目</p><p><code>soul-examples-http</code>的pom中引入了依赖</p><pre><code class=language-xml>&lt;dependency&gt;
    &lt;groupId&gt;org.apache.shenyu&lt;/groupId&gt;
    &lt;artifactId&gt;soul-spring-boot-starter-client-springmvc&lt;/artifactId&gt;
    &lt;version&gt;${soul.version}&lt;/version&gt;
&lt;/dependency&gt;
</code></pre><p>在 <code>application.yml</code>中配置</p><pre><code class=language-yaml>soul:
  http:
    adminUrl: http://localhost:9095
    port: 8188
    contextPath: /http
    appName: http
    full: false
</code></pre><p>如果soul.http.full=false，则需要在具体的http接口上配置 <code>@SoulSpringMvcClient</code> 注解</p><h4 id=3-1-1-测试http服务>3.1.1. 测试http服务</h4><p>执行http请求 <code>http://localhost:8188/test/findByUserId?userId=1</code> 结果如下图</p><p><img src=/img/shenyu/01/16106235724795.jpg alt=-w684></p><h4 id=3-1-2-测试网关转发>3.1.2. 测试网关转发</h4><p>执行http请求 <code>http://localhost:9195/http/test/findByUserId?userId=1</code> 结果如下图</p><p><img src=/img/shenyu/01/16106237733891.jpg alt=-w665>
在<code>soul-bootstrap</code>的控制台中输出如下信息</p><pre><code class=language-shell>2021-01-14 20:42:57.123  INFO 29812 --- [work-threads-11] o.d.soul.plugin.base.AbstractSoulPlugin  : divide selector success match , selector name :/http
2021-01-14 20:42:57.125  INFO 29812 --- [work-threads-11] o.d.soul.plugin.base.AbstractSoulPlugin  : divide selector success match , selector name :/http/test/**
2021-01-14 20:42:57.126  INFO 29812 --- [work-threads-11] o.d.s.plugin.httpclient.WebClientPlugin  : The request urlPath is http://172.27.121.155:8188/test/findByUserId?userId=1, retryTimes is 0
</code></pre><p>可以观察到网关可以将请求正常转发。</p><h3 id=3-2-启动两个服务模拟负载均衡>3.2. 启动两个服务模拟负载均衡</h3><p>勾选 <code>Allow parallel run</code>，修改端口为<code>8189</code>，再次启动<code>soul-examples-http</code>项目</p><p><img src=/img/shenyu/01/16106249542903.jpg alt=-w1104></p><h4 id=3-2-1-测试http服务>3.2.1. 测试http服务</h4><p>执行http请求 <code>http://localhost:8189/test/findByUserId?userId=1</code> 结果如下图</p><p><img src=/img/shenyu/01/16106250513285.jpg alt=-w693></p><h4 id=3-2-2-测试负载均衡>3.2.2. 测试负载均衡</h4><p><img src=/img/shenyu/01/16106266610601.jpg alt=-w1096></p><p>将8188和8189两个端口对应的服务配置到选择器中</p><p>多次执行http请求 <code>http://localhost:9195/http/test/findByUserId?userId=1</code> 结果如下图</p><p><img src=/img/shenyu/01/16106267572581.jpg alt=-w595>
在<code>soul-bootstrap</code>的控制台中输出如下信息</p><pre><code class=language-shell>2021-01-14 20:48:34.460  INFO 29812 --- [work-threads-21] o.d.soul.plugin.base.AbstractSoulPlugin  : divide selector success match , selector name :/http
2021-01-14 20:48:34.460  INFO 29812 --- [work-threads-21] o.d.soul.plugin.base.AbstractSoulPlugin  : divide selector success match , selector name :/http/test/**
2021-01-14 20:48:34.460  INFO 29812 --- [work-threads-21] o.d.s.plugin.httpclient.WebClientPlugin  : The request urlPath is http://172.27.121.155:8189/test/findByUserId?userId=1, retryTimes is 0
2021-01-14 20:48:35.147  INFO 29812 --- [work-threads-22] o.d.soul.plugin.base.AbstractSoulPlugin  : divide selector success match , selector name :/http
2021-01-14 20:48:35.147  INFO 29812 --- [work-threads-22] o.d.soul.plugin.base.AbstractSoulPlugin  : divide selector success match , selector name :/http/test/**
2021-01-14 20:48:35.147  INFO 29812 --- [work-threads-22] o.d.s.plugin.httpclient.WebClientPlugin  : The request urlPath is http://172.27.121.155:8188/test/findByUserId?userId=1, retryTimes is 0
2021-01-14 20:48:38.755  INFO 29812 --- [work-threads-23] o.d.soul.plugin.base.AbstractSoulPlugin  : divide selector success match , selector name :/http
2021-01-14 20:48:38.756  INFO 29812 --- [work-threads-23] o.d.soul.plugin.base.AbstractSoulPlugin  : divide selector success match , selector name :/http/test/**
2021-01-14 20:48:38.756  INFO 29812 --- [work-threads-23] o.d.s.plugin.httpclient.WebClientPlugin  : The request urlPath is http://172.27.121.155:8188/test/findByUserId?userId=1, retryTimes is 0
2021-01-14 20:48:39.609  INFO 29812 --- [work-threads-24] o.d.soul.plugin.base.AbstractSoulPlugin  : divide selector success match , selector name :/http
2021-01-14 20:48:39.609  INFO 29812 --- [work-threads-24] o.d.soul.plugin.base.AbstractSoulPlugin  : divide selector success match , selector name :/http/test/**
2021-01-14 20:48:39.609  INFO 29812 --- [work-threads-24] o.d.s.plugin.httpclient.WebClientPlugin  : The request urlPath is http://172.27.121.155:8189/test/findByUserId?userId=1, retryTimes is 0
2021-01-14 20:48:40.317  INFO 29812 --- [work-threads-25] o.d.soul.plugin.base.AbstractSoulPlugin  : divide selector success match , selector name :/http
2021-01-14 20:48:40.317  INFO 29812 --- [work-threads-25] o.d.soul.plugin.base.AbstractSoulPlugin  : divide selector success match , selector name :/http/test/**
2021-01-14 20:48:40.317  INFO 29812 --- [work-threads-25] o.d.s.plugin.httpclient.WebClientPlugin  : The request urlPath is http://172.27.121.155:8188/test/findByUserId?userId=1, retryTimes is 0
2021-01-14 20:48:40.976  INFO 29812 --- [-work-threads-1] o.d.soul.plugin.base.AbstractSoulPlugin  : divide selector success match , selector name :/http
2021-01-14 20:48:40.976  INFO 29812 --- [-work-threads-1] o.d.soul.plugin.base.AbstractSoulPlugin  : divide selector success match , selector name :/http/test/**
2021-01-14 20:48:40.977  INFO 29812 --- [-work-threads-1] o.d.s.plugin.httpclient.WebClientPlugin  : The request urlPath is http://172.27.121.155:8188/test/findByUserId?userId=1, retryTimes is 0
</code></pre><p>可以观察到请求既有转发到8188端口的，也有转发到8189的，可以实现负载均衡</p><h4 id=3-2-3-压测>3.2.3. 压测</h4><p>简单对直连和使用网关两种方式的请求进行压测</p><pre><code class=language-shell>➜  soul git:(master) ✗ wrk -t8 -c40 -d30s http://localhost:8189/test/findByUserId\?userId\=1
Running 30s test @ http://localhost:8189/test/findByUserId?userId=1
  8 threads and 40 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     6.06ms   28.81ms 442.25ms   98.22%
    Req/Sec     2.05k   493.86     2.84k    74.82%
  486269 requests in 30.05s, 51.01MB read
Requests/sec:  16179.68
Transfer/sec:      1.70MB
➜  soul git:(master) ✗ wrk -t8 -c40 -d30s http://localhost:9195/http/test/findByUserId\?userId\=1
Running 30s test @ http://localhost:9195/http/test/findByUserId?userId=1
  8 threads and 40 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    14.37ms   18.11ms 255.66ms   93.06%
    Req/Sec   459.41    139.11     1.01k    74.23%
  109533 requests in 30.09s, 11.49MB read
Requests/sec:   3639.60
Transfer/sec:    390.98KB
</code></pre><p>可以发现，使用网关后性能有些下降，主要是因为多了一层转发。</p><h4 id=3-2-4-问题>3.2.4. 问题</h4><p>在启动8189端口时，注册的客户端端口还是8188</p><p><img src=/img/shenyu/01/16106270140398.jpg alt=-w1675></p><p>先手动配置选择器的配置，后来在群友的帮助下定位到是 <code>soul.http.port</code>没有改</p><p>修改后的配置如下</p><p><img src=/img/shenyu/01/16106405075031.jpg alt=-w520></p></article><div class=-show-mobile><nav class=ss-pagination-next><a class=link-prev href=/zh/blog/shenyu_source_learning_05_plugin/><span class=text>上一篇:</span>
<span class=text>Apache ShenYu网关学习插件链与负载均衡解析</span></a>
<a class=link-next href=/zh/blog/shenyu_source_learning_02_divide_plugin/><span class=text>下一篇:</span>
<span class=text>Apache ShenYu网关学习(2-1)Http代理之divide插件使用</span></a></nav></div></main><aside class=ss-layout-aside><div class=ss-card><h2 class=card-title>相关推荐</h2><ul class=ss-aside-related><li><a href=/zh/blog/shenyu_source_learning_05_plugin/>Apache ShenYu网关学习插件链与负载均衡解析</a></li><li><a href=/zh/news/shenyu-2.3.0/>【Soul 网关发布里程碑的2.3.0版本】新增支持GRPC，Tars，Sofa协议</a></li></ul></div><div class="ss-aside-tags ss-card"><h2 class=card-title>标签
<span class=card-extra></span></h2><ul class=tag-list><li class=tag><a href=/zh/tags/apache-shenyu/>Apache ShenYu</a></li><li class=tag><a href=/zh/tags/code-conduct/>Code Conduct</a></li><li class=tag><a href=/zh/tags/committer/>Committer</a></li><li class=tag><a href=/zh/tags/contributor/>Contributor</a></li><li class=tag><a href=/zh/tags/dreamcode/>DreamCode</a></li><li class=tag><a href=/zh/tags/gateway/>GateWay</a></li><li class=tag><a href=/zh/tags/icla/>ICLA</a></li><li class=tag><a href=/zh/tags/issue-pr/>Issue-PR</a></li><li class=tag><a href=/zh/tags/reactor/>Reactor</a></li><li class=tag><a href=/zh/tags/shenyu/>ShenYu</a></li><li class=tag><a href=/zh/tags/subscribe-email/>Subscribe-Email</a></li><li class=tag><a href=/zh/tags/two-fa/>Two-FA</a></li><li class=tag><a href=/zh/tags/vote-committer/>Vote-Committer</a></li></ul></div></aside></div><footer class=ss-footer><div class=container><div class=links><div class="cate  -show-mobile"><h2 class=cate-title>Apache</h2><a class=link href=https://www.apache.org/>Foundation</a>
<a class=link href=https://github.com/apache/incubator-shenyu/issues>GitHub Issue Tracker</a>
<a class=link href=https://www.apache.org/licenses/>License</a>
<a class=link href=https://www.apache.org/security/>Security</a>
<a class=link href=http://www.apache.org/events/current-event>Events</a>
<a class=link href=http://www.apache.org/foundation/sponsorship.html>Sponsorship</a>
<a class=link href=http://www.apache.org/foundation/thanks.html>Thanks</a></div><div class=cate><h2 class=cate-title>资源</h2><a class=link href=https://github.com/apache/incubator-shenyu>Github</a>
<a class=link href=/zh/projects/shenyu/overview/>文档</a></div><div class=cate><h2 class=cate-title>参与进来</h2><a class=link href=https://github.com/apache/incubator-shenyu/issues/new>反馈</a>
<a class=link href=/zh/community>社区</a>
<a class=link href=/zh/news>新闻</a></div><div class=cate><h2 class=cate-title>订阅邮件组</h2><a class=link href=/zh/community/subscribe-email/>如何订阅</a>
<a class=link href=mailto://dev-subscribe@shenyu.apache.org>订阅邮件</a>
<a class=link href=https://lists.apache.org/list.html?dev@shenyu.apache.org>邮件归档</a></div></div><div class=qrcode><div><img class=qrcode-img src=/img/qrcode/WechatIMG127.jpeg><p class=qrcode-desc>微信公众号</p></div></div></div><div class=copyright><p>Copyright © 2021 The Apache Software Foundation. Licensed under the Apache License, Version 2.0.
Apache ShenYu, Apache Incubator, Apache, the Apache feather logo, the Apache ShenYu logo and the Apache Incubator project logo are trademarks of The Apache Software Foundation.
Apache ShenYu is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator.
Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects.
While incubation status is not necessarily a reflection of the completeness or stability of the code,
it does indicate that the project has yet to be fully endorsed by the ASF.</p></div></footer></body></html>