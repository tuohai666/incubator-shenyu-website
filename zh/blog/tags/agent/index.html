<!doctype html>
<html lang="zh" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="alternate" type="application/rss+xml" href="/zh/blog/rss.xml" title="Apache ShenYu (Incubating) Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/blog/atom.xml" title="Apache ShenYu (Incubating) Blog Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Apache ShenYu (Incubating)" href="/zh/opensearch.xml">
<link rel="alternate" type="application/rss+xml" href="/zh/news/rss.xml" title="Apache ShenYu (Incubating) Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/news/atom.xml" title="Apache ShenYu (Incubating) Blog Atom Feed"><title data-react-helmet="true">One post tagged with &quot;agent&quot; | Apache ShenYu (Incubating)</title><meta data-react-helmet="true" property="og:title" content="One post tagged with &quot;agent&quot; | Apache ShenYu (Incubating)"><meta data-react-helmet="true" property="og:url" content="https://shenyu.apache.org//zh/blog/tags/agent"><meta data-react-helmet="true" name="docsearch:language" content="zh"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-react-helmet="true" rel="shortcut icon" href="/zh/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://shenyu.apache.org//zh/blog/tags/agent"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//blog/tags/agent" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//zh/blog/tags/agent" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//blog/tags/agent" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/zh/assets/css/styles.c16418f4.css">
<link rel="preload" href="/zh/assets/js/runtime~main.a84baa92.js" as="script">
<link rel="preload" href="/zh/assets/js/main.8bdf7661.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh/"><img src="/zh/img/logo.png" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/zh/img/logo.png" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"></a><a class="navbar__item navbar__link" href="/zh/download">下载</a><a class="navbar__item navbar__link" href="/zh/docs/index">文档</a><a class="navbar__item navbar__link" href="/zh/community/subscribe-email">社区</a><a class="navbar__item navbar__link" href="/zh/event/2.4.2-release">事件</a><a class="navbar__item navbar__link" href="/zh/news">新闻</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh/blog">博客</a><a class="navbar__item navbar__link" href="/zh/users">用户</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__item navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Foundation</a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">License</a></li><li><a href="https://www.apache.org/events/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events</a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks</a></li></ul></div></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__item navbar__link" href="/zh/docs/index">2.4.2</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/zh/docs/next/index">当前版本</a></li><li><a class="dropdown__link" href="/zh/docs/index">2.4.2</a></li><li><a class="dropdown__link" href="/zh/docs/2.4.1/index">2.4.1</a></li><li><a class="dropdown__link" href="/zh/docs/2.4.0/index">2.4.0</a></li><li><a class="dropdown__link" href="/zh/docs/2.3.0/index">2.3.0</a></li><li><a class="dropdown__link" href="/zh/versions">All versions</a></li></ul></div><a href="https://github.com/apache/incubator-shenyu" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__item navbar__link"><span><svg t="1631348384596" class="icon" viewBox="0 0 1024 1024" version="1.1" style="vertical-align:text-bottom;margin-right:5px" p-id="557" width="20" height="20"><path d="M547.797333 638.208l-104.405333-103.168 1.237333-1.28a720.170667 720.170667 0 0 0 152.490667-268.373333h120.448V183.082667h-287.744V100.906667H347.605333v82.218666H59.818667V265.386667h459.178666a648.234667 648.234667 0 0 1-130.304 219.946666 643.242667 643.242667 0 0 1-94.976-137.728H211.541333a722.048 722.048 0 0 0 122.453334 187.434667l-209.194667 206.378667 58.368 58.368 205.525333-205.525334 127.872 127.829334 31.232-83.84m231.424-208.426667h-82.218666l-184.96 493.312h82.218666l46.037334-123.306667h195.242666l46.464 123.306667h82.218667l-185.002667-493.312m-107.690666 287.744l66.56-178.005333 66.602666 178.005333z" fill="currentColor" p-id="558"></path></svg><span>简体中文</span></span></a><ul class="dropdown__menu"><li><a href="/blog/tags/agent" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">English</a></li><li><a href="/zh/blog/tags/agent" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">简体中文</a></li></ul></div><div class="react-toggle toggle_2i4l react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_iYfV">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV">🌞</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="searchBox_Bc3W"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-tags-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_SrOn thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_jISh margin-bottom--md">All Blog Posts</div><ul class="sidebarItemList_UfcF"><h4 class="categoryHeader_Xx2W">SPI</h4><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/zh/blog/SPI-SourceCode-Analysis-MatchStrategy-SPI">MatchStrategy--基于SPI的代码分析</a></li><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/zh/blog/SPI-SourceCode-Analysis-PredicateJudge-SPI">PredicateJudge-- 基于SPI的设计实现分析</a></li><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/zh/blog/SPI-SourceCode-Analysis-RateLimiter-SPI">RateLimiter SPI 代码分析</a></li><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/zh/blog/SPI-SourceCode-Analysis-LoadBalance-SPI">LoadBalance SPI 代码分析</a></li><h4 class="categoryHeader_Xx2W">Start</h4><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/zh/blog/Start-SourceCode-Analysis-Start-Demo">Apache ShenYu 启动示例</a></li><h4 class="categoryHeader_Xx2W">Agent</h4><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/zh/blog/Agent-SourceCode-Analysis">ShenYu-Agent 源码分析</a></li><h4 class="categoryHeader_Xx2W">DataSync</h4><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/zh/blog/DataSync-SourceCode-Analysis-Etcd-Data-Sync">Etcd数据同步源码分析</a></li><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/zh/blog/DataSync-SourceCode-Analysis-Http-Data-Sync">Http长轮询数据同步源码分析</a></li><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/zh/blog/DataSync-SourceCode-Analysis-Nacos-Data-Sync">Nacos数据同步源码分析</a></li><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/zh/blog/DataSync-SourceCode-Analysis-WebSocket-Data-Sync">WebSocket数据同步源码分析</a></li><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/zh/blog/DataSync-SourceCode-Analysis-ZooKeeper-Data-Sync">ZooKeeper数据同步源码分析</a></li><h4 class="categoryHeader_Xx2W">IntegrationTest</h4><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/zh/blog/IntegrationTest-Analysis">集成测试剖析</a></li><h4 class="categoryHeader_Xx2W">Plugin</h4><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/zh/blog/Plugin-SourceCode-Analysis-Context-Path-Plugin">Context-Path插件源码分析</a></li><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/zh/blog/Plugin-SourceCode-Analysis-Param-Mapping-Plugin">Param-Mapping插件源码分析</a></li><h4 class="categoryHeader_Xx2W">RegisterCenter</h4><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/zh/blog/RegisterCenter-SourceCode-Analysis-Http-Register">注册中心实现原理之Http注册</a></li></ul></nav></aside><main class="col col--7"><header class="margin-bottom--xl"><h1>One post tagged with &quot;agent&quot;</h1><a href="/zh/blog/tags">View All Tags</a></header><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/zh/blog/Agent-SourceCode-Analysis">ShenYu-Agent 源码分析</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2022-03-17T09:10:34.440Z">2022年3月17日</time> · One min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/midnight2104" target="_blank" rel="noopener noreferrer">midnight2104</a></div><small class="avatar__subtitle">Apache ShenYu Committer</small></div></div></header><div class="markdown"><blockquote><p><a href="https://shenyu.apache.org/zh/docs/index" target="_blank" rel="noopener noreferrer">Apache ShenYu</a> 是一个异步的，高性能的，跨语言的，响应式的 <code>API</code> 网关。</p></blockquote><p>在<code>ShenYu</code>网关中，<code>Apache ShenYu</code> 利用 <code>Java Agent</code> 和 <code>字节码增强</code> 技术实现了无痕埋点，使得用户无需引入依赖即可接入第三方可观测性系统，获取 <code>Traces</code>、<code>Metrics</code> 和 <code>Logging</code> 。</p><blockquote><p>本文基于<code>shenyu-2.4.2</code>版本进行源码分析，官网的介绍请参考 <a href="https://shenyu.apache.org/docs/user-guide/observability/observability/" target="_blank" rel="noopener noreferrer">可观测性</a> 。</p></blockquote><p>具体而言，就是<code>shenyu-agent</code>模块，它基于 <code>Java Agent</code> 机制，通过<code>ByteBuddy</code>字节码增强库，在类加载时增强对象，属于静态代理。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="aop术语"></a>AOP术语<a class="hash-link" href="#aop术语" title="Direct link to heading">#</a></h3><p>在分析源码之前，介绍下<code>AOP</code>相关的术语，便于后续的理解：</p><ul><li><code>JoinPoint</code>：连接点，程序运行中的时间点，比如方法的执行点；</li><li><code>PointCut</code>：切入点，匹配 <code>JoinPoint</code> 的条件；</li><li><code>Advice</code>：通知，具体的执行逻辑；</li><li><code>Target</code>：目标对象；</li><li><code>Proxy</code>：代理对象。</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="关于byte-buddy"></a>关于Byte Buddy<a class="hash-link" href="#关于byte-buddy" title="Direct link to heading">#</a></h3><p><code>Byte Buddy</code>是一个代码生成和操作库，在<code>Java</code>应用程序的运行期间创建和修改<code>Java</code>类。可以利用它创建任何类，不像<code>JDK</code>动态代理那样强制实现一个接口。此外，<code>Byte Buddy</code>提供了方便的API，用于手动、使用<code>Java</code>代理或在构建期间改变类。</p><ul><li>提供了非常方便的API接口，与强大的类，方法等匹配功能；</li><li>开箱即用，零学习成本，屏蔽了底层操作字节码技术；</li><li>强大的开放定制性功能，可以为任何实现的方法自定义字节码；</li><li>最少运行时生成代码原则，性能高效；</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1--premain入口"></a>1.  premain入口<a class="hash-link" href="#1--premain入口" title="Direct link to heading">#</a></h3><p><code>premain()函数</code>是<code>javaagent</code> 的入口函数，在 <code>ShenYu</code>由 <code>ShenyuAgentBootstrap</code> 提供并实现整个<code>agent</code>的逻辑。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * agent 启动入口类</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuAgentBootstrap {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 入口函数 premain.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void premain(final String arguments, final Instrumentation instrumentation) throws Exception {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. 读取配置文件</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuAgentConfigUtils.setConfig(ShenyuAgentConfigLoader.load());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2. 加载所有插件</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuAgentPluginLoader.getInstance().loadAllPlugins();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3. 创建 agent</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        AgentBuilder agentBuilder = new AgentBuilder.Default().with(new ByteBuddy().with(TypeValidation.ENABLED))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .ignore(ElementMatchers.isSynthetic())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .or(ElementMatchers.nameStartsWith(&quot;org.apache.shenyu.agent.&quot;));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        agentBuilder.type(ShenyuAgentTypeMatcher.getInstance())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .transform(new ShenyuAgentTransformer())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .with(AgentBuilder.RedefinitionStrategy.RETRANSFORMATION)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .with(new TransformListener()).installOn(instrumentation);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 4. 启动插件</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PluginLifecycleManager lifecycleManager = new PluginLifecycleManager();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        lifecycleManager.startup(ShenyuAgentConfigUtils.getPluginConfigMap());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Runtime.getRuntime().addShutdownHook(new Thread(lifecycleManager::close));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>premain函数</code>的核心逻辑，就是上面的四步操作：</p><ul><li><ol><li>读取配置文件；</li></ol></li><li><ol start="2"><li>加载所有插件；</li></ol></li><li><ol start="3"><li>创建 agent；</li></ol></li><li><ol start="4"><li>启动插件。</li></ol></li></ul><p>接下来的源码分析就依次分析这四个操作。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-读取配置文件"></a>2. 读取配置文件<a class="hash-link" href="#2-读取配置文件" title="Direct link to heading">#</a></h3><ul><li>ShenyuAgentConfigLoader#load()</li></ul><p>配置文件的处理由 <code>ShenyuAgentConfigLoader</code> 完成，代码实现如下：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuAgentConfigLoader {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 配置文件路径</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final String CONFIG_PATH = &quot;config-path&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 加载配置文件.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static ShenyuAgentConfig load() throws IOException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 读取配置文件路径</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String configPath = System.getProperty(CONFIG_PATH);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 如果没有配置，就读取默认的文件 shenyu-agent.yaml</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        File configFile = StringUtils.isEmpty(configPath) ? ShenyuAgentLocator.locatorConf(&quot;shenyu-agent.yaml&quot;) : new File(configPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 读取配置文件并解析</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuYamlEngine.agentConfig(configFile);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>可以通过<code>config-path</code>指定配置文件的路径，如果没有指定的话，就读取默认的配置文件 <code>shenyu-agent.yaml</code>，然后通过<code>ShenyuYamlEngine</code>来解析配置文件。</p><p>配置文件的格式是<code>yaml</code>格式，如何配置，请参考官网的介绍  <a href="https://shenyu.apache.org/docs/user-guide/observability/observability/" target="_blank" rel="noopener noreferrer">可观测性</a> 。</p><p>默认配置文件<code>shenyu-agent.yaml</code>的格式内容如下：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI ya"><pre tabindex="0" class="prism-code language-ya codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">appName: shenyu-agent  # 指定一个名称</span></span><span class="token-line" style="color:#393A34"><span class="token plain">supports:  # 当前支持哪些功能</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  tracing: # 链路追踪的插件</span></span><span class="token-line" style="color:#393A34"><span class="token plain">#    - jaeger   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">#    - opentelemetry</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     - zipkin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  metrics:  # 统计度量插件</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    - </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  logging:  # 日志信息插件</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    - </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">plugins:  # 每个插件的具体配置信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  tracing:   # 链路追踪的插件</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    jaeger:  # jaeger的相关配置</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      host: &quot;localhost&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      port: 5775</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      props:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SERVICE_NAME: &quot;shenyu-agent&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        JAEGER_SAMPLER_TYPE: &quot;const&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        JAEGER_SAMPLER_PARAM: &quot;1&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    opentelemetry:  # opentelemetry的相关配置</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      props:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        otel.traces.exporter: jaeger #zipkin #otlp</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        otel.resource.attributes: &quot;service.name=shenyu-agent&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        otel.exporter.jaeger.endpoint: &quot;http://localhost:14250/api/traces&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    zipkin: # zipkin的相关配置</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      host: &quot;localhost&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      port: 9411</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      props:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SERVICE_NAME: &quot;shenyu-agent&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        URL_VERSION: &quot;/api/v2/spans&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SAMPLER_TYPE: &quot;const&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SAMPLER_PARAM: &quot;1&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  metrics:   # 统计度量插件</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    prometheus: # prometheus的相关配置</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      host: &quot;localhost&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      port: 8081</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      props:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  logging:   # 日志信息插件</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    elasticSearch: # es的相关配置</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      host: &quot;localhost&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      port: 8082</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      props:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    kafka:   # kafka的相关配置</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      host: &quot;localhost&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      port: 8082</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      props:</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>需要开启哪个插件，就在<code>supports</code>中指定，然后再<code>plugins</code>指定插件的配置信息。</p><blockquote><p>到目前为止，<code>Apache ShenYu</code> 发布的最新版本是<code>2.4.2</code> 版本，可以支持<code>tracing</code>的插件有<code>jaeger</code>、<code>opentelemetry</code>和<code>zipkin</code>，<code>metrics</code>和<code>logging</code>将在后续的版本中陆续发布。</p></blockquote><ul><li>ShenyuYamlEngine#agentConfig()</li></ul><p><code>ShenyuYamlEngine</code>提供了如何自定义加载<code>yaml</code>格式的文件。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public static ShenyuAgentConfig agentConfig(final File yamlFile) throws IOException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try (</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               // 读取文件流</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                FileInputStream fileInputStream = new FileInputStream(yamlFile);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                InputStreamReader inputStreamReader = new InputStreamReader(fileInputStream)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //指定对应的class</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Constructor constructor = new Constructor(ShenyuAgentConfig.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //指定属性的class</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            TypeDescription customTypeDescription = new TypeDescription(AgentPluginConfig.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            customTypeDescription.addPropertyParameters(&quot;plugins&quot;, Map.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            constructor.addTypeDescription(customTypeDescription);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //通过Yaml工具包读取yaml文件 </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new Yaml(constructor, new Representer(DUMPER_OPTIONS)).loadAs(inputStreamReader, ShenyuAgentConfig.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>ShenyuAgentConfig</code>是指定的Class类：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuAgentConfig {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // appName 服务名称，默认是 shenyu-agent </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String appName = &quot;shenyu-agent&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // supports 支持哪些插件</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Map&lt;String, List&lt;String&gt;&gt; supports = new LinkedHashMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // plugins 插件的属性信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Map&lt;String, Map&lt;String, AgentPluginConfig&gt;&gt; plugins = new LinkedHashMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>AgentPluginConfig</code>是指定插件的Class类：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class AgentPluginConfig {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 指定插件的 host</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String host;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     // 指定插件的 port</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int port;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     // 指定插件的 password</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String password;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     // 指定插件的 其他属性props </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Properties props;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>通过配置文件，用户可以指定启用哪个插件，指定插件的属性信息。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="3-加载插件"></a>3. 加载插件<a class="hash-link" href="#3-加载插件" title="Direct link to heading">#</a></h3><ul><li>ShenyuAgentPluginLoader#loadAllPlugins()</li></ul><p>读取配置文件后，需要根据用户自定义的配置信息，加载指定的插件。由<code>ShenyuAgentPluginLoader</code>来完成。</p><p><code>ShenyuAgentPluginLoader</code>是一个自定义的类加载器，采用单例设计模式。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// 自定义类加载器，继承 ClassLoader</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuAgentPluginLoader extends ClassLoader implements Closeable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 私有变量</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private static final ShenyuAgentPluginLoader AGENT_PLUGIN_LOADER = new ShenyuAgentPluginLoader();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 私有构造器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private ShenyuAgentPluginLoader() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(ShenyuAgentPluginLoader.class.getClassLoader());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 公开静态方法</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static ShenyuAgentPluginLoader getInstance() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return AGENT_PLUGIN_LOADER;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 加载所有的插件.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void loadAllPlugins() throws IOException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1.定位插件路径</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        File[] jarFiles = ShenyuAgentLocator.locatorPlugin().listFiles(file -&gt; file.getName().endsWith(&quot;.jar&quot;));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(jarFiles)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2.加载插件定义</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;String, ShenyuAgentJoinPoint&gt; pointMap = new HashMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try (ByteArrayOutputStream outputStream = new ByteArrayOutputStream()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (File each : jarFiles) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                outputStream.reset();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                JarFile jar = new JarFile(each, true);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                jars.add(new PluginJar(jar, each));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        loadAgentPluginDefinition(pointMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;String, ShenyuAgentJoinPoint&gt; joinPointMap = ImmutableMap.&lt;String, ShenyuAgentJoinPoint&gt;builder().putAll(pointMap).build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3.设置拦截点</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuAgentTypeMatcher.getInstance().setJoinPointMap(joinPointMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="31-定位插件路径"></a>3.1 定位插件路径<a class="hash-link" href="#31-定位插件路径" title="Direct link to heading">#</a></h4><ul><li>ShenyuAgentLocator#locatorPlugin()</li></ul><p>整个<code>shenyu</code>项目经过<code>maven</code>打包后（执行<code>mvn clean install</code>命令），<code>agent</code>打包目录如下：</p><p><img src="/zh/assets/images/agent-jar-ddf92b3d50f674dbb1a77f9636794437.png"></p><p>插件文件都是<code>jar</code>包形式存在的。</p><ul><li><code>conf</code>目录是配置文件的目录位置；</li><li><code>plugins</code>目录是各个插件的目录位置。</li></ul><p>相应的定位插件路径源码处理逻辑如下：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// 默认插件位于   /plugins 目录下</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public static File locatorPlugin() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new File(String.join(&quot;&quot;, locatorAgent().getPath(), &quot;/plugins&quot;));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// 定位shenyu-agent.jar的绝对路径</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public static File locatorAgent() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 找 ShenyuAgentLocator 所在的类路径（包名）</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String classResourcePath = String.join(&quot;&quot;, ShenyuAgentLocator.class.getName().replaceAll(&quot;\\.&quot;, &quot;/&quot;), &quot;.class&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 找到 类 的绝对路径：磁盘路径+类路径</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        URL resource = ClassLoader.getSystemClassLoader().getResource(classResourcePath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        assert resource != null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String url = resource.toString();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 是否是以jar包形式存在</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int existFileInJarIndex = url.indexOf(&#x27;!&#x27;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        boolean isInJar = existFileInJarIndex &gt; -1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 从jar包找到路径 或 从资源文件中找路径</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return isInJar ? getFileInJar(url, existFileInJarIndex) : getFileInResource(url, classResourcePath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 从jar包找到路径</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static File getFileInJar(final String url, final int fileInJarIndex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // jar包所在的绝对路径</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String realUrl = url.substring(url.indexOf(&quot;file:&quot;), fileInJarIndex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 以绝对路径创建File对象</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            File agentJarFile = new File(new URL(realUrl).toURI());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 获取父文件</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return agentJarFile.exists() ? agentJarFile.getParentFile() : null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (final MalformedURLException | URISyntaxException ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>拿到所有的插件文件后，会去加载插件定义，即拦截点。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="32-加载拦截点"></a>3.2 加载拦截点<a class="hash-link" href="#32-加载拦截点" title="Direct link to heading">#</a></h4><ul><li>ShenyuAgentPluginLoader#loadAgentPluginDefinition()</li></ul><p>拦截点的默认配置是在 <code>conf/tracing-point.yaml</code>文件中，配置格式如下：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">pointCuts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">targetClass</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> org.apache.shenyu.plugin.global.GlobalPlugin  </span><span class="token comment" style="color:#999988;font-style:italic"># 拦截目标类</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">points</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> instanceMethod </span><span class="token comment" style="color:#999988;font-style:italic"># 拦截点类型</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> execute  </span><span class="token comment" style="color:#999988;font-style:italic"># 拦截目标方法</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">handlers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># 处理器</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">jaeger</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># 用于链路追踪的jaeger插件</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> org.apache.shenyu.agent.plugin.tracing.jaeger.handler.JaegerGlobalPluginHandler</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">opentelemetry</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 用于链路追踪的opentelemetry插件</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> org.apache.shenyu.agent.plugin.tracing.opentelemetry.handler.OpenTelemetryGlobalPluginHandler</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">zipkin</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 用于链路追踪的zipkin插件</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> org.apache.shenyu.agent.plugin.tracing.zipkin.handler.ZipkinGlobalPluginHandler</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // </span><span class="token punctuation" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">...</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>加载拦截点的方式是通过<code>SPI</code>的方式进行加载的，然后再收集这些拦截点。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain"> private void loadAgentPluginDefinition(final Map&lt;String, ShenyuAgentJoinPoint&gt; pointMap) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SPILoader.loadList(AgentPluginDefinition.class)  // SPI 加载拦截点</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .forEach(each -&gt; each.collector().forEach(def -&gt; {  // 收集拦截点</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    String classTarget = def.getClassTarget();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (pointMap.containsKey(classTarget)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ShenyuAgentJoinPoint pluginInterceptorPoint = pointMap.get(classTarget);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        pluginInterceptorPoint.getConstructorPoints().addAll(def.getConstructorPoints()); // 构造器类型拦截点</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        pluginInterceptorPoint.getInstanceMethodPoints().addAll(def.getInstanceMethodPoints()); // 实例方法类型拦截点</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        pluginInterceptorPoint.getStaticMethodPoints().addAll(def.getStaticMethodPoints()); // 静态方法类型拦截点</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        pointMap.put(classTarget, def);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>SPILoader.loadList(AgentPluginDefinition.class)</li></ul><p><code>AgentPluginDefinition</code>是拦截点接口，由<code>@SPI</code>标记：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@SPI // 该接口通过SPI进行加载</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface AgentPluginDefinition {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 收集拦截点 </span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Collection&lt;ShenyuAgentJoinPoint&gt; collector();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>TracingAgentPluginDefinition</code>是它的一个实现类，用于定义链路追踪的拦截点：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Join // SPI的实现类</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class TracingAgentPluginDefinition extends AbstractAgentPluginDefinition {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 创建拦截点</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected Collection&lt;JoinPointBuilder&gt; joinPointBuilder() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractAgentPluginDefinition implements AgentPluginDefinition {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 创建拦截点</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected abstract Collection&lt;JoinPointBuilder&gt; joinPointBuilder();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 收集拦截点信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public final Collection&lt;ShenyuAgentJoinPoint&gt; collector() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>类之间的继承关系如下：</p><p><img src="/zh/assets/images/agent-plugin-definition-50a8aedfcfa2f611803acc40d646fe35.png"></p><ul><li><p>AgentPluginDefinition#collector()</p><p><code>AgentPluginDefinition</code>只是一个接口，定义了收集拦截点的操作方法，具体实现交给了子类。</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractAgentPluginDefinition implements AgentPluginDefinition {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 子类去实现如何创建拦截点</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected abstract Collection&lt;JoinPointBuilder&gt; joinPointBuilder();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public final Collection&lt;ShenyuAgentJoinPoint&gt; collector() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 获取拦截点构建器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Collection&lt;JoinPointBuilder&gt; joinPointBuilders = joinPointBuilder();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 创建拦截点对象 ShenyuAgentJoinPoint</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return joinPointBuilders.stream().map(JoinPointBuilder::install).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> // 创建拦截点对象 ShenyuAgentJoinPoint</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public ShenyuAgentJoinPoint install() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 四个构造参数分别是：目标对象，构造器拦截点，实例方法拦截点，静态方法拦截点</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new ShenyuAgentJoinPoint(classTarget, constructorPoints, instanceMethodPoints, classStaticMethodPoints);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>TracingAgentPluginDefinition#joinPointBuilder()</p><p>创建用于链路追踪的拦截点。</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class TracingAgentPluginDefinition extends AbstractAgentPluginDefinition {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 创建拦截点    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected Collection&lt;JoinPointBuilder&gt; joinPointBuilder() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PointCutConfig config = null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 读取默认的拦截点配置文件</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            config = ShenyuYamlEngine.unmarshal(ShenyuAgentLocator.locatorConf(&quot;tracing-point.yaml&quot;), PointCutConfig.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (IOException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(&quot;Exception loader tracing point config is&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 创建拦截点  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return JoinPointBuilderFactory.create(config);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>JoinPointBuilderFactory#create()</p><p>根据指定的配置文件创建拦截点 。</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public static Collection&lt;JoinPointBuilder&gt; create(final PointCutConfig config) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //如果没有配置文件或为空，则返回空集合</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(config) || config.getPointCuts().isEmpty()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return Collections.emptyList();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return config.getPointCuts().stream() // 获取配置文件中定义的拦截点</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(pointCut -&gt; StringUtils.isNotEmpty(pointCut.getTargetClass())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &amp;&amp; !pointCut.getPoints().isEmpty() &amp;&amp; !pointCut.getHandlers().isEmpty()) // 拦截点必须要指定目标类，切入点，处理器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(pointCut -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    JoinPointBuilder builder = ShenyuAgentJoinPoint.interceptClass(pointCut.getTargetClass()); // 设置需要拦截的目标类</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Set&lt;String&gt; supports = ShenyuAgentConfigUtils.getSupports(); // 获取当前支持哪些插件</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    List&lt;String&gt; handlers = pointCut.getHandlers().entrySet().stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .filter(entry -&gt; supports.contains(entry.getKey())) // 指定的处理器必须是当前可支持的插件</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .flatMap(entry -&gt; entry.getValue().stream())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    String[] instanceMethods = pointCut</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .getPoints()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .filter(point -&gt; PointType.INSTANCE_METHOD.getName().equals(point.getType()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .map(Point::getName) // 拦截实例方法</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .toArray(String[]::new);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (instanceMethods.length &gt; 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        builder.aroundInstanceMethod(ElementMatchers.namedOneOf(instanceMethods)).handlers(handlers).build(); // 为实例方法添加匹配器用于后续运行时动态匹配，并添加对应的处理器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    String[] staticMethods = pointCut</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .getPoints()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .filter(point -&gt; PointType.STATIC_METHOD.getName().equals(point.getType()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .map(Point::getName)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .toArray(String[]::new); // 拦截静态方法</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (staticMethods.length &gt; 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        builder.aroundStaticMethod(ElementMatchers.namedOneOf(staticMethods)).handlers(handlers).build();// 为静态方法添加匹配器用于后续运行时动态匹配，并添加对应的处理器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    String[] constructorPoints = pointCut</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .getPoints()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .filter(point -&gt; PointType.CONSTRUCTOR.getName().equals(point.getType()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .map(Point::getName)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .toArray(String[]::new); // 拦截构造器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (constructorPoints.length &gt; 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        builder.onConstructor(ElementMatchers.namedOneOf(constructorPoints)).handlers(handlers).build();// 为构造器添加匹配器用于后续运行时动态匹配，并添加对应的处理器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return builder;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }).collect(Collectors.toList()); // 返回匹配结果</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>创建拦截点的主要实现逻辑是：根据配置文件读取配置信息，为指定的目标对象的目标方法添加相应的处理器。处理器有三种：实例方法处理器，静态方法处理器，构造函数处理器。</p><p>这里用到了<code>ElementMatchers.namedOneOf()</code> 方法，它表示方法名称在指定的参数中，就可以匹配上这个方法。<code>ElementMatchers</code>是<code>bytebuddy</code>中的一个类，在<code>ShenYu</code>中，<code>agent</code>的创建也通过<code>bytebuddy</code>完成的。</p><p>后续将收集到的拦截点创建为拦截点对象<code>ShenyuAgentJoinPoint</code>。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public final Collection&lt;ShenyuAgentJoinPoint&gt; collector() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 获取拦截点</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Collection&lt;JoinPointBuilder&gt; joinPointBuilders = joinPointBuilder();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 创建拦截点对象</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return joinPointBuilders.stream().map(JoinPointBuilder::install).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>收集完拦截点之后，用<code>Map</code>保存了这些拦截点信息。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// pointMap: Key和Value分别表示目标类，拦截点</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private void loadAgentPluginDefinition(final Map&lt;String, ShenyuAgentJoinPoint&gt; pointMap) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SPILoader.loadList(AgentPluginDefinition.class)  // SPI 加载拦截点</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .forEach(each -&gt; each.collector().forEach(def -&gt; {  // 收集拦截点</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    String classTarget = def.getClassTarget();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (pointMap.containsKey(classTarget)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ShenyuAgentJoinPoint pluginInterceptorPoint = pointMap.get(classTarget);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        pluginInterceptorPoint.getConstructorPoints().addAll(def.getConstructorPoints()); // 构造器类型拦截点</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        pluginInterceptorPoint.getInstanceMethodPoints().addAll(def.getInstanceMethodPoints()); // 实例方法类型拦截点</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        pluginInterceptorPoint.getStaticMethodPoints().addAll(def.getStaticMethodPoints()); // 静态方法类型拦截点</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        pointMap.put(classTarget, def); // 将拦截点信息保存到Map中</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="33-设置拦截点"></a>3.3 设置拦截点<a class="hash-link" href="#33-设置拦截点" title="Direct link to heading">#</a></h4><p>在加载所有插件的过程中最后一步是设置拦截点。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">     public void loadAllPlugins() throws IOException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1.定位插件路径</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2.加载插件定义</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3.设置拦截点</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuAgentTypeMatcher.getInstance().setJoinPointMap(joinPointMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>设置拦截点就是将拦截点集合保存到<code>ShenyuAgentTypeMatcher</code>类中。它实现了<code>ElementMatcher</code>接口，用于自定义匹配逻辑。<code>ElementMatcher</code>也是<code>bytebuddy</code>中的接口。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// 使用单例设计模式</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuAgentTypeMatcher extends ElementMatcher.Junction.AbstractBase&lt;TypeDefinition&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 创建实例</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ShenyuAgentTypeMatcher SHENYU_AGENT_TYPE_MATCHER = new ShenyuAgentTypeMatcher();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 拦截点集合</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Map&lt;String, ShenyuAgentJoinPoint&gt; joinPointMap;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private ShenyuAgentTypeMatcher() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 获取单例</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static ShenyuAgentTypeMatcher getInstance() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return SHENYU_AGENT_TYPE_MATCHER;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //自定义匹配逻辑，目标类在拦截点集合中就匹配成功</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean matches(final TypeDefinition target) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return joinPointMap.containsKey(target.getTypeName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 设置拦截点集合</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setJoinPointMap(final Map&lt;String, ShenyuAgentJoinPoint&gt; joinPointMap) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.joinPointMap = joinPointMap;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="4-创建-agent"></a>4. 创建 agent<a class="hash-link" href="#4-创建-agent" title="Direct link to heading">#</a></h3><p>通过创建的agent，用于改变目标类的行为。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain"> public static void premain(final String arguments, final Instrumentation instrumentation) throws Exception {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. 读取配置文件</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2. 加载所有插件</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3. 创建 agent</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        AgentBuilder agentBuilder = new AgentBuilder.Default().with(new ByteBuddy().with(TypeValidation.ENABLED)) // 通过ByteBuddy创建Agent，开启类型校验</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .ignore(ElementMatchers.isSynthetic()) // 忽略合成类</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .or(ElementMatchers.nameStartsWith(&quot;org.apache.shenyu.agent.&quot;)); // 忽略org.apache.shenyu.agent 的类</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        agentBuilder.type(ShenyuAgentTypeMatcher.getInstance())//匹配加载类型，匹配器是ShenyuAgentTypeMatcher</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .transform(new ShenyuAgentTransformer()) // 匹配成功的，通过ShenyuAgentTransformer改变其行为</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .with(AgentBuilder.RedefinitionStrategy.RETRANSFORMATION) //指定重定义策略</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .with(new TransformListener()) //指定一个监听器，监听运行过程中的事件</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .installOn(instrumentation); // 将修改应用到instrumentation中</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 4. 启动插件</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>在创建agent的过程中，需要注意两个点：</p><ul><li>是否匹配成功，由<code>ShenyuAgentTypeMatcher</code>决定；</li><li>匹配成功的类，通过<code>ShenyuAgentTransformer</code>改变其行为；</li></ul><p>接下来我们就来着重分析这两个类。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="41-定义匹配逻辑"></a>4.1 定义匹配逻辑<a class="hash-link" href="#41-定义匹配逻辑" title="Direct link to heading">#</a></h4><ul><li>ShenyuAgentTypeMatcher#matches()</li></ul><p><code>ShenyuAgentTypeMatcher</code>使用单例的设计模式，实现了<code>ElementMatcher</code>接口，重写了<code>matches()</code>方法。</p><p>是否能够匹配成功的逻辑是：如果目标类在拦截点<code>joinPointMap</code>集合中，就匹配成功。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuAgentTypeMatcher extends ElementMatcher.Junction.AbstractBase&lt;TypeDefinition&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Map&lt;String, ShenyuAgentJoinPoint&gt; joinPointMap;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 自定义匹配逻辑：如果目标类在拦截点joinPointMap集合中，就匹配成功</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean matches(final TypeDefinition target) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return joinPointMap.containsKey(target.getTypeName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="42-改变匹配类的行为"></a>4.2 改变匹配类的行为<a class="hash-link" href="#42-改变匹配类的行为" title="Direct link to heading">#</a></h4><p>在加载目标类时，如果匹配成功，会通过<code>ShenyuAgentTransformer</code>改变其行为，它实现了<code>Transformer</code>接口，重写了<code>transform()</code>方法，<code>Transformer</code>也是<code>bytebuddy</code>的一个接口。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuAgentTransformer implements Transformer {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //在匹配类中额外定义一个字段，传递上下文信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final String EXTRA_DATA = &quot;_$EXTRA_DATA$_&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //类型匹配器    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ShenyuAgentTypeMatcher MATCHER = ShenyuAgentTypeMatcher.getInstance();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //重写transform方法，重新定义匹配类的行为</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //加载类期间，执行一次</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Builder&lt;?&gt; transform(final Builder&lt;?&gt; builder, final TypeDescription typeDescription, final ClassLoader classLoader, final JavaModule module) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //不是匹配的类就跳过</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!MATCHER.containsType(typeDescription)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return builder;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //为该类新增加一个字段</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Builder&lt;?&gt; result = builder.defineField(EXTRA_DATA, Object.class, Opcodes.ACC_PRIVATE | Opcodes.ACC_VOLATILE).implement(TargetObject.class).intercept(FieldAccessor.ofField(EXTRA_DATA));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 获取拦截点</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuAgentJoinPoint joinPoint = MATCHER.loadShenyuAgentJoinPoint(typeDescription);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //拦截构造器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        result = interceptorConstructorPoint(typeDescription, joinPoint.getConstructorPoints(), result);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //拦截静态方法</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        result = interceptorStaticMethodPoint(typeDescription, joinPoint.getStaticMethodPoints(), result);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //拦截实例方法</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        result = interceptorInstanceMethodPoint(typeDescription, joinPoint.getInstanceMethodPoints(), result);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>在<code>transform()</code>方法中，重新定义了匹配类的行为：</p><ul><li>新增了字段，是<code>TargetObject</code>的子类，用于传递上下文；</li><li>根据指定配置，是否拦截构造器；</li><li>根据指定配置，是否拦截静态方法；</li><li>根据指定配置，拦截实例方法；</li></ul><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="423-拦截实例方法"></a>4.2.3 拦截实例方法<a class="hash-link" href="#423-拦截实例方法" title="Direct link to heading">#</a></h5><ul><li>ShenyuAgentTransformer#interceptorInstanceMethodPoint()</li></ul><p>根据切面构建实例方法拦截点，获取<code>Builder</code>对象。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private Builder&lt;?&gt; interceptorInstanceMethodPoint(final TypeDescription description, final Collection&lt;InstanceMethodPointCut&gt; pointCuts, final Builder&lt;?&gt; builder) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Collection&lt;ShenyuAgentTransformerPoint&lt;?&gt;&gt; points = description.getDeclaredMethods().stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(each -&gt; !(each.isAbstract() || each.isSynthetic())) //过滤抽象方法，合成方法</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(each -&gt; buildInstanceMethodTransformationPoint(pointCuts, each)) //构建实例方法拦截点</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(Objects::nonNull)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return getBuilder(description, builder, points); //获取Builder对象</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>ShenyuAgentTransformer#buildInstanceMethodTransformationPoint()</li></ul><p>过滤匹配上的方法，为方法获取对应的<code>handler</code>处理器，最后创建实例方法拦截点对象。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private ShenyuAgentTransformerPoint&lt;?&gt; buildInstanceMethodTransformationPoint(final Collection&lt;InstanceMethodPointCut&gt; pointCuts, final InDefinedShape methodDescription) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;InstanceMethodPointCut&gt; points = pointCuts.stream().filter(point -&gt; point.getMatcher().matches(methodDescription)).collect(Collectors.toList()); //过滤能够匹配上的方法</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (points.isEmpty()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;InstanceMethodHandler&gt; handlers = points.stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .flatMap(pointCut -&gt; pointCut.getHandlers().stream())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(handler -&gt; (InstanceMethodHandler) MATCHER.getOrCreateInstance(handler)) //获取对应的handler处理器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(Objects::nonNull)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new ShenyuAgentTransformerPoint&lt;&gt;(methodDescription, new InstanceMethodInterceptor(handlers));//创建实例方法拦截点对象，创建实例方法拦截器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>方法能否匹配成功：当前方法名称是否是在<code>tracing-point.yaml</code>文件中配置的方法名称；</p><p><code>handler</code>的获取：是根据<code>tracing-point.yaml</code>文件中配置的全限定名去加载对应的类。</p><ul><li>InstanceMethodInterceptor#intercept()</li></ul><p>实例方法拦截器<code>InstanceMethodInterceptor</code>会在运行期间动态处理拦截方法。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class InstanceMethodInterceptor {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 拦截目标对象.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param target 当前被拦截的目标对象</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param method 目标对象的目标方法</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param args 目标方法的参数</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param callable 目标方法调用</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return 目标方法调用结果</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @throws 异常信息</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @RuntimeType //定义运行时的目标方法</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object intercept(@This final Object target, @Origin final Method method, @AllArguments final Object[] args, @SuperCall final Callable&lt;?&gt; callable) throws Exception {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //目标方法执行结果</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object result = null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //目标对象</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        TargetObject instance = (TargetObject) target;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //依次调用handler</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (InstanceMethodHandler handler : handlerList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            MethodResult methodResult = new MethodResult();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 前置处理逻辑</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                handler.before(instance, method, args, methodResult);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (final Throwable ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.error(&quot;Failed to execute the before method of method {} in class {}&quot;, method.getName(), target.getClass(), ex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //调用目标方法</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                result = callable.call();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (final Throwable ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               //处理异常</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    handler.onThrowing(instance, method, args, ex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (final Throwable ignored) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOG.error(&quot;Failed to execute the error handler of method {} in class {}&quot;, method.getName(), target.getClass(), ex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw ex;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } finally {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //后置处理逻辑</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    result = handler.after(instance, method, args, methodResult, result);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (final Throwable ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOG.error(&quot;Failed to execute the after method of method {} in class {}&quot;, method.getName(), target.getClass(), ex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //返回目标方法调用结果</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>实例方法拦截器在目标方法调用前，增加了前置处理逻辑，后置处理逻辑，以及异常处理逻辑。</p><p>这里用到了<code>Byte Buddy</code>的几个注解：</p><ul><li><code>@RuntimeType</code>：	定义运行时的目标方法，提示<code>ByteBuddy</code>禁用严格的类型检查；</li><li><code>@This</code>：当前被拦截的、动态生成的实例对象；</li><li><code>@Origin</code>：原有方法；</li><li><code>@AllArguments</code>：获取所有入参；</li><li><code>@SuperCall</code>：用于调用父类版本的方法。</li></ul><p>实例方法处理器<code>InstanceMethodHandler</code>只是定义了三个接口，具体实现逻辑由具体插件去处理。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public interface InstanceMethodHandler {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     // 前置处理逻辑</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    default void before(final TargetObject target, final Method method, final Object[] args, final MethodResult result) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 后置处理逻辑</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    default Object after(final TargetObject target, final Method method, final Object[] args, final MethodResult methodResult, final Object result) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 异常处理逻辑</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    default void onThrowing(final TargetObject target, final Method method, final Object[] args, final Throwable throwable) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>ShenyuAgentTransformer#getBuilder()</p><p>在<code>Agent</code>的<code>Builder</code>获取时，为指定的目标方法指定对应的拦截器，在原有方法上添加新的逻辑，改变原有方法行为。</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static Builder&lt;?&gt; getBuilder(final TypeDescription description, final Builder&lt;?&gt; builder, final Collection&lt;ShenyuAgentTransformerPoint&lt;?&gt;&gt; points) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Builder&lt;?&gt;[] result = {builder};</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        points.forEach(point -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                result[0] = builder.method(ElementMatchers.is(point.getDescription()))//指定目标方法</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        .intercept(MethodDelegation.withDefaultConfiguration().to(point.getInterceptor()));//指定拦截器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // CHECKSTYLE:OFF</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (final Throwable ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // CHECKSTYLE:ON</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.error(&quot;Failed to load handler class: {}&quot;, description.getTypeName(), ex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result[0];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>通过以上的处理逻辑，就可以实现无侵入拦截实例方法了。</p><p>拦截方法<code>intercept()</code>的处理逻辑是：</p><ul><li>依次处理每个<code>handler</code>；</li><li>调用<code>handler</code>的前置方法；</li><li>调用目标方法；</li><li>如果目标方法有异常，则调用<code>handler</code>的异常处理方法；</li><li>调用<code>handler</code>的后置方法。</li></ul><p>接下来看看拦截静态方法。</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="423-拦截静态方法"></a>4.2.3 拦截静态方法<a class="hash-link" href="#423-拦截静态方法" title="Direct link to heading">#</a></h5><ul><li>ShenyuAgentTransformer#interceptorStaticMethodPoint()</li></ul><p>过滤出静态方法，然后为静态方法构建静态方法拦截点。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private Builder&lt;?&gt; interceptorStaticMethodPoint(final TypeDescription description, final Collection&lt;StaticMethodPointCut&gt; pointCuts, final Builder&lt;?&gt; builder) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Collection&lt;ShenyuAgentTransformerPoint&lt;?&gt;&gt; points = description.getDeclaredMethods().stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(each -&gt; each.isStatic() &amp;&amp; !(each.isAbstract() || each.isSynthetic())) // 当前方法是静态方法，不是抽象方法，不是合成方法</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(methodDescription -&gt; buildStaticMethodTransformationPoint(pointCuts, methodDescription)) // 构建静态方法拦截点</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(Objects::nonNull)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return getBuilder(description, builder, points);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>ShenyuAgentTransformer#buildStaticMethodTransformationPoint()</li></ul><p>根据配置文件进行过滤，判断当前的静态方法是否需要拦截。然后获取对应的处理器，最后构建静态方法拦截器对象。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private ShenyuAgentTransformerPoint&lt;?&gt; buildStaticMethodTransformationPoint(final Collection&lt;StaticMethodPointCut&gt; pointCuts, final InDefinedShape methodDescription) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;StaticMethodPointCut&gt; staticMethodPoints = pointCuts.stream().filter(point -&gt; point.getMatcher().matches(methodDescription)).collect(Collectors.toList()); //根据配置文件进行过滤，判断当前的静态方法是否需要拦截</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (staticMethodPoints.isEmpty()) { // 如果没有配置，就直接返回了</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;StaticMethodHandler&gt; handlers = staticMethodPoints.stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .flatMap(pointCut -&gt; pointCut.getHandlers().stream())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(handler -&gt; (StaticMethodHandler) MATCHER.getOrCreateInstance(handler)) //获取对应的处理器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(Objects::nonNull)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new ShenyuAgentTransformerPoint&lt;&gt;(methodDescription, new StaticMethodInterceptor(handlers)); //构建静态方法拦截器对象</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>StaticMethodInterceptor#intercept()</li></ul><p>在运行时，会拦截目标方法，执行拦截器的处理逻辑 。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class StaticMethodInterceptor {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   //......  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 拦截目标方法.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @RuntimeType</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object intercept(@Origin final Class&lt;?&gt; klass, @Origin final Method method, @AllArguments final Object[] args, @SuperCall final Callable&lt;?&gt; callable) throws Exception {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object result = null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // handler循环处理</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (StaticMethodHandler handler : handlerList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            MethodResult methodResult = new MethodResult();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //前置方法</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                handler.before(klass, method, args, new MethodResult());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (final Throwable ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.error(&quot;Failed to execute the before method of method {} in class {}&quot;, method.getName(), klass, ex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 调用当前方法</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 目标方法是不是应该只会被调用一次？</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                result = callable.call();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (final Throwable ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    //异常逻辑处理</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    handler.onThrowing(klass, method, args, ex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (final Throwable ignored) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOG.error(&quot;Failed to execute the error handler of method {} in class {}&quot;, method.getName(), klass, ex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw ex;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } finally {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 后置方法</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    handler.after(klass, method, args, methodResult);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (final Throwable ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOG.error(&quot;Failed to execute the after method of method {} in class {}&quot;, method.getName(), klass, ex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //返回方法调用结果</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>拦截方法<code>intercept()</code>的处理逻辑是：</p><ul><li>依次处理每个<code>handler</code>；</li><li>调用<code>handler</code>的前置方法；</li><li>调用目标方法；</li><li>如果目标方法有异常，则调用<code>handler</code>的异常处理方法；</li><li>调用<code>handler</code>的后置方法。</li></ul><p>最后再看看如何拦截构造器。</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="423-拦截构造器"></a>4.2.3 拦截构造器<a class="hash-link" href="#423-拦截构造器" title="Direct link to heading">#</a></h5><ul><li>ShenyuAgentTransformer#interceptorConstructorPoint()</li></ul><p>过滤出构造器，然后构建构造器的拦截点，最后创建<code>builder</code>对象，为构造方法添加拦截器。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain"> private Builder&lt;?&gt; interceptorConstructorPoint(final TypeDescription description, final Collection&lt;ConstructorPointCut&gt; constructorPoints, final Builder&lt;?&gt; builder) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Collection&lt;ShenyuAgentTransformerPoint&lt;? extends ConstructorInterceptor&gt;&gt; constructorAdviceComposePoints = description.getDeclaredMethods().stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(MethodDescription::isConstructor) //过滤出构造器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(each -&gt; buildConstructorTransformerPoint(constructorPoints, each))//构建构造器的拦截点</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(Objects::nonNull)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Builder&lt;?&gt;[] result = {builder};</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     // 创建builder对象，为构造方法添加拦截器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        constructorAdviceComposePoints.forEach(point -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                result[0] = builder.constructor(ElementMatchers.is(point.getDescription()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        .intercept(SuperMethodCall.INSTANCE.andThen(MethodDelegation.withDefaultConfiguration()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                .to(point.getInterceptor())));//先调用父类构造器，然后添加拦截器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // CHECKSTYLE:OFF</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (final Throwable ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // CHECKSTYLE:ON</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.error(&quot;Failed to load handler class: {}&quot;, description.getTypeName(), ex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result[0];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>ShenyuAgentTransformer#buildConstructorTransformerPoint()</li></ul><p>先获取到构造器拦截点，然后为拦截点创建<code>handler</code>实例对象，最后创建构造器拦截器对象。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private ShenyuAgentTransformerPoint&lt;? extends ConstructorInterceptor&gt; buildConstructorTransformerPoint(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final Collection&lt;ConstructorPointCut&gt; constructorPoints, final InDefinedShape methodDescription) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //获取构造器拦截点</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ConstructorPointCut&gt; constructorPointCutList = constructorPoints.stream().filter(each -&gt; each.getMatcher().matches(methodDescription)).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (constructorPointCutList.isEmpty()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ConstructorHandler&gt; handlers = constructorPointCutList.stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .flatMap(pointCut -&gt; pointCut.getHandlers().stream())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(handler -&gt; (ConstructorHandler) MATCHER.getOrCreateInstance(handler)) //创建拦截点的handler实例对象</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(Objects::nonNull)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new ShenyuAgentTransformerPoint&lt;&gt;(methodDescription, new ConstructorInterceptor(handlers));//创建构造器拦截器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>ConstructorInterceptor#intercept()</li></ul><p>构造器拦截器：在调用目标方法的构造器之前，执行每个<code>handler</code>的处理逻辑。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ConstructorInterceptor {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 拦截方法.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @RuntimeType</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void intercept(@This final TargetObject target, @AllArguments final Object[] args) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (ConstructorHandler handler : handlerList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // handler处理逻辑</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                handler.onConstructor(target, args);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (final Throwable throwable) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.error(&quot;Constructor advice execution error. class: {}&quot;, target.getClass().getTypeName(), throwable);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>分析到此，我们分析完了创建<code>agent</code>的整个过程：</p><ul><li>根据配置文件，定义匹配逻辑<code>ShenyuAgentTypeMatcher</code>；</li><li>定义<code>ShenyuAgentTransformer</code>对象，改变匹配类的行为；</li><li>通过<code>InstanceMethodInterceptor</code>拦截实例对象方法；</li><li>通过<code>StaticMethodInterceptor</code>拦截静态方法；</li><li>通过<code>ConstructorInterceptor</code>拦截构造器。</li></ul><p>这里没有提到每个<code>handler</code>的处理逻辑，是因为<code>handler</code>的实现逻辑由每个插件自定义。比如，当前实例方法拦截器<code>InstanceMethodHandler</code>的实现类就有<code>jaeger</code>，<code>opentelemetry</code>和<code>zipkin</code>。</p><p><img src="/zh/assets/images/instance_method_handler-309e74ac5f633743f57a9b60039f2486.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="5-启动插件"></a>5. 启动插件<a class="hash-link" href="#5-启动插件" title="Direct link to heading">#</a></h3><p>创建完 <code>agent</code>之后，启动各个插件。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain"> public static void premain(final String arguments, final Instrumentation instrumentation) throws Exception {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. 读取配置文件</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2. 加载所有插件</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3. 创建 agent</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 4. 启动插件</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PluginLifecycleManager lifecycleManager = new PluginLifecycleManager();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        lifecycleManager.startup(ShenyuAgentConfigUtils.getPluginConfigMap());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //添加hook函数用于关闭插件</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Runtime.getRuntime().addShutdownHook(new Thread(lifecycleManager::close));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>PluginLifecycleManager</p><p><code>PluginLifecycleManager</code>负责插件的生命周期管理，用于启动插件和关闭插件。</p><p>插件的启动，必须要在配置文件中指定。</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class PluginLifecycleManager {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   //......      </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 启动插件.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void startup(final Map&lt;String, AgentPluginConfig&gt; configMap) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //从配置文件中获取支持的插件名称</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Set&lt;String&gt; support = ShenyuAgentConfigUtils.getSupports();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        configMap.entrySet().stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(entry -&gt; support.contains(entry.getKey())) //包含在配置文件中</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .forEach(entry -&gt; Optional.ofNullable(SPILoader.load(AgentPluginBootService.class, entry.getKey())) //通过SPI加载插件启动类</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        .ifPresent(bootService -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                LOG.info(&quot;start shenyu plugin: {}&quot;, entry.getKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                bootService.start(entry.getValue());  // 启动插件：执行插件的具体启动逻辑</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            } catch (final Throwable ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                LOG.error(&quot;Failed to start shenyu plugin&quot;, ex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 关闭插件</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void close() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //通过SPI加载插件启动类</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SPILoader.loadList(AgentPluginBootService.class).forEach(each -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                each.close(); // 关闭插件：执行插件的具体关闭逻辑</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (final Throwable ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.error(&quot;Failed to close shenyu agent plugin&quot;, ex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>插件的启动和关闭也是有每个插件具体去实现的，然后通过<code>SPI</code>去加载。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="6-总结"></a>6. 总结<a class="hash-link" href="#6-总结" title="Direct link to heading">#</a></h3><ul><li><code>shenyu-agent</code>模块的实现主要是通过<code>Byte Buddy</code>工具包；</li><li>在配置文件<code>shenyu-agent.yaml</code>中，指定插件信息；</li><li>插件加载过程通过<code>SPI</code>完成；</li><li>拦截点通过配置文件指定，设计灵活；</li><li>插件接口定义和实现分开，支持多种插件类型。</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/agent">Agent</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div><div class="col text--right"><a aria-label="Read more about ShenYu-Agent 源码分析" href="/zh/blog/Agent-SourceCode-Analysis"><b>Read More</b></a></div></footer></article></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">ShenYu</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/zh/download">下载</a></li><li class="footer__item"><a class="footer__link-item" href="/zh/docs/index">文档</a></li><li class="footer__item"><a class="footer__link-item" href="/zh/news">新闻</a></li><li class="footer__item"><a class="footer__link-item" href="/zh/blog">博客</a></li><li class="footer__item"><a href="https://github.com/apache/incubator-shenyu/releases" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>版本<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">社区</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/zh/community/subscribe-email">社区</a></li><li class="footer__item"><a href="https://github.com/apache/incubator-shenyu" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/apache/incubator-shenyu/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Issue Tracker<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">订阅邮件组</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/zh/community/subscribe-email">如何订阅</a></li><li class="footer__item"><a href="mailto://dev-subscribe@shenyu.apache.org" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>订阅邮件<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://lists.apache.org/list.html?dev@shenyu.apache.org" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>邮件归档<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright"><div><img style="height:50px" alt="Apache Software Foundation" src="/img/incubator-logo.png"><p style="color:#ffffffcf;font-size:14px;text-align:left">Apache ShenYu is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.</p>
      <p style="color:white;font-size:14px;"> Copyright © 2021 The Apache Software Foundation. Licensed under the Apache License, Version 2.0. Apache ShenYu, Apache Incubator, Apache, the Apache feather logo, the Apache ShenYu logo and the Apache Incubator project logo are trademarks of The Apache Software Foundation.</p>
      <div></div></div></div></div></div></footer></div>
<script src="/zh/assets/js/runtime~main.a84baa92.js"></script>
<script src="/zh/assets/js/main.8bdf7661.js"></script>
</body>
</html>