<!doctype html><html><head><title>数据同步原理 · Apache ShenYu</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="The girl on the prairie"><meta name=generator content="Hugo 0.55.5"><link rel="shortcut icon" href=/img/favicon.png type=image/png><link href=https://unpkg.com/purecss@1.0.0/build/base-min.css rel=stylesheet><link href=/css/main.css rel=stylesheet><link href=/css/zoom-image.css rel=stylesheet><script src=/js/iconfont.js></script><script src=/js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script><script>window.SITE_LANGUAGE="zh"</script><script src=/js/app.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-187960192-2','auto');ga('send','pageview');}</script></head><body><header class=ss-header><nav class=navbar role=navigation aria-label="main navigation"><div class=navbar-brand><a class=logo-link style=font-size:25px;margin-right:50px href=/zh/><img class=logo src=/img/logo/apache-shenyu.png></a><div class=-show-mobile><a id=mobile-menu-icon><svg class="icon" aria-hidden="true"><use xlink:href="#icon-menu"/></svg></a><nav id=mobile-menu><div id=js-menu-search-mobile class=navbar-search-mobile><input class=input placeholder=请输入要搜索的关键词><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search"/></svg></div><a href=/zh/projects/shenyu/download/><span>下载</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/zh/projects/shenyu/overview/><span>文档</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/zh/community/subscribe-email/><span>社区</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/zh/news/><span>新闻</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/zh/awesome/><span>Awesome</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/projects/shenyu/data-sync/><span>English</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-transfer"/></svg></a></nav></div></div><div class="navbar-menu -hidden-mobile"><div class=navbar-start><a class=navbar-item href=/zh/projects/shenyu/download/>下载</a>
<a class=navbar-item href=/zh/projects/shenyu/overview/>文档</a>
<a class=navbar-item href=/zh/community/subscribe-email/>社区</a>
<a class=navbar-item href=/zh/news/>新闻</a>
<a class=navbar-item href=/zh/awesome/>Awesome</a>
<span class="navbar-item nav-hover"><a>Links</a><div class=dropdown-menu><a class=dropdown-item href=https://www.apache.org/>Apache Software Foundation</a>
<a class=dropdown-item href=https://github.com/apache/incubator-shenyu/issues>GitHub Issue Tracker</a>
<a class=dropdown-item href=https://www.apache.org/>License</a>
<a class=dropdown-item href=http://www.apache.org/events/current-event>Apache Events</a>
<a class=dropdown-item href=https://www.apache.org/licenses/>Security</a>
<a class=dropdown-item href=http://www.apache.org/foundation/sponsorship.html>Sponsor and Donate</a>
<a class=dropdown-item href=http://www.apache.org/foundation/thanks.html>Thanks</a></div></span></div><div class=navbar-end><div class=navbar-item><div id=js-menu-search class=navbar-search><input class=input placeholder=请输入要搜索的关键词><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search"/></svg></div></div><div class=navbar-item><a class=translation href=/projects/shenyu/data-sync/>En</a></div></div></div></nav></header><div class=ss-layout-container><aside class="ss-layout-aside -left ss-card -soft-hidden"><div id=js-drawer class=ss-toc><div id=js-drawer-handle class=drawer-handle><svg class="icon icon-menu" aria-hidden="true"><use xlink:href="#icon-menu"/></svg><svg class="icon icon-close" aria-hidden="true"><use xlink:href="#icon-close"/></svg></div><div class=drawer-body><div class=header title="Apache ShenYu是一个异步的，高性能的，跨语言的，响应式的API网关。">Apache ShenYu(current)<div class="ss-toc-list-card -hidden-mobile"><svg class="icon -hidden-mobile" aria-hidden="true"><use xlink:href="#icon-menu1"/></svg><div class=ss-tooltip><div class=toc-list><h4 class=title>主要项目</h4><ul class=list><li class=item><a href=/zh/projects/shenyu/overview>Apache ShenYu(current)</a></li><li class=item><a href=/zh/projects/shenyu-2.3.0/overview>Apache ShenYu(2.3.0)</a></li></ul></div></div></div></div><div class=body><ul class=leaf-section><li class=item><div class=link><a title=介绍 href=/zh/projects/shenyu/overview>介绍</a></div></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title=设计文档>设计文档</a></div><ul class=leaf-section><li class=item><div class=link><a title=Admin数据结构 href=/zh/projects/shenyu/database-design>Admin数据结构</a></div></li><li class=item><div class="link -current"><a title=数据同步原理 href=/zh/projects/shenyu/data-sync>数据同步原理</a></div></li><li class=item><div class=link><a title=客户端接入原理 href=/zh/projects/shenyu/register-center-design>客户端接入原理</a></div></li><li class=item><div class=link><a title=流量控制 href=/zh/projects/shenyu/flow-control>流量控制</a></div></li><li class=item><div class=link><a title=SPI扩展设计 href=/zh/projects/shenyu/spi-design>SPI扩展设计</a></div></li></ul></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title=运维部署>运维部署</a></div><ul class=leaf-section><li class=item><div class=link><a title=本地部署 href=/zh/projects/shenyu/deployment-local>本地部署</a></div></li><li class=item><div class=link><a title=二进制包部署 href=/zh/projects/shenyu/deployment-package>二进制包部署</a></div></li><li class=item><div class=link><a title=Docker部署 href=/zh/projects/shenyu/deployment-docker>Docker部署</a></div></li><li class=item><div class=link><a title=Kubernetes部署 href=/zh/projects/shenyu/deployment-k8s>Kubernetes部署</a></div></li><li class=item><div class=link><a title=Helm部署 href=/zh/projects/shenyu/deployment-helm>Helm部署</a></div></li><li class=item><div class=link><a title=自定义部署 href=/zh/projects/shenyu/deployment-custom>自定义部署</a></div></li></ul></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title=快速开始>快速开始</a></div><ul class=leaf-section><li class=item><div class=link><a title=Http代理 href=/zh/projects/shenyu/quick-start-http>Http代理</a></div></li><li class=item><div class=link><a title=Dubbo代理 href=/zh/projects/shenyu/quick-start-dubbo>Dubbo代理</a></div></li><li class=item><div class=link><a title="Spring Cloud代理" href=/zh/projects/shenyu/quick-start-springcloud>Spring Cloud代理</a></div></li><li class=item><div class=link><a title=Sofa代理 href=/zh/projects/shenyu/quick-start-sofa>Sofa代理</a></div></li><li class=item><div class=link><a title=gRPC代理 href=/zh/projects/shenyu/quick-start-grpc>gRPC代理</a></div></li><li class=item><div class=link><a title=Tars代理 href=/zh/projects/shenyu/quick-start-tars>Tars代理</a></div></li><li class=item><div class=link><a title=Motan代理 href=/zh/projects/shenyu/quick-start-motan>Motan代理</a></div></li></ul></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title=用户文档>用户文档</a></div><ul class=leaf-section><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title=admin使用>admin使用</a></div><ul class=leaf-section><li class=item><div class=link><a title=插件管理 href=/zh/projects/shenyu/plugin-handle-explanation>插件管理</a></div></li><li class=item><div class=link><a title=选择器和规则管理 href=/zh/projects/shenyu/selector-and-rule>选择器和规则管理</a></div></li><li class=item><div class=link><a title=字典管理 href=/zh/projects/shenyu/dictionary-management>字典管理</a></div></li><li class=item><div class=link><a title=权限管理 href=/zh/projects/shenyu/authority-management>权限管理</a></div></li></ul></li><li class=item><div class=link><a title=数据同步配置 href=/zh/projects/shenyu/use-data-sync>数据同步配置</a></div></li><li class=item><div class=link><a title=客户端接入配置 href=/zh/projects/shenyu/register-center-access>客户端接入配置</a></div></li><li class=item><div class=link><a title=Http服务接入 href=/zh/projects/shenyu/http-proxy>Http服务接入</a></div></li><li class=item><div class=link><a title=Dubbo服务接入 href=/zh/projects/shenyu/dubbo-proxy>Dubbo服务接入</a></div></li><li class=item><div class=link><a title="Spring Cloud服务接入" href=/zh/projects/shenyu/spring-cloud-proxy>Spring Cloud服务接入</a></div></li><li class=item><div class=link><a title=Sofa服务接入 href=/zh/projects/shenyu/sofa-rpc-proxy>Sofa服务接入</a></div></li><li class=item><div class=link><a title=gRPC服务接入 href=/zh/projects/shenyu/grpc-proxy>gRPC服务接入</a></div></li><li class=item><div class=link><a title=Tars服务接入 href=/zh/projects/shenyu/tars-proxy>Tars服务接入</a></div></li><li class=item><div class=link><a title=Motan服务接入 href=/zh/projects/shenyu/motan-proxy>Motan服务接入</a></div></li></ul></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title=插件集合>插件集合</a></div><ul class=leaf-section><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title="Http 处理">Http 处理</a></div><ul class=leaf-section><li class=item><div class=link><a title=Rewrite插件 href=/zh/projects/shenyu/rewrite-plugin>Rewrite插件</a></div></li><li class=item><div class=link><a title=Redirect插件 href=/zh/projects/shenyu/redirect-plugin>Redirect插件</a></div></li><li class=item><div class=link><a title=Request插件 href=/zh/projects/shenyu/request-plugin>Request插件</a></div></li><li class=item><div class=link><a title=Context-path插件 href=/zh/projects/shenyu/context-path-plugin>Context-path插件</a></div></li><li class=item><div class=link><a title=Param-mapping插件 href=/zh/projects/shenyu/param-mapping-plugin>Param-mapping插件</a></div></li><li class=item><div class=link><a title=ModifyResponse插件 href=/zh/projects/shenyu/modify-response-plugin>ModifyResponse插件</a></div></li></ul></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title="RPC 代理">RPC 代理</a></div><ul class=leaf-section><li class=item><div class=link><a title=Divide插件 href=/zh/projects/shenyu/divide-plugin>Divide插件</a></div></li><li class=item><div class=link><a title=Dubbo插件 href=/zh/projects/shenyu/dubbo-plugin>Dubbo插件</a></div></li><li class=item><div class=link><a title="Spring Cloud插件" href=/zh/projects/shenyu/spring-cloud-plugin>Spring Cloud插件</a></div></li><li class=item><div class=link><a title=Sofa插件 href=/zh/projects/shenyu/sofa-plugin>Sofa插件</a></div></li><li class=item><div class=link><a title=gRPC插件 href=/zh/projects/shenyu/grpc-plugin>gRPC插件</a></div></li><li class=item><div class=link><a title=Tars插件 href=/zh/projects/shenyu/tars-plugin>Tars插件</a></div></li><li class=item><div class=link><a title=Motan插件 href=/zh/projects/shenyu/motan-plugin>Motan插件</a></div></li></ul></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title=熔断和限流>熔断和限流</a></div><ul class=leaf-section><li class=item><div class=link><a title=Hystrix插件 href=/zh/projects/shenyu/hystrix-plugin>Hystrix插件</a></div></li><li class=item><div class=link><a title=Sentinel插件 href=/zh/projects/shenyu/sentinel-plugin>Sentinel插件</a></div></li><li class=item><div class=link><a title=Resilience4j插件 href=/zh/projects/shenyu/resilience4j-plugin>Resilience4j插件</a></div></li><li class=item><div class=link><a title=RateLimiter插件 href=/zh/projects/shenyu/rate-limiter-plugin>RateLimiter插件</a></div></li></ul></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title=权限认证>权限认证</a></div><ul class=leaf-section><li class=item><div class=link><a title=Waf插件 href=/zh/projects/shenyu/waf-plugin>Waf插件</a></div></li><li class=item><div class=link><a title=Sign插件 href=/zh/projects/shenyu/sign-plugin>Sign插件</a></div></li><li class=item><div class=link><a title=JWT插件 href=/zh/projects/shenyu/jwt-plugin>JWT插件</a></div></li><li class=item><div class=link><a title="OAuth 2插件" href=/zh/projects/shenyu/oauth2-plugin>OAuth 2插件</a></div></li></ul></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title=可观测性>可观测性</a></div><ul class=leaf-section><li class=item><div class=link><a title=Monitor插件 href=/zh/projects/shenyu/monitor-plugin>Monitor插件</a></div></li><li class=item><div class=link><a title=Logging插件 href=/zh/projects/shenyu/logging-plugin>Logging插件</a></div></li></ul></li></ul></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title=开发者文档>开发者文档</a></div><ul class=leaf-section><li class=item><div class=link><a title=自定义Filter href=/zh/projects/shenyu/custom-filter>自定义Filter</a></div></li><li class=item><div class=link><a title=自定义插件 href=/zh/projects/shenyu/custom-plugin>自定义插件</a></div></li><li class=item><div class=link><a title=文件上传下载 href=/zh/projects/shenyu/file-and-image>文件上传下载</a></div></li><li class=item><div class=link><a title=自定义解析IP与Host href=/zh/projects/shenyu/custom-parsing-ip-and-host>自定义解析IP与Host</a></div></li><li class=item><div class=link><a title=自定义返回结果 href=/zh/projects/shenyu/custom-result>自定义返回结果</a></div></li><li class=item><div class=link><a title=自定义签名插件算法与验证 href=/zh/projects/shenyu/custom-sign-algorithm>自定义签名插件算法与验证</a></div></li><li class=item><div class=link><a title=自定义匹配条件策略 href=/zh/projects/shenyu/custom-condition-match>自定义匹配条件策略</a></div></li><li class=item><div class=link><a title=多语言Http客户端接入 href=/zh/projects/shenyu/developer-shenyu-client>多语言Http客户端接入</a></div></li><li class=item><div class=link><a title=线程模型 href=/zh/projects/shenyu/thread>线程模型</a></div></li><li class=item><div class=link><a title=ShenYu调优 href=/zh/projects/shenyu/shenyu-optimize>ShenYu调优</a></div></li></ul></li><li class=item><div class=link><a title=版本发布 href=/zh/projects/shenyu/release-notes>版本发布</a></div></li><li class=item><div class=link><a title=文档下载 href=/zh/projects/shenyu/download>文档下载</a></div></li></ul></div></div></div></aside><main class="ss-layout-main -card"><div class=ss-meta><div class=container><h1 class=title>数据同步原理</h1><a class="edit-button -hidden-mobile" href=https://github.com/apache/incubator-shenyu-website/edit/main/content/zh/projects/shenyu/data-sync/index.md>编辑</a></div><div class=meta>更新时间: 2021-08-01</div></div><article class=typo><p>本篇主要讲解数据同步原理，数据同步是指在 <code>shenyu-admin</code> 后台操作数据以后，使用何种策略将数据同步到 <code>Apache ShenYu</code> 网关。<code>Apache ShenYu</code> 网关当前支持<code>ZooKeeper</code>、<code>WebSocket</code>、<code>Http长轮询</code>、<code>Nacos</code> 、<code>Etcd</code> 和 <code>Consul</code> 进行数据同步。</p><p><img src=/img/shenyu/dataSync/data-sync-1.png width=60% height=50%></p><p>数据同步的相关配置请参考用户文档中的 <a href=../use-data-sync>数据同步配置</a> 。</p><h3 id=背景>背景</h3><p>网关是流量请求的入口，在微服务架构中承担了非常重要的角色，网关高可用的重要性不言而喻。在使用网关的过程中，为了满足业务诉求，经常需要变更配置，比如流控规则、路由规则等等。因此，网关动态配置是保障网关高可用的重要因素。</p><p>在实际使用 <code>Apache ShenYu</code> 网关过程中，用户也反馈了一些问题：</p><ul><li>依赖 <code>Zookeeper</code>，怎么使用 <code>Etcd</code>、<code>Consul</code>、<code>Nacos</code>等其他注册中心？</li><li>依赖 <code>Redis</code>、<code>influxdb</code>，没有使用限流插件、监控插件，为什么需要这些？</li><li>配置同步为什么不使用配置中心？</li><li>为什么不能动态配置更新？</li><li>每次都要查询数据库，使用<code>Redis</code>不就行了吗？</li></ul><p>根据用户的反馈信息，我们对 <code>Apache ShenYu</code> 也进行了部分的重构，当前数据同步特性如下：</p><ul><li>所有的配置都缓存在 <code>Apache ShenYu</code> 网关内存中，每次请求都使用本地缓存，速度非常快。</li><li>用户可以在 <code>shenyu-admin</code> 后台任意修改数据，并马上同步到网关内存。</li><li>支持 <code>Apache ShenYu</code> 的插件、选择器、规则数据、元数据、签名数据等数据同步。</li><li>所有插件的选择器，规则都是动态配置，立即生效，不需要重启服务。</li><li>数据同步方式支持 <code>Zookeeper</code>、<code>Http 长轮询</code>、<code>Websocket</code>、<code>Nacos</code>、<code>Etcd</code> 和 <code>Consul</code>。</li></ul><h3 id=原理分析>原理分析</h3><p>下图展示了 <code>Apache ShenYu</code> 数据同步的流程，<code>Apache ShenYu</code> 网关在启动时，会从配置服务同步配置数据，并且支持推拉模式获取配置变更信息，然后更新本地缓存。管理员可以在管理后台（<code>shenyu-admin</code>），变更用户权限、规则、插件、流量配置，通过推拉模式将变更信息同步给 <code>Apache ShenYu</code> 网关，具体是 <code>push</code> 模式，还是 <code>pull</code> 模式取决于使用哪种同步方式。</p><p><img src=/img/shenyu/dataSync/plugin-data.png alt></p><p>在最初的版本中，配置服务依赖 <code>Zookeeper</code> 实现，管理后台将变更信息 <code>push</code> 给网关。而现在可以支持 <code>WebSocket</code>、<code>Http长轮询</code>、<code>Zookeeper</code>、<code>Nacos</code>、<code>Etcd</code> 和 <code>Consul</code>，通过在配置文件中设置 <code>shenyu.sync.${strategy}</code> 指定对应的同步策略，默认使用 <code>webosocket</code> 同步策略，可以做到秒级数据同步。但是，有一点需要注意的是，<code>Apache ShenYu</code>网关 和 <code>shenyu-admin</code> 必须使用相同的同步策略。</p><p>如下图所示，<code>shenyu-admin</code> 在用户发生配置变更之后，会通过 <code>EventPublisher</code> 发出配置变更通知，由 <code>EventDispatcher</code> 处理该变更通知，然后根据配置的同步策略(<code>http、weboscket、zookeeper、naocs、etcd、consul</code>)，将配置发送给对应的事件处理器。</p><ul><li>如果是 <code>websocket</code> 同步策略，则将变更后的数据主动推送给 <code>shenyu-web</code>，并且在网关层，会有对应的 <code>WebsocketCacheHandler</code> 处理器来处理 <code>shenyu-admin</code> 的数据推送。</li><li>如果是 <code>zookeeper</code> 同步策略，将变更数据更新到 <code>zookeeper</code>，而 <code>ZookeeperSyncCache</code> 会监听到 <code>zookeeper</code> 的数据变更，并予以处理。</li><li>如果是 <code>http</code> 同步策略，由网关主动发起长轮询请求，默认有 <code>90s</code> 超时时间，如果 <code>shenyu-admin</code> 没有数据变更，则会阻塞 <code>http</code> 请求，如果有数据发生变更则响应变更的数据信息，如果超过 <code>60s</code> 仍然没有数据变更则响应空数据，网关层接到响应后，继续发起 <code>http</code> 请求，反复同样的请求。</li></ul><p><img src=/img/shenyu/dataSync/config-strategy-processor-zh.png width=90% height=80%></p><h3 id=zookeeper同步原理>Zookeeper同步原理</h3><p>基于 <code>zookeeper</code> 的同步原理很简单，主要是依赖 <code>zookeeper</code> 的 <code>watch</code> 机制。<code>Apache ShenYu</code>网关会监听配置的节点，<code>shenyu-admin</code> 在启动的时候，会将数据全量写入 <code>zookeeper</code>，后续数据发生变更时，会增量更新 <code>zookeeper</code> 的节点，与此同时，<code>Apache ShenYu</code>网关会监听配置信息的节点，一旦有信息变更时，会更新本地缓存。</p><p><img src=https://yu199195.github.io/images/soul/soul-zookeeper.png alt=zookeeper节点设计></p><p><code>Apache ShenYu</code> 将配置信息写到<code>zookeeper</code>节点，是通过精心设计的，如果您想深入了解代码实现，请参考源码 <code>ZookeeperSyncDataService</code>。</p><h3 id=websocket同步原理>WebSocket同步原理</h3><p><code>websocket</code> 和 <code>zookeeper</code> 机制有点类似，将网关与 <code>shenyu-admin</code> 建立好 <code>websocket</code> 连接时，<code>shenyu-admin</code> 会推送一次全量数据，后续如果配置数据发生变更，则以增量形式将变更数据通过 <code>websocket</code> 主动推送给 <code>Apache ShenYu</code>网关。</p><p>使用 <code>websocket</code> 同步的时候，特别要注意断线重连，也就是要保持心跳。<code>Apache ShenYu</code>使用<code>java-websocket</code> 这个第三方库来进行<code>websocket</code>连接。
如果您想深入了解代码实现，请参考源码 <code>WebsocketSyncDataService</code>。</p><h3 id=http长轮询同步原理>Http长轮询同步原理</h3><p><code>Zookeeper</code>和<code>WebSocket</code> 数据同步的机制比较简单，而 <code>Http长轮询</code>则比较复杂。 <code>Apache ShenYu</code> 借鉴了 <code>Apollo</code>、<code>Nacos</code> 的设计思想，取其精华，自己实现了 <code>Http长轮询</code>数据同步功能。注意，这里并非传统的 <code>ajax</code> 长轮询！</p><p><img src=/img/shenyu/dataSync/http-long-polling-zh.png width=90% height=80%></p><p><code>Http长轮询</code> 机制如上所示，<code>Apache ShenYu</code>网关主动请求 <code>shenyu-admin</code> 的配置服务，读取超时时间为 <code>90s</code>，意味着网关层请求配置服务最多会等待 <code>90s</code>，这样便于 <code>shenyu-admin</code> 配置服务及时响应变更数据，从而实现准实时推送。</p><p><code>http</code> 请求到达 <code>shenyu-admin</code> 之后，并非立马响应数据，而是利用 <code>Servlet3.0</code> 的异步机制，异步响应数据。首先，将长轮询请求任务 <code>LongPollingClient</code> 扔到 <code>BlockingQueue</code> 中，并且开启调度任务，<code>60s</code> 后执行，这样做的目的是 <code>60s</code> 后将该长轮询请求移除队列。因为即便是没有配置变更，也需要让网关知道，不能一直等待。而且网关请求配置服务时，也有 <code>90s</code> 的超时时间。</p><p>如果这段时间内，管理员在 <code>shenyu-admin</code> 变更了配置数据，此时，会挨个移除队列中的长轮询请求，并响应数据，告知是哪个 <code>Group</code> 的数据发生了变更（我们将插件、规则、流量配置、用户配置数据分成不同的组）。网关收到响应信息之后，只知道是哪个 <code>Group</code> 发生了配置变更，还需要再次请求该 <code>Group</code> 的配置数据。这里可能会存在一个疑问：为什么不是直接将变更的数据写出？我们在开发的时候，也深入讨论过该问题，因为 <code>http 长轮询</code> 机制只能保证准实时，如果在网关层处理不及时，或者管理员频繁更新配置，很有可能便错过了某个配置变更的推送，安全起见，我们只告知某个 <code>Group</code> 信息发生了变更。</p><p>当 <code>shenyu-web</code> 网关层接收到 <code>http</code> 响应信息之后，拉取变更信息（如果有变更的话），然后再次请求 <code>shenyu-admin</code> 的配置服务，如此反复循环。
如果您想深入了解代码实现，请参考源码 <code>HttpSyncDataService</code>。</p><h3 id=nacos同步原理>Nacos同步原理</h3><p><code>Nacos</code>的同步原理与Zookeeper基本类似，主要依赖于<code>Nacos</code>的<code>配置管理</code>,各个配置节点的路径与Zookeeper类似。</p><p><code>Apache ShenYu</code>网关会监听配置的节点，启动时，如果<code>Nacos</code>中不存在配置节点，将同步全量的数据写入<code>Nacos</code>中，后序数据发送变更时，全量更新<code>Nacos</code>中的配置节点，与此同时，<code>Apache ShenYu</code>网关会监听配置信息的节点，一旦有信息变更时，会更新本地缓存。</p><p>如果您想深入了解代码实现，请参考源码 <code>NacosSyncDataService</code>和<code>Nacos</code>的<a href=https://nacos.io/zh-cn/docs/sdk.html>官方文档</a>。</p><h3 id=etcd同步原理>Etcd同步原理</h3><p><code>Etcd</code> 数据同步原理与Zookeeper类似，主要依赖于<code>Etcd</code>的<code>watch</code>机制，各个配置节点路径与<code>Zookeeper</code>相同。</p><p><code>Etcd</code>的原生API使用稍有点复杂，所有对其进行了一定的封装。</p><p><code>Apache ShenYu</code>网关会监听配置的节点，启动时，如果<code>Etcd</code>中不存在配置节点，将同步全量的数据写入<code>Etcd</code>中，后序数据发送变更时，增量更新<code>Etcd</code>中的配置节点，与此同时，<code>Apache ShenYu</code>网关会监听配置信息的节点，一旦有信息变更时，会更新本地缓存。</p><p>如果您想深入了解代码实现，请参考源码 <code>EtcdSyncDataService</code>。</p><h3 id=consul同步原理>Consul同步原理</h3><p><code>Consul</code> 数据同步原理是网关定时轮询 <code>Consul</code> 的配置中心，获取配置版本号与本地进行比对。</p><p><code>Apache ShenYu</code>网关会定时轮询配置的节点，默认间隔时间为1s。启动时，如果 <code>Consul</code> 中不存在配置节点，将同步全量的数据写入<code>Consul</code>中，后续数据发送变更时，增量更新 <code>Consul</code> 中的配置节点，与此同时，<code>Apache ShenYu</code>网关会定时轮询配置信息的节点，拉取配置版本号与本地进行比对，若发现版本号变更时，会更新本地缓存。</p><p>如果您想深入了解代码实现，请参考源码 <code>ConsulSyncDataService</code>。</p></article></main></div><footer class=ss-footer><div class=container><div class=links><div class="cate  -show-mobile"><h2 class=cate-title>Apache</h2><a class=link href=https://www.apache.org/>Foundation</a>
<a class=link href=https://github.com/apache/incubator-shenyu/issues>GitHub Issue Tracker</a>
<a class=link href=https://www.apache.org/licenses/>License</a>
<a class=link href=https://www.apache.org/security/>Security</a>
<a class=link href=http://www.apache.org/events/current-event>Events</a>
<a class=link href=http://www.apache.org/foundation/sponsorship.html>Sponsorship</a>
<a class=link href=http://www.apache.org/foundation/thanks.html>Thanks</a></div><div class=cate><h2 class=cate-title>资源</h2><a class=link href=https://github.com/apache/incubator-shenyu>Github</a>
<a class=link href=/zh/projects/shenyu/overview/>文档</a></div><div class=cate><h2 class=cate-title>参与进来</h2><a class=link href=https://github.com/apache/incubator-shenyu/issues/new>反馈</a>
<a class=link href=/zh/community>社区</a>
<a class=link href=/zh/news>新闻</a></div><div class=cate><h2 class=cate-title>订阅邮件组</h2><a class=link href=/zh/community/subscribe-email/>如何订阅</a>
<a class=link href=mailto://dev-subscribe@shenyu.apache.org>订阅邮件</a>
<a class=link href=https://lists.apache.org/list.html?dev@shenyu.apache.org>邮件归档</a></div></div><div class=qrcode><div><img class=qrcode-img src=/img/qrcode/WechatIMG127.jpeg><p class=qrcode-desc>微信公众号</p></div></div></div><div class=copyright><p>Copyright © 2021 The Apache Software Foundation. Licensed under the Apache License, Version 2.0.
Apache ShenYu, Apache Incubator, Apache, the Apache feather logo, the Apache ShenYu logo and the Apache Incubator project logo are trademarks of The Apache Software Foundation.
Apache ShenYu is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator.
Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects.
While incubation status is not necessarily a reflection of the completeness or stability of the code,
it does indicate that the project has yet to be fully endorsed by the ASF.</p></div></footer></body></html>