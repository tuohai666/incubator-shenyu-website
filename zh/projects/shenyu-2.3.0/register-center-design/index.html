<!doctype html><html><head><title>注册中心设计 · Apache ShenYu</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="The girl on the prairie"><meta name=generator content="Hugo 0.55.5"><link rel="shortcut icon" href=/img/favicon.png type=image/png><link href=https://unpkg.com/purecss@1.0.0/build/base-min.css rel=stylesheet><link href=/css/main.css rel=stylesheet><link href=/css/zoom-image.css rel=stylesheet><script src=/js/iconfont.js></script><script src=/js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script><script>window.SITE_LANGUAGE="zh"</script><script src=/js/app.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-187960192-2','auto');ga('send','pageview');}</script></head><body><header class=ss-header><nav class=navbar role=navigation aria-label="main navigation"><div class=navbar-brand><a class=logo-link style=font-size:25px;margin-right:50px href=/zh/><img class=logo src=/img/logo/apache-shenyu.png></a><div class=-show-mobile><a id=mobile-menu-icon><svg class="icon" aria-hidden="true"><use xlink:href="#icon-menu"/></svg></a><nav id=mobile-menu><div id=js-menu-search-mobile class=navbar-search-mobile><input class=input placeholder=请输入要搜索的关键词><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search"/></svg></div><a href=/zh/projects/shenyu/download/><span>下载</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/zh/projects/shenyu/overview/><span>文档</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/zh/community/subscribe-email/><span>社区</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/zh/news/><span>新闻</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/zh/awesome/><span>Awesome</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/projects/shenyu-2.3.0/register-center-design/><span>English</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-transfer"/></svg></a></nav></div></div><div class="navbar-menu -hidden-mobile"><div class=navbar-start><a class=navbar-item href=/zh/projects/shenyu/download/>下载</a>
<a class=navbar-item href=/zh/projects/shenyu/overview/>文档</a>
<a class=navbar-item href=/zh/community/subscribe-email/>社区</a>
<a class=navbar-item href=/zh/news/>新闻</a>
<a class=navbar-item href=/zh/awesome/>Awesome</a>
<span class="navbar-item nav-hover"><a>Links</a><div class=dropdown-menu><a class=dropdown-item href=https://www.apache.org/>Apache Software Foundation</a>
<a class=dropdown-item href=https://github.com/apache/incubator-shenyu/issues>GitHub Issue Tracker</a>
<a class=dropdown-item href=https://www.apache.org/>License</a>
<a class=dropdown-item href=http://www.apache.org/events/current-event>Apache Events</a>
<a class=dropdown-item href=https://www.apache.org/licenses/>Security</a>
<a class=dropdown-item href=http://www.apache.org/foundation/sponsorship.html>Sponsor and Donate</a>
<a class=dropdown-item href=http://www.apache.org/foundation/thanks.html>Thanks</a></div></span></div><div class=navbar-end><div class=navbar-item><div id=js-menu-search class=navbar-search><input class=input placeholder=请输入要搜索的关键词><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search"/></svg></div></div><div class=navbar-item><a class=translation href=/projects/shenyu-2.3.0/register-center-design/>En</a></div></div></div></nav></header><div class=ss-layout-container><aside class="ss-layout-aside -left ss-card -soft-hidden"><div id=js-drawer class=ss-toc><div id=js-drawer-handle class=drawer-handle><svg class="icon icon-menu" aria-hidden="true"><use xlink:href="#icon-menu"/></svg><svg class="icon icon-close" aria-hidden="true"><use xlink:href="#icon-close"/></svg></div><div class=drawer-body><div class=header title=异步的，高性能的，跨语言的，响应式的API网关。>Apache ShenYu(2.3.0)<div class="ss-toc-list-card -hidden-mobile"><svg class="icon -hidden-mobile" aria-hidden="true"><use xlink:href="#icon-menu1"/></svg><div class=ss-tooltip><div class=toc-list><h4 class=title>主要项目</h4><ul class=list><li class=item><a href=/zh/projects/shenyu/overview>Apache ShenYu(current)</a></li><li class=item><a href=/zh/projects/shenyu-2.3.0/overview>Apache ShenYu(2.3.0)</a></li></ul></div></div></div></div><div class=body><ul class=leaf-section><li class=item><div class=link><a title="Soul 介绍" href=/zh/projects/shenyu-2.3.0/overview>Soul 介绍</a></div></li><li class=item><div class=link><a title=团队介绍 href=/zh/projects/shenyu-2.3.0/team>团队介绍</a></div></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title=设计文档>设计文档</a></div><ul class=leaf-section><li class=item><div class=link><a title=数据库设计 href=/zh/projects/shenyu-2.3.0/database-design>数据库设计</a></div></li><li class=item><div class=link><a title=配置流程设计 href=/zh/projects/shenyu-2.3.0/config>配置流程设计</a></div></li><li class=item><div class=link><a title=数据同步原理设计 href=/zh/projects/shenyu-2.3.0/data-sync>数据同步原理设计</a></div></li><li class=item><div class=link><a title=元数据设计 href=/zh/projects/shenyu-2.3.0/meta-data>元数据设计</a></div></li></ul></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title=Admin使用文档>Admin使用文档</a></div><ul class=leaf-section><li class=item><div class=link><a title=字典配置 href=/zh/projects/shenyu-2.3.0/dictionary-management>字典配置</a></div></li><li class=item><div class=link><a title=插件配置模板 href=/zh/projects/shenyu-2.3.0/plugin-handle-explanation>插件配置模板</a></div></li><li class=item><div class=link><a title=选择器规则详解 href=/zh/projects/shenyu-2.3.0/selector-and-rule>选择器规则详解</a></div></li></ul></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title=用户文档>用户文档</a></div><ul class=leaf-section><li class=item><div class=link><a title=搭建Soul网关环境 href=/zh/projects/shenyu-2.3.0/soul-set-up>搭建Soul网关环境</a></div></li><li class=item><div class=link><a title=Http代理 href=/zh/projects/shenyu-2.3.0/http-proxy>Http代理</a></div></li><li class=item><div class=link><a title=Dubbo代理 href=/zh/projects/shenyu-2.3.0/dubbo-proxy>Dubbo代理</a></div></li><li class=item><div class=link><a title=SpringCloud代理 href=/zh/projects/shenyu-2.3.0/spring-cloud-proxy>SpringCloud代理</a></div></li><li class=item><div class=link><a title=Sofa代理 href=/zh/projects/shenyu-2.3.0/sofa-rpc-proxy>Sofa代理</a></div></li><li class=item><div class=link><a title=数据同步策略 href=/zh/projects/shenyu-2.3.0/use-data-sync>数据同步策略</a></div></li></ul></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title=注册中心>注册中心</a></div><ul class=leaf-section><li class=item><div class="link -current"><a title=设计 href=/zh/projects/shenyu-2.3.0/register-center-design>设计</a></div></li><li class=item><div class=link><a title=接入 href=/zh/projects/shenyu-2.3.0/register-center-access>接入</a></div></li></ul></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title=快速开始>快速开始</a></div><ul class=leaf-section><li class=item><div class=link><a title=Dubbo href=/zh/projects/shenyu-2.3.0/quick-start-dubbo>Dubbo</a></div></li><li class=item><div class=link><a title=Http href=/zh/projects/shenyu-2.3.0/quick-start-http>Http</a></div></li><li class=item><div class=link><a title=Grpc href=/zh/projects/shenyu-2.3.0/quick-start-grpc>Grpc</a></div></li><li class=item><div class=link><a title=SpringCloud href=/zh/projects/shenyu-2.3.0/quick-start-springcloud>SpringCloud</a></div></li><li class=item><div class=link><a title=Sofa href=/zh/projects/shenyu-2.3.0/quick-start-sofa>Sofa</a></div></li><li class=item><div class=link><a title=Tars href=/zh/projects/shenyu-2.3.0/quick-start-tars>Tars</a></div></li></ul></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title=插件集合>插件集合</a></div><ul class=leaf-section><li class=item><div class=link><a title=Divide插件 href=/zh/projects/shenyu-2.3.0/divide-plugin>Divide插件</a></div></li><li class=item><div class=link><a title=Dubbo插件 href=/zh/projects/shenyu-2.3.0/dubbo-plugin>Dubbo插件</a></div></li><li class=item><div class=link><a title="Spring Cloud插件" href=/zh/projects/shenyu-2.3.0/spring-cloud-plugin>Spring Cloud插件</a></div></li><li class=item><div class=link><a title=Sofa插件 href=/zh/projects/shenyu-2.3.0/sofa-plugin>Sofa插件</a></div></li><li class=item><div class=link><a title=RateLimiter插件 href=/zh/projects/shenyu-2.3.0/rate-limiter-plugin>RateLimiter插件</a></div></li><li class=item><div class=link><a title=Hystrix插件 href=/zh/projects/shenyu-2.3.0/hystrix-plugin>Hystrix插件</a></div></li><li class=item><div class=link><a title=Sentinel插件 href=/zh/projects/shenyu-2.3.0/sentinel-plugin>Sentinel插件</a></div></li><li class=item><div class=link><a title=Resilience4j插件 href=/zh/projects/shenyu-2.3.0/resilience4j-plugin>Resilience4j插件</a></div></li><li class=item><div class=link><a title=Monitor插件 href=/zh/projects/shenyu-2.3.0/monitor-plugin>Monitor插件</a></div></li><li class=item><div class=link><a title=Waf插件 href=/zh/projects/shenyu-2.3.0/waf-plugin>Waf插件</a></div></li><li class=item><div class=link><a title=Sign插件 href=/zh/projects/shenyu-2.3.0/sign-plugin>Sign插件</a></div></li><li class=item><div class=link><a title=Rewriter插件 href=/zh/projects/shenyu-2.3.0/rewrite-plugin>Rewriter插件</a></div></li><li class=item><div class=link><a title=Websocket支持 href=/zh/projects/shenyu-2.3.0/websocket-plugin>Websocket支持</a></div></li><li class=item><div class=link><a title=Context-path插件 href=/zh/projects/shenyu-2.3.0/context-path-plugin>Context-path插件</a></div></li><li class=item><div class=link><a title=Redirect插件 href=/zh/projects/shenyu-2.3.0/redirect-plugin>Redirect插件</a></div></li><li class=item><div class=link><a title=Logging插件 href=/zh/projects/shenyu-2.3.0/logging-plugin>Logging插件</a></div></li></ul></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title=开发者文档>开发者文档</a></div><ul class=leaf-section><li class=item><div class=link><a title=自定义filter href=/zh/projects/shenyu-2.3.0/custom-filter>自定义filter</a></div></li><li class=item><div class=link><a title=自定义插件 href=/zh/projects/shenyu-2.3.0/custom-plugin>自定义插件</a></div></li><li class=item><div class=link><a title=文件上传下载 href=/zh/projects/shenyu-2.3.0/file-and-image>文件上传下载</a></div></li><li class=item><div class=link><a title=自定义解析IP与host href=/zh/projects/shenyu-2.3.0/custom-parsing-ip-and-host>自定义解析IP与host</a></div></li><li class=item><div class=link><a title=自定义返回结果 href=/zh/projects/shenyu-2.3.0/custom-result>自定义返回结果</a></div></li><li class=item><div class=link><a title=自定义签名插件算法与验证 href=/zh/projects/shenyu-2.3.0/custom-sign-algorithm>自定义签名插件算法与验证</a></div></li><li class=item><div class=link><a title=多语言http客户端接入 href=/zh/projects/shenyu-2.3.0/developer-soul-client>多语言http客户端接入</a></div></li><li class=item><div class=link><a title=线程模型 href=/zh/projects/shenyu-2.3.0/thread>线程模型</a></div></li><li class=item><div class=link><a title=soul调优 href=/zh/projects/shenyu-2.3.0/soul-optimize>soul调优</a></div></li></ul></li><li class=item><div class=link><a title=文档下载 href=/zh/projects/shenyu-2.3.0/download>文档下载</a></div></li></ul></div></div></div></aside><main class="ss-layout-main -card"><div class=ss-meta><div class=container><h1 class=title>注册中心设计</h1><a class="edit-button -hidden-mobile" href=https://github.com/apache/incubator-shenyu-website/edit/main/content/zh/projects/shenyu-2.3.0/register-center-design/index.md>编辑</a></div><div class=meta>更新时间: 2021-08-03</div></div><article class=typo><h2 id=说明>说明</h2><ul><li>本篇主要讲解注册中心原理</li></ul><h2 id=client>Client</h2><p><img src=/img/soul/register/client.png alt></p><p>配置中声明使用的注册中心客户端类型，如HTTP/Zookeeper</p><p>应用程序启动时使用SPI方式加载并初始化对应注册中心客户端</p><p>通过实现Spring Bean相关的后处理器接口，在其中获取需要进行注册的服务接口信息，将获取的信息放入Disruptor中</p><p>注册中心客户端从Disruptor中读取数据，并将接口信息注册到Soul-Admin</p><p>Disruptor在其中起数据与操作解耦的作用，利于扩展</p><h2 id=server>Server</h2><p><img src=/img/soul/register/server.png alt></p><p>在Soul-Admin配置中声明使用的注册中心服务端类型，如HTTP/Zookeeper</p><p>Soul-Admin启动时，更加配置的类型，加载并初始化对应的注册中心服务端</p><p>注册中心服务端收到Soul-Client注册的接口信息后，将其放入Disruptor中，然后会触发注册处理逻辑，将服务接口信息更新并发布同步事件</p><p>Disruptor在其中起到数据与操作解耦，利于扩展；同时比较注册请求过多，导致注册异常，有数据缓冲作用</p><h2 id=http-注册>Http 注册</h2><p>HTTP服务注册原理较为简单，在Soul-Client启动后，会调用Soul-Admin的相关服务注册接口，上传数据进行注册</p><p>Soul-Admin web服务接口收到请求后进行数据更新和数据同步事件发布</p><h2 id=zookeeper-注册>Zookeeper 注册</h2><p>Zookeeper存储结构如下：</p><pre><code>soul
   ├──regsiter
   ├    ├──metadata
   ├    ├     ├──${rpcType}
   ├    ├     ├      ├────${contextPath}
   ├    ├     ├               ├──${ruleName} : save metadata data of MetaDataRegisterDTO
   ├    ├──uri
   ├    ├     ├──${rpcType}
   ├    ├     ├      ├────${contextPath}
   ├    ├     ├               ├──${ip:prot} : save uri data of URIRegisterDTO
   ├    ├     ├               ├──${ip:prot}
</code></pre><p>Soul-Client启动时，将服务接口信息（MetaDataRegisterDTO/URIRegisterDTO）写到如上的zookeeper节点中。</p><p>Soul-Admin使用Zookeeper的Watch机制，对数据的更新和删除等事件进行监听，数据变更后触发对应的注册处理逻辑。</p><p>在收到MetaDataRegisterDTO节点变更后，触发selector和rule的数据变更和数据同步事件发布。</p><p>收到URIRegisterDTO节点变更后，触发selector的upstream的更新和数据同步事件发布。</p><h2 id=etcd-注册>Etcd 注册</h2><p>Etcd的键值存储结构如下：</p><pre><code>soul
   ├──regsiter
   ├    ├──metadata
   ├    ├     ├──${rpcType}
   ├    ├     ├      ├────${contextPath}
   ├    ├     ├               ├──${ruleName} : save metadata data of MetaDataRegisterDTO
   ├    ├──uri
   ├    ├     ├──${rpcType}
   ├    ├     ├      ├────${contextPath}
   ├    ├     ├               ├──${ip:prot} : save uri data of URIRegisterDTO
   ├    ├     ├               ├──${ip:prot}
</code></pre><p>Soul-Client启动时，将服务接口信息（MetaDataRegisterDTO/URIRegisterDTO）以Ephemeral方式写到如上的Etcd节点中。</p><p>Soul-Admin使用Etcd的Watch机制，对数据的更新和删除等事件进行监听，数据变更后触发对应的注册处理逻辑。</p><p>在收到MetaDataRegisterDTO节点变更后，触发selector和rule的数据变更和数据同步事件发布。</p><p>收到URIRegisterDTO节点变更后，触发selector的upstream的更新和数据同步事件发布。</p><h2 id=consul-注册>Consul 注册</h2><p>Consul的Metadata和URI分两部分存储，URIRegisterDTO随着服务注册记录在服务的metadata里，服务下线时随着服务节点一起消失。</p><p><img src=/img/soul/register/Consul-ui.png alt></p><p>Consul的MetaDataRegisterDTO存在Key/Value里，键值存储结构如下：</p><pre><code>soul
   ├──regsiter
   ├    ├──metadata
   ├    ├     ├──${rpcType}
   ├    ├     ├      ├────${contextPath}
   ├    ├     ├               ├──${ruleName} : save metadata data of MetaDataRegisterDTO

</code></pre><p>Soul-Client启动时，将服务接口信息（MetaDataRegisterDTO/URIRegisterDTO）分别放在ServiceInstance的Metadata（URIRegisterDTO）和KeyValue（MetaDataRegisterDTO），按照上述方式进行存储。</p><p>Soul-Admin通过监听Catalog和KeyValue的index的变化，来感知数据的更新和删除，数据变更后触发对应的注册处理逻辑。</p><p>在收到MetaDataRegisterDTO节点变更后，触发selector和rule的数据变更和数据同步事件发布。</p><p>收到URIRegisterDTO节点变更后，触发selector的upstream的更新和数据同步事件发布。</p><h2 id=nacos-注册>Nacos 注册</h2><p>Nacos分为两部分：URI 和 Metadata。</p><p>URI 使用实例注册方式，在服务异常的情况下，相关URI数据节点会自动进行删除，并发送事件到订阅端，订阅端进行相关的下线处理。</p><p>Metadata 使用配置注册方式，没有相关上下线操作，当有URI实例注册时，会相应的发布Metadata配置，订阅端监听数据变化，进行更新处理。</p><p>URI 实例注册命令规则如下：</p><pre><code>soul.register.service.${rpcType}
</code></pre><p>初始监听所有的RpcType节点，其下的{contextPath}实例会对应注册到其下，根据IP和Port进行区分，并携带其对应的contextPath信息。</p><p>URI 实例上下线之后，触发selector的upstream的更新和数据同步事件发布。</p><p>URI 实例上线时，会发布对应的 Metadata 数据，其节点名称命令规则如下：</p><pre><code>soul.register.service.${rpcType}.${contextPath}
</code></pre><p>订阅端会对所有的Metadata配置继续监听，当初次订阅和配置更新后，触发selector和rule的数据变更和数据同步事件发布。</p><h2 id=spi-扩展>SPI 扩展</h2><table><thead><tr><th><em>SPI 名称</em></th><th><em>详细说明</em></th></tr></thead><tbody><tr><td>SoulClientRegisterRepository</td><td>Soul网关客户端接入注册服务资源</td></tr></tbody></table><table><thead><tr><th><em>已知实现类</em></th><th><em>详细说明</em></th></tr></thead><tbody><tr><td>HttpClientRegisterRepository</td><td>基于Http请求的实现</td></tr><tr><td>ZookeeperClientRegisterRepository</td><td>基于Zookeeper注册的实现</td></tr><tr><td>EtcdClientRegisterRepository</td><td>基于etcd注册的实现</td></tr><tr><td>ConsulClientRegisterRepository</td><td>基于consul注册的实现</td></tr><tr><td>NacosClientRegisterRepository</td><td>基于Nacos注册的实现</td></tr></tbody></table><table><thead><tr><th><em>SPI 名称</em></th><th><em>详细说明</em></th></tr></thead><tbody><tr><td>SoulServerRegisterRepository</td><td>Soul网关客户端注册的后台服务资源</td></tr></tbody></table><table><thead><tr><th><em>已知实现类</em></th><th><em>详细说明</em></th></tr></thead><tbody><tr><td>SoulHttpRegistryController</td><td>使用Http服务接口来处理客户端注册请求</td></tr><tr><td>ZookeeperServerRegisterRepository</td><td>使用Zookeeper来处理客户端注册节点</td></tr><tr><td>EtcdServerRegisterRepository</td><td>使用etcd来处理客户端注册节点</td></tr><tr><td>ConsulServerRegisterRepository</td><td>使用consul来处理客户端注册节点</td></tr><tr><td>NacosServerRegisterRepository</td><td>使用Nacos来处理客户端注册节点</td></tr></tbody></table></article></main></div><footer class=ss-footer><div class=container><div class=links><div class="cate  -show-mobile"><h2 class=cate-title>Apache</h2><a class=link href=https://www.apache.org/>Foundation</a>
<a class=link href=https://github.com/apache/incubator-shenyu/issues>GitHub Issue Tracker</a>
<a class=link href=https://www.apache.org/licenses/>License</a>
<a class=link href=https://www.apache.org/security/>Security</a>
<a class=link href=http://www.apache.org/events/current-event>Events</a>
<a class=link href=http://www.apache.org/foundation/sponsorship.html>Sponsorship</a>
<a class=link href=http://www.apache.org/foundation/thanks.html>Thanks</a></div><div class=cate><h2 class=cate-title>资源</h2><a class=link href=https://github.com/apache/incubator-shenyu>Github</a>
<a class=link href=/zh/projects/shenyu/overview/>文档</a></div><div class=cate><h2 class=cate-title>参与进来</h2><a class=link href=https://github.com/apache/incubator-shenyu/issues/new>反馈</a>
<a class=link href=/zh/community>社区</a>
<a class=link href=/zh/news>新闻</a></div><div class=cate><h2 class=cate-title>订阅邮件组</h2><a class=link href=/zh/community/subscribe-email/>如何订阅</a>
<a class=link href=mailto://dev-subscribe@shenyu.apache.org>订阅邮件</a>
<a class=link href=https://lists.apache.org/list.html?dev@shenyu.apache.org>邮件归档</a></div></div><div class=qrcode><div><img class=qrcode-img src=/img/qrcode/WechatIMG127.jpeg><p class=qrcode-desc>微信公众号</p></div></div></div><div class=copyright><p>Copyright © 2021 The Apache Software Foundation. Licensed under the Apache License, Version 2.0.
Apache ShenYu, Apache Incubator, Apache, the Apache feather logo, the Apache ShenYu logo and the Apache Incubator project logo are trademarks of The Apache Software Foundation.
Apache ShenYu is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator.
Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects.
While incubation status is not necessarily a reflection of the completeness or stability of the code,
it does indicate that the project has yet to be fully endorsed by the ASF.</p></div></footer></body></html>