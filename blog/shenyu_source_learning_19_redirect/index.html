<!doctype html><html><head><title>Apache ShenYu Gateway Learning Redirect Plugin · Apache ShenYu</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="The girl on the prairie"><meta name=generator content="Hugo 0.55.5"><link rel="shortcut icon" href=/img/favicon.png type=image/png><link href=https://unpkg.com/purecss@1.0.0/build/base-min.css rel=stylesheet><link href=/css/main.css rel=stylesheet><link href=/css/zoom-image.css rel=stylesheet><script src=/js/iconfont.js></script><script src=/js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script><script>window.SITE_LANGUAGE="en"</script><script src=/js/app.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-187960192-2','auto');ga('send','pageview');}</script></head><body><header class=ss-header><nav class=navbar role=navigation aria-label="main navigation"><div class=navbar-brand><a class=logo-link style=font-size:25px;margin-right:50px href=/><img class=logo src=/img/logo/apache-shenyu.png></a><div class=-show-mobile><a id=mobile-menu-icon><svg class="icon" aria-hidden="true"><use xlink:href="#icon-menu"/></svg></a><nav id=mobile-menu><div id=js-menu-search-mobile class=navbar-search-mobile><input class=input placeholder=Search><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search"/></svg></div><a href=/projects/shenyu/download/><span>Download</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/projects/shenyu/overview/><span>Documentation</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/community/subscribe-email/><span>Community</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/news/><span>News</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/awesome/><span>Awesome</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/zh/blog/shenyu_source_learning_19_redirect/><span>中文</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-transfer"/></svg></a></nav></div></div><div class="navbar-menu -hidden-mobile"><div class=navbar-start><a class=navbar-item href=/projects/shenyu/download/>Download</a>
<a class=navbar-item href=/projects/shenyu/overview/>Documentation</a>
<a class=navbar-item href=/community/subscribe-email/>Community</a>
<a class=navbar-item href=/news/>News</a>
<a class=navbar-item href=/awesome/>Awesome</a>
<span class="navbar-item nav-hover"><a>Links</a><div class=dropdown-menu><a class=dropdown-item href=https://www.apache.org/>Apache Software Foundation</a>
<a class=dropdown-item href=https://github.com/apache/incubator-shenyu/issues>GitHub Issue Tracker</a>
<a class=dropdown-item href=https://www.apache.org/>License</a>
<a class=dropdown-item href=http://www.apache.org/events/current-event>Apache Events</a>
<a class=dropdown-item href=https://www.apache.org/licenses/>Security</a>
<a class=dropdown-item href=http://www.apache.org/foundation/sponsorship.html>Sponsor and Donate</a>
<a class=dropdown-item href=http://www.apache.org/foundation/thanks.html>Thanks</a></div></span></div><div class=navbar-end><div class=navbar-item><div id=js-menu-search class=navbar-search><input class=input placeholder=Search><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search"/></svg></div></div><div class=navbar-item><a class=translation href=/zh/blog/shenyu_source_learning_19_redirect/>中</a></div></div></div></nav></header><div class=ss-layout-container><main class="ss-layout-main -card"><div class=ss-meta><h1 class=title>Apache ShenYu Gateway Learning Redirect Plugin</h1><div class=meta>2021-03-16 ·
axing ·
<span class=tags><a class=tag href=/tags/apache-shenyu/ rel=tag>#Apache ShenYu</a></span></div></div><article class=typo><h1 id=介绍>介绍</h1><p><code>Soul</code> 网关在对目标服务进行代理调用的时候，可以使用 <code>redirect</code> 插件来重定向请求。其中包含两种场景：一种把 <code>redirectUrl</code> 配置为第三方URL 地址，直接使用 <code>308</code> 进行转发跳转，另一种是把 <code>redirectUrl</code> 配置以 <code>/</code> 开头的转发到网关自身。</p><h2 id=插件配置>插件配置</h2><ul><li>在 <code>soul-admin</code> –&gt; 插件管理 –&gt; <code>redirect</code>，设置为开启。</li><li>在 <code>soul-bootstrap</code> 项目的 <code>pom.xml</code> 文件中添加 <code>redirect</code> 的 <code>maven</code> 依赖。</li><li>在 <code>soul- admin</code> 后台设置选择器规则，只有匹配的请求，才会进行转发和重定向，请详细看：<a href=https://dromara.org/zh/projects/shenyu/selector-and-rule>选择器规则</a>。</li></ul><h2 id=maven-依赖>Maven 依赖</h2><p>在 <code>soul-bootstrap</code> 工程的 <code>pom.xml</code> 文件中添加插件依赖。</p><pre><code class=language-xml>&lt;dependency&gt;
  &lt;groupId&gt;org.apache.shenyu&lt;/groupId&gt;
  &lt;artifactId&gt;soul-spring-boot-starter-plugin-redirect&lt;/artifactId&gt;
  &lt;version&gt;${last.version}&lt;/version&gt;
&lt;/dependency&gt;
</code></pre><h2 id=场景>场景</h2><blockquote><p>顾名思义，<code>redirect</code> 插件就是对 <code>uri</code> 的重新转发和重定向。</p></blockquote><h3 id=重定向>重定向</h3><ul><li>我们在 <code>Rule</code> 配置自定义路径时，应该为一个可达的服务路径。</li><li>当匹配到请求后，根据自定义的路径，<code>ShenYu网关</code>会进行 <code>308</code> 服务跳转。</li></ul><p><img src=https://dromara.org/img/shenyu/plugin/redirect/redirect-01.png alt=重定向配置></p><h3 id=网关自身接口转发>网关自身接口转发</h3><ul><li>当满足匹配规则时，服务内部会使用 <code>DispatcherHandler</code> 内部接口转发。</li><li>要实现网关自身接口转发，我们需要在配置路径使用 <code>/</code> 作为前缀开始，具体配置如下图。</li></ul><p><img src=https://dromara.org/img/shenyu/plugin/redirect/redirect-02.png alt=自身接口转发></p><h2 id=源码解析>源码解析</h2><p>在解析 <code>redirect</code> 重定向源码之前，有必要说一些大前提，我们明白 ShenYu网关基于 SpringBoot WebFlux 实现，其中对于 <code>WebFlux</code> 如果默认什么都不配置，请求会默认执行 <code>DispatcherHandler</code> 处理，这个是响应式 <code>MVC</code> 的处理核心，可以看一下初始化：</p><pre><code class=language-java>protected void initStrategies(ApplicationContext context) {
  Map&lt;String, HandlerMapping&gt; mappingBeans = BeanFactoryUtils.beansOfTypeIncludingAncestors(context, HandlerMapping.class, true, false);
  ArrayList&lt;HandlerMapping&gt; mappings = new ArrayList(mappingBeans.values());
  AnnotationAwareOrderComparator.sort(mappings);
  // handlerMapping 相关
  this.handlerMappings = Collections.unmodifiableList(mappings);
  Map&lt;String, HandlerAdapter&gt; adapterBeans = BeanFactoryUtils.beansOfTypeIncludingAncestors(context, HandlerAdapter.class, true, false);
  // handlerAdapter 相关
  this.handlerAdapters = new ArrayList(adapterBeans.values());
  AnnotationAwareOrderComparator.sort(this.handlerAdapters);
  Map&lt;String, HandlerResultHandler&gt; beans = BeanFactoryUtils.beansOfTypeIncludingAncestors(context, HandlerResultHandler.class, true, false);
  // resultHandler 相关
  this.resultHandlers = new ArrayList(beans.values());
  AnnotationAwareOrderComparator.sort(this.resultHandlers);
}
</code></pre><p>再之后就是我们熟悉的 <code>MVC</code> 核心处理 <code>DispatcherHandler#handle</code> 方法</p><pre><code class=language-java>public Mono&lt;Void&gt; handle(ServerWebExchange exchange) {
    return this.handlerMappings == null ? this.createNotFoundError() : Flux.fromIterable(this.handlerMappings).concatMap((mapping) -&gt; {
        return mapping.getHandler(exchange);
    }).next().switchIfEmpty(this.createNotFoundError()).flatMap((handler) -&gt; {
        return this.invokeHandler(exchange, handler);
    }).flatMap((result) -&gt; {
        return this.handleResult(exchange, result);
    });
}
</code></pre><p>搞清楚默认 <code>DispatcherHandler</code> 如何处理，我们再来说一下 ShenYu网关，<code>SoulWebHandler</code> 实现了 <code>WebHandler</code> 接口，再把 <code>BeanName</code> 声明为 <code>webHandler</code> 替代了之前 <code>DispatcherHandler</code> 注册成默认处理 <code>handler</code>。</p><pre><code class=language-java>@Bean(&quot;webHandler&quot;)
public SoulWebHandler soulWebHandler(final ObjectProvider&lt;List&lt;SoulPlugin&gt;&gt; plugins) {
  List&lt;SoulPlugin&gt; pluginList = plugins.getIfAvailable(Collections::emptyList);
  List&lt;SoulPlugin&gt; soulPlugins = pluginList.stream()
    .sorted(Comparator.comparingInt(SoulPlugin::getOrder)).collect(Collectors.toList());
  soulPlugins.forEach(soulPlugin -&gt; log.info(&quot;load plugin:[{}] [{}]&quot;, soulPlugin.named(), soulPlugin.getClass().getName()));
  return new SoulWebHandler(soulPlugins);
}
</code></pre><p>到此为止我们明白了，默认请求都通过了 <code>SoulWebHandler#handle</code> 处理，如果我们需要转发到网关自身的 <code>MVC</code> 如何做呢？下面通过初始化<code>RedirectPlugin</code> 的时候把 <code>DispatcherHandler</code> 注入，根据具体请求再由 <code>DispatcherHandler</code> 分发，具体核心代码如下：</p><pre><code class=language-java>@Override
protected Mono&lt;Void&gt; doExecute(final ServerWebExchange exchange, final SoulPluginChain chain,
                               final SelectorData selector, final RuleData rule) {
  final String handle = rule.getHandle();
  final RedirectHandle redirectHandle = GsonUtils.getInstance().fromJson(handle, RedirectHandle.class);
  if (Objects.isNull(redirectHandle) || StringUtils.isBlank(redirectHandle.getRedirectURI())) {
    log.error(&quot;uri redirect rule can not configuration: {}&quot;, handle);
    return chain.execute(exchange);
  }
  // 处理以 / 开头自身转发
  if (redirectHandle.getRedirectURI().startsWith(ROOT_PATH_PREFIX)) {
    ServerHttpRequest request = exchange.getRequest().mutate()
      .uri(Objects.requireNonNull(UriUtils.createUri(redirectHandle.getRedirectURI()))).build();
    ServerWebExchange mutated = exchange.mutate().request(request).build();
    return dispatcherHandler.handle(mutated);
  } else {
    // 否则就 308 跳转
    ServerHttpResponse response = exchange.getResponse();
    response.setStatusCode(HttpStatus.PERMANENT_REDIRECT);
    response.getHeaders().add(HttpHeaders.LOCATION, redirectHandle.getRedirectURI());
    return response.setComplete();
  }
}
</code></pre><h3 id=参考链接>参考链接：</h3><ul><li><a href=https://learnku.com/articles/30263#replies>Spring WebFlux 的设计及工作原理剖析</a></li><li><a href=https://www.processon.com/view/link/5d0763ede4b039f39f3b5a8a>Spring WebFlux 工作原理</a></li></ul></article><div class=-show-mobile><nav class=ss-pagination-next><a class=link-prev href=/blog/apache-cloud-native-meet-02/><span class=text>Prev:</span>
<span class=text>Apache ShenYu Source Code 01 Reading Sharing Session 02</span></a>
<a class=link-next href=/blog/shenyu_source_learning_20_sentinel/><span class=text>Next:</span>
<span class=text>Apache ShenYu Gateway Learning Sentinel Plugin</span></a></nav></div></main><aside class=ss-layout-aside><div class=ss-card><h2 class=card-title>Related</h2><ul class=ss-aside-related><li><a href=/blog/shenyu_source_learning_16_divide_sxj/>Apache ShenYu Gateway Learning Divide Plugin Source Code Interpretation</a></li><li><a href=/blog/shenyu_source_learning_18_ratelimiter/>Apache ShenYu Gateway Learning RateLimiter Plugin</a></li><li><a href=/blog/shenyu_source_learning_11_spi/>Apache ShenYu Gateway Learning SPI</a></li><li><a href=/blog/shenyu_source_learning_12_sign/>Apache ShenYu Gateway Learning Sign Plugin</a></li><li><a href=/blog/shenyu_source_learning_09_httplongpolling_02/>Apache ShenYu Gateway Learns Http Long Polling Analysis 02</a></li></ul></div><div class="ss-aside-tags ss-card"><h2 class=card-title>Tag
<span class=card-extra></span></h2><ul class=tag-list><li class=tag><a href=/tags/apache/>Apache</a></li><li class=tag><a href=/tags/apache-shenyu/>Apache ShenYu</a></li><li class=tag><a href=/tags/code-conduct/>Code Conduct</a></li><li class=tag><a href=/tags/committer/>Committer</a></li><li class=tag><a href=/tags/contributor/>Contributor</a></li><li class=tag><a href=/tags/dreamcode/>DreamCode</a></li><li class=tag><a href=/tags/gateway/>GateWay</a></li><li class=tag><a href=/tags/icla/>ICLA</a></li><li class=tag><a href=/tags/issue-pr/>Issue-PR</a></li><li class=tag><a href=/tags/reactor/>Reactor</a></li><li class=tag><a href=/tags/subscribe-email/>Subscribe-Email</a></li><li class=tag><a href=/tags/two-fa/>Two-FA</a></li><li class=tag><a href=/tags/vote-committer/>Vote-Committer</a></li></ul></div></aside></div><footer class=ss-footer><div class=container><div class=links><div class="cate  -show-mobile"><h2 class=cate-title>Apache</h2><a class=link href=https://www.apache.org/>Foundation</a>
<a class=link href=https://github.com/apache/incubator-shenyu/issues>GitHub Issue Tracker</a>
<a class=link href=https://www.apache.org/licenses/>License</a>
<a class=link href=https://www.apache.org/security/>Security</a>
<a class=link href=http://www.apache.org/events/current-event>Events</a>
<a class=link href=http://www.apache.org/foundation/sponsorship.html>Sponsorship</a>
<a class=link href=http://www.apache.org/foundation/thanks.html>Thanks</a></div><div class=cate><h2 class=cate-title>Resources</h2><a class=link href=https://github.com/apache/incubator-shenyu>Github</a>
<a class=link href=/projects/shenyu/overview/>Documentation</a></div><div class=cate><h2 class=cate-title>Get Involved</h2><a class=link href=https://github.com/apache/incubator-shenyu/issues/new>Feedback</a>
<a class=link href=/community>Community</a>
<a class=link href=/news>News</a>
<a class=link href=/awesome>Awesome</a></div><div class=cate><h2 class=cate-title>Subscribe mailing list</h2><a class=link href=/community/subscribe-email/>How to subscribe</a>
<a class=link href=mailto://dev-subscribe@shenyu.apache.org>Subscribe Mail</a>
<a class=link href=https://lists.apache.org/list.html?dev@shenyu.apache.org>Mail Archive</a></div></div><div class=qrcode><div><img class=qrcode-img src=/img/qrcode/WechatIMG127.jpeg><p class=qrcode-desc>Wechat Official Account</p></div></div></div><div class=copyright><p>Copyright © 2021 The Apache Software Foundation. Licensed under the Apache License, Version 2.0.
Apache ShenYu, Apache Incubator, Apache, the Apache feather logo, the Apache ShenYu logo and the Apache Incubator project logo are trademarks of The Apache Software Foundation.
Apache ShenYu is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator.
Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects.
While incubation status is not necessarily a reflection of the completeness or stability of the code,
it does indicate that the project has yet to be fully endorsed by the ASF.</p></div></footer></body></html>