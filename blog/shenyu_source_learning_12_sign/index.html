<!doctype html><html><head><title>Apache ShenYu Gateway Learning Sign Plugin · Apache ShenYu</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="The girl on the prairie"><meta name=generator content="Hugo 0.55.5"><link rel="shortcut icon" href=/img/favicon.png type=image/png><link href=https://unpkg.com/purecss@1.0.0/build/base-min.css rel=stylesheet><link href=/css/main.css rel=stylesheet><link href=/css/zoom-image.css rel=stylesheet><script src=/js/iconfont.js></script><script src=/js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script><script>window.SITE_LANGUAGE="en"</script><script src=/js/app.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-187960192-2','auto');ga('send','pageview');}</script></head><body><header class=ss-header><nav class=navbar role=navigation aria-label="main navigation"><div class=navbar-brand><a class=logo-link style=font-size:25px;margin-right:50px href=/><img class=logo src=/img/logo/apache-shenyu.png></a><div class=-show-mobile><a id=mobile-menu-icon><svg class="icon" aria-hidden="true"><use xlink:href="#icon-menu"/></svg></a><nav id=mobile-menu><div id=js-menu-search-mobile class=navbar-search-mobile><input class=input placeholder=Search><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search"/></svg></div><a href=/projects/shenyu/download/><span>Download</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/projects/shenyu/overview/><span>Documentation</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/community/subscribe-email/><span>Community</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/news/><span>News</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/awesome/><span>Awesome</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/zh/blog/shenyu_source_learning_12_sign/><span>中文</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-transfer"/></svg></a></nav></div></div><div class="navbar-menu -hidden-mobile"><div class=navbar-start><a class=navbar-item href=/projects/shenyu/download/>Download</a>
<a class=navbar-item href=/projects/shenyu/overview/>Documentation</a>
<a class=navbar-item href=/community/subscribe-email/>Community</a>
<a class=navbar-item href=/news/>News</a>
<a class=navbar-item href=/awesome/>Awesome</a>
<span class="navbar-item nav-hover"><a>Links</a><div class=dropdown-menu><a class=dropdown-item href=https://www.apache.org/>Apache Software Foundation</a>
<a class=dropdown-item href=https://github.com/apache/incubator-shenyu/issues>GitHub Issue Tracker</a>
<a class=dropdown-item href=https://www.apache.org/>License</a>
<a class=dropdown-item href=http://www.apache.org/events/current-event>Apache Events</a>
<a class=dropdown-item href=https://www.apache.org/licenses/>Security</a>
<a class=dropdown-item href=http://www.apache.org/foundation/sponsorship.html>Sponsor and Donate</a>
<a class=dropdown-item href=http://www.apache.org/foundation/thanks.html>Thanks</a></div></span></div><div class=navbar-end><div class=navbar-item><div id=js-menu-search class=navbar-search><input class=input placeholder=Search><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search"/></svg></div></div><div class=navbar-item><a class=translation href=/zh/blog/shenyu_source_learning_12_sign/>中</a></div></div></div></nav></header><div class=ss-layout-container><main class="ss-layout-main -card"><div class=ss-meta><h1 class=title>Apache ShenYu Gateway Learning Sign Plugin</h1><div class=meta>2021-01-29 ·
tangtian ·
<span class=tags><a class=tag href=/tags/apache-shenyu/ rel=tag>#Apache ShenYu</a></span></div></div><article class=typo><h2 id=介绍>介绍</h2><p>sign插件用来对请求进行签名认证的插件</p><h2 id=ak-sk-介绍>AK/SK 介绍</h2><p>AK/SK（Access Key ID/Secret Access Key）即访问密钥，包含访问密钥ID（AK）和秘密访问密钥（SK）两部分，主要用于对用户的调用行为进行鉴权和认证。</p><h2 id=插件使用-以-dubbo-findall-为例>插件使用-以（/dubbo/findAll）为例</h2><h3 id=在soulbootstrap的-pom-xml-文件中添加-sign-的支持>在SoulBootstrap的 pom.xml 文件中添加 <code>sign</code> 的支持</h3><pre><code class=language-xml>  &lt;!-- apache shenyu sign plugin start--&gt;
  &lt;dependency&gt;
      &lt;groupId&gt;org.apache.shenyu&lt;/groupId&gt;
      &lt;artifactId&gt;soul-spring-boot-starter-plugin-sign&lt;/artifactId&gt;
     &lt;version&gt;${last.version}&lt;/version&gt;
  &lt;/dependency&gt;
  &lt;!-- apache shenyu sign plugin end--&gt;
</code></pre><h3 id=新增appkey-secretkey>新增appKey，secretKey</h3><p><img src=/img/shenyu/blog4/01.png alt=image.png>
<img src=/img/shenyu/blog4/02.png alt=image.png>
<img src=/img/shenyu/blog4/03.png alt=image.png>
<img src=/img/shenyu/blog4/04.png alt=image.png></p><h2 id=配置选择器和规则器>配置选择器和规则器</h2><p>添加选择器
<img src=/img/shenyu/blog4/05.png alt=image.png>
添加规则器
<img src=/img/shenyu/blog4/06.png alt=image.png></p><h3 id=增加获取鉴权服务>增加获取鉴权服务</h3><p>在自己服务中增加一个对外访问的方法</p><pre><code class=language-java>    @GetMapping(&quot;/authUrl&quot;)
    public String authUrl() {
        Map&lt;String, String&gt; map = Maps.newHashMapWithExpectedSize(2);
        //timestamp为毫秒数的字符串形式 String.valueOf(LocalDateTime.now().toInstant(ZoneOffset.of(&quot;+8&quot;)).toEpochMilli())
        String timetamp = String.valueOf(LocalDateTime.now().toInstant(ZoneOffset.of(&quot;+8&quot;)).toEpochMilli()) ;
        System.out.println(timetamp);
        map.put(&quot;timestamp&quot;,timetamp);  //值应该为毫秒数的字符串形式
        map.put(&quot;path&quot;, &quot;/dubbo/findAll&quot;);
        map.put(&quot;version&quot;, &quot;1.0.0&quot;);
        List&lt;String&gt; storedKeys = Arrays.stream(map.keySet()
                .toArray(new String[]{}))
                .sorted(Comparator.naturalOrder())
                .collect(Collectors.toList());
        final String sign = storedKeys.stream()
                .map(key -&gt; String.join(&quot;&quot;, key, map.get(key)))
                .collect(Collectors.joining()).trim()
                .concat(&quot;D19CF79F647A465AB9C5C66F430CAD28&quot;);//SECRETkey
        return DigestUtils.md5DigestAsHex(sign.getBytes()).toUpperCase();
    }

</code></pre><p>下面需要注意的
<img src=/img/shenyu/blog4/07.png alt=image.png></p><h3 id=在网关中增加鉴权头信息>在网关中增加鉴权头信息</h3><p><img src=/img/shenyu/blog4/08.png alt=image.png></p><h3 id=请求的结果演示>请求的结果演示</h3><p>通过的返回
<img src=/img/shenyu/blog4/09.png alt=image.png>
5min超时的返回
<img src=/img/shenyu/blog4/10.png alt=image.png>
appKey填写错误的返回
<img src=/img/shenyu/blog4/11.png alt=image.png>
签名错误的返回
<img src=/img/shenyu/blog4/12.png alt=image.png>
禁用sign插件的返回
<img src=/img/shenyu/blog4/13.png alt=image.png></p><h2 id=sign插件的实现分析>sign插件的实现分析</h2><h3 id=java中pair>java中Pair</h3><p>简单的说就是pair保存的是一对key value，而map可以保存多对key value。
SignPlugin插件调用DefaultSignService中signVerify方法
判断sign 插件是否可用，如果可用获取在global 插件存入的soulContext并调用verify方法</p><pre><code class=language-java>if (signData != null &amp;&amp; signData.getEnabled()) {
  final SoulContext soulContext = exchange.getAttribute(Constants.CONTEXT);
  assert soulContext != null;
  return verify(soulContext, exchange);
}
</code></pre><p>verify方法中
判断请求头信息是否正确
如果不正确就抛出 log.error(&ldquo;sign parameters are incomplete,{}&rdquo;, soulContext)异常</p><pre><code class=language-java>if (StringUtils.isBlank(soulContext.getAppKey())
    || StringUtils.isBlank(soulContext.getSign())
    || StringUtils.isBlank(soulContext.getTimestamp())) {
  log.error(&quot;sign parameters are incomplete,{}&quot;, soulContext);
  return Pair.of(Boolean.FALSE, Constants.SIGN_PARAMS_ERROR);
}
</code></pre><p>判断请求时间是否超时</p><pre><code class=language-java>    if (between &gt; delay) {
            return Pair.of(Boolean.FALSE, String.format(SoulResultEnum.SING_TIME_IS_TIMEOUT.getMsg(), delay));
        }
</code></pre><p>没有超时继续调用sign方法
获取认证数据，这个数据在soulAdmin 中配置</p><pre><code class=language-java>AppAuthData appAuthData = SignAuthDataCache.getInstance().obtainAuthData(soulContext.getAppKey());
</code></pre><p>后面对appAuthData数据进行判断，数据有错误就不通过
对获取的参数再次签名，判断传入的和再次签名的是否一样</p><pre><code class=language-java>String sigKey = SignUtils.generateSign(appAuthData.getAppSecret(), buildParamsMap(soulContext));
</code></pre><p>如果都校验都通过就完成认证 访问请求。</p></article><div class=-show-mobile><nav class=ss-pagination-next><a class=link-prev href=/blog/shenyu_source_learning_09_httplongpolling_02/><span class=text>Prev:</span>
<span class=text>Apache ShenYu Gateway Learns Http Long Polling Analysis 02</span></a>
<a class=link-next href=/blog/shenyu_source_learning_11_spi/><span class=text>Next:</span>
<span class=text>Apache ShenYu Gateway Learning SPI</span></a></nav></div></main><aside class=ss-layout-aside><div class=ss-card><h2 class=card-title>Related</h2><ul class=ss-aside-related><li><a href=/blog/shenyu_source_learning_09_httplongpolling_02/>Apache ShenYu Gateway Learns Http Long Polling Analysis 02</a></li><li><a href=/blog/shenyu_source_learning_17_http/>Apache ShenYu Gateway Learning Http Request Adventure</a></li><li><a href=/blog/shenyu_source_learning_14_nacos/>Apache ShenYu Gateway Learns Nacos Data Synchronization</a></li><li><a href=/blog/shenyu_source_learning_08_httplongpolling_01/>Apache ShenYu Gateway Learns Http Long Polling Analysis 01</a></li><li><a href=/blog/shenyu_source_learning_10_websocket/>Apache ShenYu Gateway Learns WebSocket Data Synchronization Analysis</a></li></ul></div><div class="ss-aside-tags ss-card"><h2 class=card-title>Tag
<span class=card-extra></span></h2><ul class=tag-list><li class=tag><a href=/tags/apache/>Apache</a></li><li class=tag><a href=/tags/apache-shenyu/>Apache ShenYu</a></li><li class=tag><a href=/tags/code-conduct/>Code Conduct</a></li><li class=tag><a href=/tags/committer/>Committer</a></li><li class=tag><a href=/tags/contributor/>Contributor</a></li><li class=tag><a href=/tags/dreamcode/>DreamCode</a></li><li class=tag><a href=/tags/gateway/>GateWay</a></li><li class=tag><a href=/tags/icla/>ICLA</a></li><li class=tag><a href=/tags/issue-pr/>Issue-PR</a></li><li class=tag><a href=/tags/reactor/>Reactor</a></li><li class=tag><a href=/tags/subscribe-email/>Subscribe-Email</a></li><li class=tag><a href=/tags/two-fa/>Two-FA</a></li><li class=tag><a href=/tags/vote-committer/>Vote-Committer</a></li></ul></div></aside></div><footer class=ss-footer><div class=container><div class=links><div class="cate  -show-mobile"><h2 class=cate-title>Apache</h2><a class=link href=https://www.apache.org/>Foundation</a>
<a class=link href=https://github.com/apache/incubator-shenyu/issues>GitHub Issue Tracker</a>
<a class=link href=https://www.apache.org/licenses/>License</a>
<a class=link href=https://www.apache.org/security/>Security</a>
<a class=link href=http://www.apache.org/events/current-event>Events</a>
<a class=link href=http://www.apache.org/foundation/sponsorship.html>Sponsorship</a>
<a class=link href=http://www.apache.org/foundation/thanks.html>Thanks</a></div><div class=cate><h2 class=cate-title>Resources</h2><a class=link href=https://github.com/apache/incubator-shenyu>Github</a>
<a class=link href=/projects/shenyu/overview/>Documentation</a></div><div class=cate><h2 class=cate-title>Get Involved</h2><a class=link href=https://github.com/apache/incubator-shenyu/issues/new>Feedback</a>
<a class=link href=/community>Community</a>
<a class=link href=/news>News</a>
<a class=link href=/awesome>Awesome</a></div><div class=cate><h2 class=cate-title>Subscribe mailing list</h2><a class=link href=/community/subscribe-email/>How to subscribe</a>
<a class=link href=mailto://dev-subscribe@shenyu.apache.org>Subscribe Mail</a>
<a class=link href=https://lists.apache.org/list.html?dev@shenyu.apache.org>Mail Archive</a></div></div><div class=qrcode><div><img class=qrcode-img src=/img/qrcode/WechatIMG127.jpeg><p class=qrcode-desc>Wechat Official Account</p></div></div></div><div class=copyright><p>Copyright © 2021 The Apache Software Foundation. Licensed under the Apache License, Version 2.0.
Apache ShenYu, Apache Incubator, Apache, the Apache feather logo, the Apache ShenYu logo and the Apache Incubator project logo are trademarks of The Apache Software Foundation.
Apache ShenYu is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator.
Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects.
While incubation status is not necessarily a reflection of the completeness or stability of the code,
it does indicate that the project has yet to be fully endorsed by the ASF.</p></div></footer></body></html>