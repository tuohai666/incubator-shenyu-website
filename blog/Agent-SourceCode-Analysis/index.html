<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Apache ShenYu (Incubating) Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Apache ShenYu (Incubating) Blog Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Apache ShenYu (Incubating)" href="/opensearch.xml">
<link rel="alternate" type="application/rss+xml" href="/news/rss.xml" title="Apache ShenYu (Incubating) Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/news/atom.xml" title="Apache ShenYu (Incubating) Blog Atom Feed"><title data-react-helmet="true">ShenYu Agent Source Code Analysis | Apache ShenYu (Incubating)</title><meta data-react-helmet="true" property="og:title" content="ShenYu Agent Source Code Analysis | Apache ShenYu (Incubating)"><meta data-react-helmet="true" name="description" content="Apache ShenYu is an asynchronous, high-performance, cross-language, responsive API gateway."><meta data-react-helmet="true" property="og:description" content="Apache ShenYu is an asynchronous, high-performance, cross-language, responsive API gateway."><meta data-react-helmet="true" property="og:url" content="https://shenyu.apache.org//blog/Agent-SourceCode-Analysis"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://shenyu.apache.org//blog/Agent-SourceCode-Analysis"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//blog/Agent-SourceCode-Analysis" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//zh/blog/Agent-SourceCode-Analysis" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//blog/Agent-SourceCode-Analysis" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.c16418f4.css">
<link rel="preload" href="/assets/js/runtime~main.99a58cf7.js" as="script">
<link rel="preload" href="/assets/js/main.1e439982.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.png" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/img/logo.png" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"></a><a class="navbar__item navbar__link" href="/download">Download</a><a class="navbar__item navbar__link" href="/docs/index">Document</a><a class="navbar__item navbar__link" href="/community/subscribe-email">Community</a><a class="navbar__item navbar__link" href="/event/2.4.2-release">Event</a><a class="navbar__item navbar__link" href="/news">News</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/users">Users</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__item navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Foundation</a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">License</a></li><li><a href="https://www.apache.org/events/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events</a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks</a></li></ul></div></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__item navbar__link" href="/docs/index">2.4.2</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/next/index">Next</a></li><li><a class="dropdown__link" href="/docs/index">2.4.2</a></li><li><a class="dropdown__link" href="/docs/2.4.1/index">2.4.1</a></li><li><a class="dropdown__link" href="/docs/2.4.0/index">2.4.0</a></li><li><a class="dropdown__link" href="/docs/2.3.0/index">2.3.0</a></li><li><a class="dropdown__link" href="/versions">All versions</a></li></ul></div><a href="https://github.com/apache/incubator-shenyu" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__item navbar__link"><span><svg t="1631348384596" class="icon" viewBox="0 0 1024 1024" version="1.1" style="vertical-align:text-bottom;margin-right:5px" p-id="557" width="20" height="20"><path d="M547.797333 638.208l-104.405333-103.168 1.237333-1.28a720.170667 720.170667 0 0 0 152.490667-268.373333h120.448V183.082667h-287.744V100.906667H347.605333v82.218666H59.818667V265.386667h459.178666a648.234667 648.234667 0 0 1-130.304 219.946666 643.242667 643.242667 0 0 1-94.976-137.728H211.541333a722.048 722.048 0 0 0 122.453334 187.434667l-209.194667 206.378667 58.368 58.368 205.525333-205.525334 127.872 127.829334 31.232-83.84m231.424-208.426667h-82.218666l-184.96 493.312h82.218666l46.037334-123.306667h195.242666l46.464 123.306667h82.218667l-185.002667-493.312m-107.690666 287.744l66.56-178.005333 66.602666 178.005333z" fill="currentColor" p-id="558"></path></svg><span>English</span></span></a><ul class="dropdown__menu"><li><a href="/blog/Agent-SourceCode-Analysis" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">English</a></li><li><a href="/zh/blog/Agent-SourceCode-Analysis" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">简体中文</a></li></ul></div><div class="react-toggle toggle_2i4l react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_iYfV">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV">🌞</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="searchBox_Bc3W"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_SrOn thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_jISh margin-bottom--md">All Blog Posts</div><ul class="sidebarItemList_UfcF"><h4 class="categoryHeader_Xx2W">Agent</h4><li class="sidebarItem_v502"><a aria-current="page" class="sidebarItemLink_yJnx sidebarItemLinkActive_Aygi" href="/blog/Agent-SourceCode-Analysis">ShenYu Agent Source Code Analysis</a></li><h4 class="categoryHeader_Xx2W">DataSync</h4><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/blog/DataSync-SourceCode-Analysis-Etcd-Data-Sync">Etcd Data Synchronization Source Code Analysis</a></li><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/blog/DataSync-SourceCode-Analysis-Http-Data-Sync">Http Long Polling Data Synchronization Source Code Analysis</a></li><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/blog/DataSync-SourceCode-Analysis-Nacos-Data-Sync">Nacos Data Synchronization Source Code Analysis</a></li><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/blog/DataSync-SourceCode-Analysis-WebSocket-Data-Sync">WebSocket Data Synchronization Source Code Analysis</a></li><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/blog/DataSync-SourceCode-Analysis-ZooKeeper-Data-Sync">ZooKeeper Data Synchronization Source Code Analysis</a></li><h4 class="categoryHeader_Xx2W">IntegrationTest</h4><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/blog/IntegrationTest-Analysis">Integration Test Analysis</a></li><h4 class="categoryHeader_Xx2W">Plugin</h4><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/blog/Plugin-SourceCode-Analysis-Context-Path-Plugin">Code Analysis For Context-Path Plugin</a></li><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/blog/Plugin-SourceCode-Analysis-Param-Mapping-Plugin">Code Analysis For Param-Mapping Plugin</a></li><h4 class="categoryHeader_Xx2W">RegisterCenter</h4><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/blog/RegisterCenter-SourceCode-Analysis-Http-Register">Register Center Source Code Analysis of Http Register</a></li><h4 class="categoryHeader_Xx2W">SPI</h4><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/blog/SPI-SourceCode-Analysis-LoadBalance-SPI">LoadBalance SPI Source Code Analysis</a></li><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/blog/SPI-SourceCode-Analysis-MatchStrategy-SPI">MatchStrategy  -- analyze the design based on SPI</a></li><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/blog/SPI-SourceCode-Analysis-PredicateJudge-SPI">PredicateJudge -- analyze the design based on SPI</a></li><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/blog/SPI-SourceCode-Analysis-RateLimiter-SPI">RateLimiter SPI code analysis</a></li><h4 class="categoryHeader_Xx2W">Start</h4><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/blog/Start-SourceCode-Analysis-Start-Demo">Apache ShenYu Start Demo</a></li></ul></nav></aside><main class="col col--7"><article><header><h1 class="blogPostTitle_d4p0">ShenYu Agent Source Code Analysis</h1><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2022-03-17T09:10:34.432Z">March 17, 2022</time> · 24 min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/midnight2104" target="_blank" rel="noopener noreferrer">midnight2104</a></div><small class="avatar__subtitle">Apache ShenYu Committer</small></div></div></header><div class="markdown"><blockquote><p><a href="https://shenyu.apache.org/zh/docs/index" target="_blank" rel="noopener noreferrer">Apache ShenYu</a> is an asynchronous, high-performance, cross-language, responsive API gateway.</p></blockquote><p>In the <code>Apache ShenYu</code> gateway, <code>Apache ShenYu</code> use <code>Java Agent</code> and <code>Bytecode Enhancement</code> technologies to enable seamless burial, allowing users to access third-party observability systems for <code>Traces</code>, <code>Metrics</code> and <code>Logging</code> without introducing dependencies.</p><blockquote><p>This article is based on <code>shenyu-2.4.2</code> version for source code analysis, please refer to <a href="https://shenyu.apache.org/docs/user-guide/observability/observability/" target="_blank" rel="noopener noreferrer">Observability</a> .</p></blockquote><p>Specifically, the <code>shenyu-agent</code> module, which is based on the <code>Java Agent</code> mechanism, through the <code>ByteBuddy</code> bytecode enhancement library, to enhance the object at class load time, belongs to the static proxy.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="aboutaop"></a>AboutAOP<a class="hash-link" href="#aboutaop" title="Direct link to heading">#</a></h3><p>Before analyzing the source code, the following <code>AOP</code> related terms are introduced to facilitate subsequent understanding.</p><ul><li><code>JoinPoint</code>: the join point, the point in time when the program is running, such as the execution point of a method.</li><li><code>PointCut</code>: entry point, the condition that matches <code>JoinPoint</code>.</li><li><code>Advice</code>: notification, the specific execution logic.</li><li><code>Target</code>: target object.</li><li><code>Proxy</code>: proxy object.</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="about-byte-buddy"></a>About Byte Buddy<a class="hash-link" href="#about-byte-buddy" title="Direct link to heading">#</a></h3><p><code>Byte Buddy</code> is a code generation and manipulation library that creates and modifies <code>Java</code> classes during the runtime of a <code>Java</code> application. It can be used to create any class, unlike the <code>JDK</code> dynamic proxy that forces an interface. In addition, <code>Byte Buddy</code> provides a convenient API for changing classes manually, using the <code>Java</code> proxy, or during the build.</p><ul><li>provides a very convenient API interface to match powerful classes, methods, etc.</li><li>out-of-the-box , zero learning costs , shielding the underlying operational bytecode technology .</li><li>powerful open customizability features, allowing custom bytecode for any implemented method.</li><li>the principle of minimal runtime code generation for efficient performance.</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1-premain-method"></a>1. premain method<a class="hash-link" href="#1-premain-method" title="Direct link to heading">#</a></h3><p>The <code>premain() function</code> is the entry function for the <code>javaagent</code>, which is provided by <code>ShenyuAgentBootstrap</code> in <code>ShenYu</code> and implements the entire <code>agent</code> logic.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * agent bootstrap</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuAgentBootstrap {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *  premain.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void premain(final String arguments, final Instrumentation instrumentation) throws Exception {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. read config file</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuAgentConfigUtils.setConfig(ShenyuAgentConfigLoader.load());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2. load all plugins</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuAgentPluginLoader.getInstance().loadAllPlugins();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3. create agent</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        AgentBuilder agentBuilder = new AgentBuilder.Default().with(new ByteBuddy().with(TypeValidation.ENABLED))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .ignore(ElementMatchers.isSynthetic())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .or(ElementMatchers.nameStartsWith(&quot;org.apache.shenyu.agent.&quot;));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        agentBuilder.type(ShenyuAgentTypeMatcher.getInstance())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .transform(new ShenyuAgentTransformer())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .with(AgentBuilder.RedefinitionStrategy.RETRANSFORMATION)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .with(new TransformListener()).installOn(instrumentation);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 4. start plugin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PluginLifecycleManager lifecycleManager = new PluginLifecycleManager();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        lifecycleManager.startup(ShenyuAgentConfigUtils.getPluginConfigMap());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Runtime.getRuntime().addShutdownHook(new Thread(lifecycleManager::close));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The core logic of the <code>premain function</code> is the four-step operation above.</p><ul><li><ol><li>reading the configuration file.</li></ol></li><li><ol start="2"><li>loading all plugins.</li></ol></li><li><ol start="3"><li>create the agent.</li></ol></li><li><ol start="4"><li>start the plug-in.</li></ol></li></ul><p>The next source code analysis will analyze these four operations in turn.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-read-config-file"></a>2. Read Config File<a class="hash-link" href="#2-read-config-file" title="Direct link to heading">#</a></h3><ul><li>ShenyuAgentConfigLoader#load()</li></ul><p>The processing of the configuration file is done by <code>ShenyuAgentConfigLoader</code> and the code is implemented as follows.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuAgentConfigLoader {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // config path</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final String CONFIG_PATH = &quot;config-path&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * load file.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static ShenyuAgentConfig load() throws IOException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get file path</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String configPath = System.getProperty(CONFIG_PATH);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // if there is no configuration, read the default file shenyu-agent.yaml</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        File configFile = StringUtils.isEmpty(configPath) ? ShenyuAgentLocator.locatorConf(&quot;shenyu-agent.yaml&quot;) : new File(configPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // read the configuration file and parse it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuYamlEngine.agentConfig(configFile);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>You can specify the path of the configuration file by <code>config-path</code>, if not, the default configuration file <code>shenyu-agent.yaml</code> will be read, and then the configuration file will be parsed by <code>ShenyuYamlEngine</code>.</p><p>The format of the configuration file is <code>yaml</code> format, please refer to the introduction of the official website for how to configure it <a href="https://shenyu.apache.org/docs/user-guide/observability/observability/" target="_blank" rel="noopener noreferrer">observability</a> .</p><p>The default configuration file <code>shenyu-agent.yaml</code> has the following format.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">appName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> shenyu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">agent  </span><span class="token comment" style="color:#999988;font-style:italic"># app name</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">supports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># what features are currently supported</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">tracing</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># tracing plugin</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#    - jaeger   </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#    - opentelemetry</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> zipkin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">metrics</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># metrics plugin</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">logging</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># logging plugin</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">plugins</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># plugin info</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">tracing</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">jaeger</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;localhost&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5775</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">props</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">SERVICE_NAME</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;shenyu-agent&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">JAEGER_SAMPLER_TYPE</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;const&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">JAEGER_SAMPLER_PARAM</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;1&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">opentelemetry</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">props</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">otel.traces.exporter</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jaeger </span><span class="token comment" style="color:#999988;font-style:italic">#zipkin #otlp</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">otel.resource.attributes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;service.name=shenyu-agent&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">otel.exporter.jaeger.endpoint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;http://localhost:14250/api/traces&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">zipkin</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;localhost&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9411</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">props</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">SERVICE_NAME</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;shenyu-agent&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">URL_VERSION</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/api/v2/spans&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">SAMPLER_TYPE</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;const&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">SAMPLER_PARAM</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;1&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">metrics</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">prometheus</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;localhost&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8081</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">props</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">logging</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">elasticSearch</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;localhost&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8082</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">props</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">kafka</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;localhost&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8082</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      props</span><span class="token punctuation" style="color:#393A34">:</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Which plugin you need to enable, specify it in <code>supports</code>, and then <code>plugins</code> to specify the configuration information of the plugin.</p><blockquote><p>So far, the latest version of <code>Apache ShenYu</code> released is <code>2.4.2</code> version, the plugins that can support <code>tracing</code> are <code>jaeger</code>, <code>opentelemetry</code> and <code>zipkin</code>, <code>metrics</code> and <code>logging</code> will be released in subsequent versions one after another.</p></blockquote><ul><li>ShenyuYamlEngine#agentConfig()</li></ul><p><code>ShenyuYamlEngine</code> provides how to customize the loading of files in <code>yaml</code> format.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public static ShenyuAgentConfig agentConfig(final File yamlFile) throws IOException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try (</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               // file inputStream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                FileInputStream fileInputStream = new FileInputStream(yamlFile);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                InputStreamReader inputStreamReader = new InputStreamReader(fileInputStream)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Constructor constructor = new Constructor(ShenyuAgentConfig.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            TypeDescription customTypeDescription = new TypeDescription(AgentPluginConfig.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            customTypeDescription.addPropertyParameters(&quot;plugins&quot;, Map.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            constructor.addTypeDescription(customTypeDescription);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //read yaml files by the Yaml toolkit </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new Yaml(constructor, new Representer(DUMPER_OPTIONS)).loadAs(inputStreamReader, ShenyuAgentConfig.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>ShenyuAgentConfig</code> is the specified Class .</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuAgentConfig {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // app name, default shenyu-agent </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String appName = &quot;shenyu-agent&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // supports plugin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Map&lt;String, List&lt;String&gt;&gt; supports = new LinkedHashMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // plugins info</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Map&lt;String, Map&lt;String, AgentPluginConfig&gt;&gt; plugins = new LinkedHashMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>AgentPluginConfig</code> is the Class  that specifies the plugin.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class AgentPluginConfig {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String host;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int port;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String password;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Properties props;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Through the configuration file, the user can specify which plug-in to enable and specify information about the properties of the plug-in.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="3-load-plugin"></a>3. Load Plugin<a class="hash-link" href="#3-load-plugin" title="Direct link to heading">#</a></h3><ul><li>ShenyuAgentPluginLoader#loadAllPlugins()</li></ul><p>After reading the configuration file, you need to load the specified plugin according to the user-defined configuration information. This is done by <code>ShenyuAgentPluginLoader</code>.</p><p><code>ShenyuAgentPluginLoader</code> is a custom class loader that uses the singleton design pattern.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// Custom ClassLoader, extends ClassLoader</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuAgentPluginLoader extends ClassLoader implements Closeable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ShenyuAgentPluginLoader AGENT_PLUGIN_LOADER = new ShenyuAgentPluginLoader();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private ShenyuAgentPluginLoader() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(ShenyuAgentPluginLoader.class.getClassLoader());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static ShenyuAgentPluginLoader getInstance() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return AGENT_PLUGIN_LOADER;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * load all plugins.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void loadAllPlugins() throws IOException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. locating the plugin path</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        File[] jarFiles = ShenyuAgentLocator.locatorPlugin().listFiles(file -&gt; file.getName().endsWith(&quot;.jar&quot;));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(jarFiles)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2.load plugin definition</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;String, ShenyuAgentJoinPoint&gt; pointMap = new HashMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try (ByteArrayOutputStream outputStream = new ByteArrayOutputStream()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (File each : jarFiles) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                outputStream.reset();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                JarFile jar = new JarFile(each, true);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                jars.add(new PluginJar(jar, each));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        loadAgentPluginDefinition(pointMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;String, ShenyuAgentJoinPoint&gt; joinPointMap = ImmutableMap.&lt;String, ShenyuAgentJoinPoint&gt;builder().putAll(pointMap).build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3.set join point</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuAgentTypeMatcher.getInstance().setJoinPointMap(joinPointMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="31-locating-the-plugin-path"></a>3.1 Locating the Plugin Path<a class="hash-link" href="#31-locating-the-plugin-path" title="Direct link to heading">#</a></h4><ul><li>ShenyuAgentLocator#locatorPlugin()</li></ul><p>After the entire <code>shenyu</code> project has been packaged in <code>maven</code> (by executing the <code>mvn clean install</code> command), the <code>agent</code> package directory is as follows.</p><p><img src="/assets/images/agent-jar-ddf92b3d50f674dbb1a77f9636794437.png"></p><p>The plugin files are in the form of <code>jar</code> packages.</p><ul><li>The <code>conf</code> directory is the directory location for configuration files.</li><li>The <code>plugins</code> directory is the directory location of individual plugins.</li></ul><p>The corresponding source code processing logic for locating the plugin path is as follows.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// The default plugin is located in the /plugins directory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public static File locatorPlugin() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new File(String.join(&quot;&quot;, locatorAgent().getPath(), &quot;/plugins&quot;));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// Locate the absolute path to shenyu-agent.jar</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public static File locatorAgent() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Find the class path (package name) where ShenyuAgentLocator is located</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String classResourcePath = String.join(&quot;&quot;, ShenyuAgentLocator.class.getName().replaceAll(&quot;\\.&quot;, &quot;/&quot;), &quot;.class&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Find the absolute path to the class: disk path + class path</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        URL resource = ClassLoader.getSystemClassLoader().getResource(classResourcePath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        assert resource != null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String url = resource.toString();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Whether it is in the form of a jar package</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int existFileInJarIndex = url.indexOf(&#x27;!&#x27;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        boolean isInJar = existFileInJarIndex &gt; -1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Find the path from the jar package or Find the path from the resource file</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return isInJar ? getFileInJar(url, existFileInJarIndex) : getFileInResource(url, classResourcePath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Find the path from the jar package</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static File getFileInJar(final String url, final int fileInJarIndex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // The absolute path to the jar package</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String realUrl = url.substring(url.indexOf(&quot;file:&quot;), fileInJarIndex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Create File objects with absolute paths</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            File agentJarFile = new File(new URL(realUrl).toURI());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Get the parent file</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return agentJarFile.exists() ? agentJarFile.getParentFile() : null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (final MalformedURLException | URISyntaxException ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>After getting all the plugin files, it will go to load the plugin definition, i.e. the interception point.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="32-load-agent-plugin-definition"></a>3.2 Load Agent Plugin Definition<a class="hash-link" href="#32-load-agent-plugin-definition" title="Direct link to heading">#</a></h4><ul><li>ShenyuAgentPluginLoader#loadAgentPluginDefinition()</li></ul><p>The default configuration for interception points is in the <code>conf/tracing-point.yaml</code> file, with the following configuration format.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">pointCuts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">targetClass</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> org.apache.shenyu.plugin.global.GlobalPlugin  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">points</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> instanceMethod </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> execute  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">handlers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">jaeger</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> org.apache.shenyu.agent.plugin.tracing.jaeger.handler.JaegerGlobalPluginHandler</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">opentelemetry</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> org.apache.shenyu.agent.plugin.tracing.opentelemetry.handler.OpenTelemetryGlobalPluginHandler</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">zipkin</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> org.apache.shenyu.agent.plugin.tracing.zipkin.handler.ZipkinGlobalPluginHandler</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // </span><span class="token punctuation" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">...</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The loading of interceptors is done by means of <code>SPI</code> and then these interceptors are collected.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain"> private void loadAgentPluginDefinition(final Map&lt;String, ShenyuAgentJoinPoint&gt; pointMap) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SPILoader.loadList(AgentPluginDefinition.class)  // SPI </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .forEach(each -&gt; each.collector().forEach(def -&gt; {  // collect</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    String classTarget = def.getClassTarget();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (pointMap.containsKey(classTarget)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ShenyuAgentJoinPoint pluginInterceptorPoint = pointMap.get(classTarget);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        pluginInterceptorPoint.getConstructorPoints().addAll(def.getConstructorPoints()); //constructor points</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        pluginInterceptorPoint.getInstanceMethodPoints().addAll(def.getInstanceMethodPoints()); // instance method points</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        pluginInterceptorPoint.getStaticMethodPoints().addAll(def.getStaticMethodPoints()); // static method points</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        pointMap.put(classTarget, def);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>SPILoader.loadList(AgentPluginDefinition.class)</li></ul><p><code>AgentPluginDefinition</code> is the interception point interface, marked by <code>@SPI</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@SPI // The interface is loaded via SPI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface AgentPluginDefinition {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * collect point </span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Collection&lt;ShenyuAgentJoinPoint&gt; collector();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>TracingAgentPluginDefinition</code> is one of its implementation classes to define the interception points for link tracing.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Join </span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class TracingAgentPluginDefinition extends AbstractAgentPluginDefinition {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // create join point </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected Collection&lt;JoinPointBuilder&gt; joinPointBuilder() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractAgentPluginDefinition implements AgentPluginDefinition {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //  create join point </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected abstract Collection&lt;JoinPointBuilder&gt; joinPointBuilder();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //  collect join point </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public final Collection&lt;ShenyuAgentJoinPoint&gt; collector() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The inheritance relationship between classes is as follows.</p><p><img src="/assets/images/agent-plugin-definition-50a8aedfcfa2f611803acc40d646fe35.png"></p><ul><li>AgentPluginDefinition#collector()</li></ul><p><code>AgentPluginDefinition</code> is just an interface that defines the operation methods for collecting interception points, and the concrete implementation is given to the subclasses.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractAgentPluginDefinition implements AgentPluginDefinition {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Subclasses to implement how to create interception points</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected abstract Collection&lt;JoinPointBuilder&gt; joinPointBuilder();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public final Collection&lt;ShenyuAgentJoinPoint&gt; collector() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get JoinPointBuilder</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Collection&lt;JoinPointBuilder&gt; joinPointBuilders = joinPointBuilder();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // create ShenyuAgentJoinPoint</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return joinPointBuilders.stream().map(JoinPointBuilder::install).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> // create ShenyuAgentJoinPoint</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public ShenyuAgentJoinPoint install() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // The four construction parameters are: target object, constructor interceptor point, instance method interceptor point, static method interceptor point</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new ShenyuAgentJoinPoint(classTarget, constructorPoints, instanceMethodPoints, classStaticMethodPoints);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>TracingAgentPluginDefinition#joinPointBuilder()</p><p>Create intercept points for tracing.</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class TracingAgentPluginDefinition extends AbstractAgentPluginDefinition {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // create join point</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected Collection&lt;JoinPointBuilder&gt; joinPointBuilder() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PointCutConfig config = null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Read the default interception point configuration file</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            config = ShenyuYamlEngine.unmarshal(ShenyuAgentLocator.locatorConf(&quot;tracing-point.yaml&quot;), PointCutConfig.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (IOException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(&quot;Exception loader tracing point config is&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // create join point</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return JoinPointBuilderFactory.create(config);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>JoinPointBuilderFactory#create()</p><p>Create an intercept point based on the specified profile .</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public static Collection&lt;JoinPointBuilder&gt; create(final PointCutConfig config) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //If there is no profile or it is empty, return the empty set</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(config) || config.getPointCuts().isEmpty()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return Collections.emptyList();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return config.getPointCuts().stream() // Get the interception point defined in the configuration file</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(pointCut -&gt; StringUtils.isNotEmpty(pointCut.getTargetClass())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &amp;&amp; !pointCut.getPoints().isEmpty() &amp;&amp; !pointCut.getHandlers().isEmpty()) // The intercept point must specify the target class, entry point, processor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(pointCut -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    JoinPointBuilder builder = ShenyuAgentJoinPoint.interceptClass(pointCut.getTargetClass()); // Set the target class to be intercepted</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Set&lt;String&gt; supports = ShenyuAgentConfigUtils.getSupports(); // Get which plugins are currently supported</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    List&lt;String&gt; handlers = pointCut.getHandlers().entrySet().stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .filter(entry -&gt; supports.contains(entry.getKey())) // The specified processor must be a currently supportable plugin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .flatMap(entry -&gt; entry.getValue().stream())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    String[] instanceMethods = pointCut</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .getPoints()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .filter(point -&gt; PointType.INSTANCE_METHOD.getName().equals(point.getType()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .map(Point::getName) // intercept instance methods</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .toArray(String[]::new);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (instanceMethods.length &gt; 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        builder.aroundInstanceMethod(ElementMatchers.namedOneOf(instanceMethods)).handlers(handlers).build(); // 为实例方法添加匹配器用于后续运行时动态匹配，并添加对应的处理器</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    String[] staticMethods = pointCut</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .getPoints()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .filter(point -&gt; PointType.STATIC_METHOD.getName().equals(point.getType()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .map(Point::getName)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .toArray(String[]::new); // intercept static methods</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (staticMethods.length &gt; 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        builder.aroundStaticMethod(ElementMatchers.namedOneOf(staticMethods)).handlers(handlers).build();// Add matchers to static methods for subsequent dynamic matching at runtime, and add corresponding handlers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    String[] constructorPoints = pointCut</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .getPoints()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .filter(point -&gt; PointType.CONSTRUCTOR.getName().equals(point.getType()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .map(Point::getName)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .toArray(String[]::new); // intercept constructor methods</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (constructorPoints.length &gt; 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        builder.onConstructor(ElementMatchers.namedOneOf(constructorPoints)).handlers(handlers).build();// Add a matcher to the constructor for subsequent dynamic matching at runtime, and add the corresponding handler</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return builder;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }).collect(Collectors.toList()); // return result</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The main implementation logic for creating an interception point is to read the configuration information according to the configuration file and add the corresponding handler for the target method of the specified target object. There are three types of handlers: instance method handlers, static method handlers, and constructor handlers.</p><p>The <code>ElementMatchers.namedOneOf()</code> method is used here, which indicates that the method name is in the specified parameter to match on the method. <code>ElementMatchers</code> is a class in <code>bytebuddy</code>, and in <code>ShenYu</code>, the creation of <code>agent</code> is also done through <code>bytebuddy</code>.</p><p>The collected intercept points are later created as the intercept point object <code>ShenyuAgentJoinPoint</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public final Collection&lt;ShenyuAgentJoinPoint&gt; collector() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // join point</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Collection&lt;JoinPointBuilder&gt; joinPointBuilders = joinPointBuilder();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // create ShenyuAgentJoinPoint</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return joinPointBuilders.stream().map(JoinPointBuilder::install).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>After collecting the intercept points, the intercept point information is saved with <code>Map</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// pointMap: Key and Value denote target class, interception point respectively</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private void loadAgentPluginDefinition(final Map&lt;String, ShenyuAgentJoinPoint&gt; pointMap) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SPILoader.loadList(AgentPluginDefinition.class)  // SPI </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .forEach(each -&gt; each.collector().forEach(def -&gt; {  // collect</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    String classTarget = def.getClassTarget();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (pointMap.containsKey(classTarget)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ShenyuAgentJoinPoint pluginInterceptorPoint = pointMap.get(classTarget);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        pluginInterceptorPoint.getConstructorPoints().addAll(def.getConstructorPoints()); // constructor method points</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        pluginInterceptorPoint.getInstanceMethodPoints().addAll(def.getInstanceMethodPoints()); // instance method points</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        pluginInterceptorPoint.getStaticMethodPoints().addAll(def.getStaticMethodPoints()); // static method points</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        pointMap.put(classTarget, def); // Save intercept point information to Map</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="33-set-joint-point"></a>3.3 Set Joint Point<a class="hash-link" href="#33-set-joint-point" title="Direct link to heading">#</a></h4><p>The last step in the process of loading all plugins is to set the blocking point.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">     public void loadAllPlugins() throws IOException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1.Locating the plugin path</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2.Loading Plugin Definitions</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3.Set intercept points</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuAgentTypeMatcher.getInstance().setJoinPointMap(joinPointMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Setting intercept points is to save the set of intercept points to the <code>ShenyuAgentTypeMatcher</code> class. It implements the <code>ElementMatcher</code> interface for custom matching logic. <code>ElementMatcher</code> is also an interface in <code>bytebuddy</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuAgentTypeMatcher extends ElementMatcher.Junction.AbstractBase&lt;TypeDefinition&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ShenyuAgentTypeMatcher SHENYU_AGENT_TYPE_MATCHER = new ShenyuAgentTypeMatcher();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Map&lt;String, ShenyuAgentJoinPoint&gt; joinPointMap;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private ShenyuAgentTypeMatcher() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static ShenyuAgentTypeMatcher getInstance() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return SHENYU_AGENT_TYPE_MATCHER;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //Customize the matching logic, the target class is matched successfully when it is in the set of interceptor points</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean matches(final TypeDefinition target) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return joinPointMap.containsKey(target.getTypeName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Set the set of interception points</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setJoinPointMap(final Map&lt;String, ShenyuAgentJoinPoint&gt; joinPointMap) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.joinPointMap = joinPointMap;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="4-create-agent"></a>4. Create Agent<a class="hash-link" href="#4-create-agent" title="Direct link to heading">#</a></h3><p>The agent created by is used to change the behavior of the target class.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain"> public static void premain(final String arguments, final Instrumentation instrumentation) throws Exception {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. Read configuration file</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2. Load all plugins</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3. Create Agent</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        AgentBuilder agentBuilder = new AgentBuilder.Default().with(new ByteBuddy().with(TypeValidation.ENABLED)) // Create Agent with ByteBuddy and turn on type-checking</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .ignore(ElementMatchers.isSynthetic()) // Ignore synthetic</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .or(ElementMatchers.nameStartsWith(&quot;org.apache.shenyu.agent.&quot;)); // Ignore the class org.apache.shenyu.agent</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        agentBuilder.type(ShenyuAgentTypeMatcher.getInstance())//Matching load type, the matcher is ShenyuAgentTypeMatcher</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .transform(new ShenyuAgentTransformer()) // If the match is successful, change its behavior through ShenyuAgentTransformer</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .with(AgentBuilder.RedefinitionStrategy.RETRANSFORMATION) //Specifying redefinition policies</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .with(new TransformListener()) /Specify a listener to listen for events during runtime</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .installOn(instrumentation); // Apply the changes to the Instrumentation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 4. Start Plugin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In the process of creating an agent, two points need to be noted.</p><ul><li>Whether the match is successful or not, determined by <code>ShenyuAgentTypeMatcher</code>.</li><li>the behavior of the successful match class, which is changed by <code>ShenyuAgentTransformer</code>.</li></ul><p>Next we will focus on analyzing these two classes.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="41-define-the-matching-logic"></a>4.1 Define the matching logic<a class="hash-link" href="#41-define-the-matching-logic" title="Direct link to heading">#</a></h4><ul><li>ShenyuAgentTypeMatcher#matches()</li></ul><p><code>ShenyuAgentTypeMatcher</code> uses the singleton design pattern, implements the <code>ElementMatcher</code> interface and overrides the <code>matches()</code> method.</p><p>The logic of whether the match is successful or not is: if the target class is in the <code>joinPointMap</code> set of interceptor points, the match is successful.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuAgentTypeMatcher extends ElementMatcher.Junction.AbstractBase&lt;TypeDefinition&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Map&lt;String, ShenyuAgentJoinPoint&gt; joinPointMap;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Custom matching logic: if the target class is in the intercept point joinPointMap collection, the match is successful</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean matches(final TypeDefinition target) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return joinPointMap.containsKey(target.getTypeName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="42-changing-the-behavior-of-matching-classes"></a>4.2 Changing the behavior of matching classes<a class="hash-link" href="#42-changing-the-behavior-of-matching-classes" title="Direct link to heading">#</a></h4><p>When loading the target class, if the match is successful, it will change its behavior through <code>ShenyuAgentTransformer</code>, which implements the <code>Transformer</code> interface and overrides the <code>transform()</code> method, <code>Transformer</code> is also an interface to <code>bytebuddy</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuAgentTransformer implements Transformer {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //Define an additional field in the match class to pass contextual information</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final String EXTRA_DATA = &quot;_$EXTRA_DATA$_&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //Type Matcher    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ShenyuAgentTypeMatcher MATCHER = ShenyuAgentTypeMatcher.getInstance();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //Rewrite the transform method to redefine the behavior of the matching class</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //Execute once during the load class</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Builder&lt;?&gt; transform(final Builder&lt;?&gt; builder, final TypeDescription typeDescription, final ClassLoader classLoader, final JavaModule module) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //skip if not a matching class</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!MATCHER.containsType(typeDescription)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return builder;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //add a new field for the class</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Builder&lt;?&gt; result = builder.defineField(EXTRA_DATA, Object.class, Opcodes.ACC_PRIVATE | Opcodes.ACC_VOLATILE).implement(TargetObject.class).intercept(FieldAccessor.ofField(EXTRA_DATA));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get join point</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuAgentJoinPoint joinPoint = MATCHER.loadShenyuAgentJoinPoint(typeDescription);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //interceptor constructor point</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        result = interceptorConstructorPoint(typeDescription, joinPoint.getConstructorPoints(), result);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //interceptor static method point</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        result = interceptorStaticMethodPoint(typeDescription, joinPoint.getStaticMethodPoints(), result);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //interceptor instance method Point</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        result = interceptorInstanceMethodPoint(typeDescription, joinPoint.getInstanceMethodPoints(), result);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In the <code>transform()</code> method, the behavior of the match class is redefined.</p><ul><li>New field, a subclass of <code>TargetObject</code>, for passing the context.</li><li>Whether to intercept constructors, depending on the specified configuration.</li><li>Whether to intercept static methods, according to the specified configuration.</li><li>intercepting instance methods, according to the specified configuration.</li></ul><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="423-interceptor-instance-method-point"></a>4.2.3 Interceptor Instance Method Point<a class="hash-link" href="#423-interceptor-instance-method-point" title="Direct link to heading">#</a></h5><ul><li>ShenyuAgentTransformer#interceptorInstanceMethodPoint()</li></ul><p>Constructs an instance method intercept point based on a cutscene to get a <code>Builder</code> object.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private Builder&lt;?&gt; interceptorInstanceMethodPoint(final TypeDescription description, final Collection&lt;InstanceMethodPointCut&gt; pointCuts, final Builder&lt;?&gt; builder) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Collection&lt;ShenyuAgentTransformerPoint&lt;?&gt;&gt; points = description.getDeclaredMethods().stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(each -&gt; !(each.isAbstract() || each.isSynthetic())) //Filtering abstract methods, synthetic methods</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(each -&gt; buildInstanceMethodTransformationPoint(pointCuts, each)) //Constructing example method intercept points</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(Objects::nonNull)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return getBuilder(description, builder, points); //get Builder</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>ShenyuAgentTransformer#buildInstanceMethodTransformationPoint()</li></ul><p>Filter the matched methods, get the corresponding <code>handler</code> handler for the method, and finally create an instance method interception point object.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private ShenyuAgentTransformerPoint&lt;?&gt; buildInstanceMethodTransformationPoint(final Collection&lt;InstanceMethodPointCut&gt; pointCuts, final InDefinedShape methodDescription) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;InstanceMethodPointCut&gt; points = pointCuts.stream().filter(point -&gt; point.getMatcher().matches(methodDescription)).collect(Collectors.toList()); //Filter the methods that can match on</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (points.isEmpty()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;InstanceMethodHandler&gt; handlers = points.stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .flatMap(pointCut -&gt; pointCut.getHandlers().stream())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(handler -&gt; (InstanceMethodHandler) MATCHER.getOrCreateInstance(handler)) //Get the corresponding handler processor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(Objects::nonNull)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new ShenyuAgentTransformerPoint&lt;&gt;(methodDescription, new InstanceMethodInterceptor(handlers));//Create instance method interceptor object, create instance method interceptor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Whether the method matches successfully: whether the current method name is the method name configured in the <code>tracing-point.yaml</code> file.</p><p><code>handler</code> fetching: is based on the fully qualified name configured in the <code>tracing-point.yaml</code> file to load the corresponding class.</p><ul><li>InstanceMethodInterceptor#intercept()</li></ul><p>The instance method interceptor <code>InstanceMethodInterceptor</code> dynamically handles intercept methods during runtime.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class InstanceMethodInterceptor {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Intercept of target objects.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param target </span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param method </span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param args </span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param callable </span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return </span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @throws </span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @RuntimeType //Define the runtime target method</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object intercept(@This final Object target, @Origin final Method method, @AllArguments final Object[] args, @SuperCall final Callable&lt;?&gt; callable) throws Exception {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //Target method implementation results</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object result = null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //Target Object</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        TargetObject instance = (TargetObject) target;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //instance method handler</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (InstanceMethodHandler handler : handlerList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            MethodResult methodResult = new MethodResult();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Pre-processing logic</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                handler.before(instance, method, args, methodResult);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (final Throwable ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.error(&quot;Failed to execute the before method of method {} in class {}&quot;, method.getName(), target.getClass(), ex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //Calling the target method</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                result = callable.call();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (final Throwable ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               //Handling exception</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    handler.onThrowing(instance, method, args, ex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (final Throwable ignored) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOG.error(&quot;Failed to execute the error handler of method {} in class {}&quot;, method.getName(), target.getClass(), ex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw ex;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } finally {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //Post-processing logic</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    result = handler.after(instance, method, args, methodResult, result);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (final Throwable ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOG.error(&quot;Failed to execute the after method of method {} in class {}&quot;, method.getName(), target.getClass(), ex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //Returns the result of the target method call</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The instance method interceptor adds pre-processing logic, post-processing logic, and exception handling logic before the target method is called.</p><p>Several annotations of <code>Byte Buddy</code> are used here.</p><ul><li><code>@RuntimeType</code>: defines the target method at runtime, prompting <code>ByteBuddy</code> to disable strict type checking.</li><li><code>@This</code>: the current intercepted, dynamically generated instance object.</li><li><code>@Origin</code>: the original method.</li><li><code>@AllArguments</code>: get all incoming parameters.</li><li><code>@SuperCall</code>: used to call the parent class version of the method.</li></ul><p>Instance method handler <code>InstanceMethodHandler</code> only defines three interfaces, and the specific implementation logic is handled by the specific plugin.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public interface InstanceMethodHandler {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     // Pre-processing logic</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    default void before(final TargetObject target, final Method method, final Object[] args, final MethodResult result) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Post-processing logic</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    default Object after(final TargetObject target, final Method method, final Object[] args, final MethodResult methodResult, final Object result) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Exception handling logic</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    default void onThrowing(final TargetObject target, final Method method, final Object[] args, final Throwable throwable) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>ShenyuAgentTransformer#getBuilder()</li></ul><p>When the <code>Builder</code> of the <code>Agent</code> is acquired, the corresponding interceptor is specified for the specified target method, new logic is added to the original method, and the behavior of the original method is changed.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static Builder&lt;?&gt; getBuilder(final TypeDescription description, final Builder&lt;?&gt; builder, final Collection&lt;ShenyuAgentTransformerPoint&lt;?&gt;&gt; points) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Builder&lt;?&gt;[] result = {builder};</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        points.forEach(point -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                result[0] = builder.method(ElementMatchers.is(point.getDescription()))//Specify the target method</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        .intercept(MethodDelegation.withDefaultConfiguration().to(point.getInterceptor()));//Specifying Interceptor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // CHECKSTYLE:OFF</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (final Throwable ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // CHECKSTYLE:ON</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.error(&quot;Failed to load handler class: {}&quot;, description.getTypeName(), ex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result[0];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>With the above processing logic, it is possible to intercept the instance method without intrusion.</p><p>The processing logic of the intercept method <code>intercept()</code> is</p><ul><li>Processing each <code>handler</code> in turn.</li><li>Calling the predecessor method of <code>handler</code>.</li><li>Calling the target method.</li><li>calling the exception handling method of <code>handler</code> if the target method has an exception.</li><li>Calling the post method of <code>handler</code>.</li></ul><p>Next, look at intercepting static methods.</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="423-interceptor-static-method-point"></a>4.2.3 Interceptor Static Method Point<a class="hash-link" href="#423-interceptor-static-method-point" title="Direct link to heading">#</a></h5><ul><li>ShenyuAgentTransformer#interceptorStaticMethodPoint()</li></ul><p>Filter out static methods, then build static method intercept points for static methods.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private Builder&lt;?&gt; interceptorStaticMethodPoint(final TypeDescription description, final Collection&lt;StaticMethodPointCut&gt; pointCuts, final Builder&lt;?&gt; builder) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Collection&lt;ShenyuAgentTransformerPoint&lt;?&gt;&gt; points = description.getDeclaredMethods().stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(each -&gt; each.isStatic() &amp;&amp; !(each.isAbstract() || each.isSynthetic())) // The current method is a static method, not an abstract method, not a synthetic method</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(methodDescription -&gt; buildStaticMethodTransformationPoint(pointCuts, methodDescription)) // Building static method intercept points</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(Objects::nonNull)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return getBuilder(description, builder, points);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>ShenyuAgentTransformer#buildStaticMethodTransformationPoint()</li></ul><p>Filter according to the configuration file to determine whether the current static method needs to be intercepted. Then get the corresponding handler and finally build the static method interceptor object.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private ShenyuAgentTransformerPoint&lt;?&gt; buildStaticMethodTransformationPoint(final Collection&lt;StaticMethodPointCut&gt; pointCuts, final InDefinedShape methodDescription) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;StaticMethodPointCut&gt; staticMethodPoints = pointCuts.stream().filter(point -&gt; point.getMatcher().matches(methodDescription)).collect(Collectors.toList()); //Filter based on the configuration file to determine if the current static method needs to be intercepted</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (staticMethodPoints.isEmpty()) { // If there is no configuration, it returns directly</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;StaticMethodHandler&gt; handlers = staticMethodPoints.stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .flatMap(pointCut -&gt; pointCut.getHandlers().stream())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(handler -&gt; (StaticMethodHandler) MATCHER.getOrCreateInstance(handler)) //Get the corresponding processor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(Objects::nonNull)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new ShenyuAgentTransformerPoint&lt;&gt;(methodDescription, new StaticMethodInterceptor(handlers)); //Constructing static method interceptor objects</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>StaticMethodInterceptor#intercept()</li></ul><p>At runtime, the target method is intercepted and the processing logic of the interceptor is executed .</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class StaticMethodInterceptor {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   //......  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Intercept of target methods.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @RuntimeType</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object intercept(@Origin final Class&lt;?&gt; klass, @Origin final Method method, @AllArguments final Object[] args, @SuperCall final Callable&lt;?&gt; callable) throws Exception {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object result = null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // handler</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (StaticMethodHandler handler : handlerList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            MethodResult methodResult = new MethodResult();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //Pre-processing method</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                handler.before(klass, method, args, new MethodResult());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (final Throwable ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.error(&quot;Failed to execute the before method of method {} in class {}&quot;, method.getName(), klass, ex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Calling the current method</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                result = callable.call();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (final Throwable ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    //Exception logic handling</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    handler.onThrowing(klass, method, args, ex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (final Throwable ignored) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOG.error(&quot;Failed to execute the error handler of method {} in class {}&quot;, method.getName(), klass, ex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw ex;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } finally {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // Post-processing method</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    handler.after(klass, method, args, methodResult);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (final Throwable ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOG.error(&quot;Failed to execute the after method of method {} in class {}&quot;, method.getName(), klass, ex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //return resullt</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The processing logic of the intercept method <code>intercept()</code> is</p><ul><li>Process each <code>handler</code> in turn.</li><li>Calling the predecessor method of <code>handler</code>.</li><li>Calling the target method.</li><li>calling the exception handling method of <code>handler</code> if the target method has an exception.</li><li>call the post method of <code>handler</code>.</li></ul><p>Finally, let&#x27;s look at how to intercept constructors.</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="423-interceptor-constructor-point"></a>4.2.3 Interceptor Constructor Point<a class="hash-link" href="#423-interceptor-constructor-point" title="Direct link to heading">#</a></h5><ul><li>ShenyuAgentTransformer#interceptorConstructorPoint()</li></ul><p>Filter out constructors, then build interceptor points for constructors, and finally create <code>builder</code> objects to add interceptors to constructor methods.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain"> private Builder&lt;?&gt; interceptorConstructorPoint(final TypeDescription description, final Collection&lt;ConstructorPointCut&gt; constructorPoints, final Builder&lt;?&gt; builder) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Collection&lt;ShenyuAgentTransformerPoint&lt;? extends ConstructorInterceptor&gt;&gt; constructorAdviceComposePoints = description.getDeclaredMethods().stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(MethodDescription::isConstructor) //Filter out constructors</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(each -&gt; buildConstructorTransformerPoint(constructorPoints, each))//Interception points for constructing constructors</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(Objects::nonNull)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Builder&lt;?&gt;[] result = {builder};</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     // Create builder object, add interceptor to constructor method</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        constructorAdviceComposePoints.forEach(point -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                result[0] = builder.constructor(ElementMatchers.is(point.getDescription()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        .intercept(SuperMethodCall.INSTANCE.andThen(MethodDelegation.withDefaultConfiguration()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                .to(point.getInterceptor())));//Call the parent class constructor first, then add the interceptor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // CHECKSTYLE:OFF</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (final Throwable ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // CHECKSTYLE:ON</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.error(&quot;Failed to load handler class: {}&quot;, description.getTypeName(), ex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result[0];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>ShenyuAgentTransformer#buildConstructorTransformerPoint()</li></ul><p>First get the constructor interceptor point, then create the <code>handler</code> instance object for the interceptor point, and finally create the constructor interceptor object.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private ShenyuAgentTransformerPoint&lt;? extends ConstructorInterceptor&gt; buildConstructorTransformerPoint(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final Collection&lt;ConstructorPointCut&gt; constructorPoints, final InDefinedShape methodDescription) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //Get constructor intercept points</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ConstructorPointCut&gt; constructorPointCutList = constructorPoints.stream().filter(each -&gt; each.getMatcher().matches(methodDescription)).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (constructorPointCutList.isEmpty()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ConstructorHandler&gt; handlers = constructorPointCutList.stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .flatMap(pointCut -&gt; pointCut.getHandlers().stream())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(handler -&gt; (ConstructorHandler) MATCHER.getOrCreateInstance(handler)) //Create the handler instance object of the interception point</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(Objects::nonNull)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new ShenyuAgentTransformerPoint&lt;&gt;(methodDescription, new ConstructorInterceptor(handlers));//Creating Constructor Interceptors</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>ConstructorInterceptor#intercept()</li></ul><p>Constructor interceptor: executes the processing logic for each <code>handler</code> before calling the constructor of the target method.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ConstructorInterceptor {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Interception methods.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @RuntimeType</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void intercept(@This final TargetObject target, @AllArguments final Object[] args) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (ConstructorHandler handler : handlerList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // handler processing logic</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                handler.onConstructor(target, args);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (final Throwable throwable) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.error(&quot;Constructor advice execution error. class: {}&quot;, target.getClass().getTypeName(), throwable);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>At this point, we have finished analyzing the entire process of creating <code>agent</code>.</p><ul><li>defining the matching logic <code>ShenyuAgentTypeMatcher</code> according to the configuration file.</li><li>defining the <code>ShenyuAgentTransformer</code> object, which changes the behavior of the matching class.</li><li>intercepting instance object methods through <code>InstanceMethodInterceptor</code>.</li><li>intercepting static methods via <code>StaticMethodInterceptor</code>.</li><li>Intercepting constructors via <code>ConstructorInterceptor</code>.</li></ul><p>The processing logic of each <code>handler</code> is not mentioned here because the implementation logic of the <code>handler</code> is customized by each plug-in. For example, the implementation classes of the current instance method interceptor <code>InstanceMethodHandler</code> are <code>jaeger</code>, <code>opentelemetry</code> and <code>zipkin</code>.</p><p><img src="/assets/images/instance_method_handler-309e74ac5f633743f57a9b60039f2486.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="5-start-plugin"></a>5. Start Plugin<a class="hash-link" href="#5-start-plugin" title="Direct link to heading">#</a></h3><p>After creating the <code>agent</code>, start each plugin.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain"> public static void premain(final String arguments, final Instrumentation instrumentation) throws Exception {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. Read configuration file</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2. Load all plugins</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3. Create agent</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 4. Start Plugin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PluginLifecycleManager lifecycleManager = new PluginLifecycleManager();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        lifecycleManager.startup(ShenyuAgentConfigUtils.getPluginConfigMap());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //Add hook function for closing the plugin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Runtime.getRuntime().addShutdownHook(new Thread(lifecycleManager::close));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>PluginLifecycleManager</li></ul><p>The <code>PluginLifecycleManager</code> is responsible for the plugin lifecycle management, which is used to start the plugin and close it.</p><p>The startup of the plugin has to be specified in the configuration file.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class PluginLifecycleManager {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   //......      </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Start Plugin.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void startup(final Map&lt;String, AgentPluginConfig&gt; configMap) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //Get the names of supported plugins from the configuration file</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Set&lt;String&gt; support = ShenyuAgentConfigUtils.getSupports();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        configMap.entrySet().stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(entry -&gt; support.contains(entry.getKey())) //Included in the configuration file</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .forEach(entry -&gt; Optional.ofNullable(SPILoader.load(AgentPluginBootService.class, entry.getKey())) //Loading plugin starter classes by SPI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        .ifPresent(bootService -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                LOG.info(&quot;start shenyu plugin: {}&quot;, entry.getKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                bootService.start(entry.getValue());  // Start the plugin: executing the specific launch logic of the plugin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            } catch (final Throwable ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                LOG.error(&quot;Failed to start shenyu plugin&quot;, ex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * close</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void close() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //Loading plugin starter classes by SPI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SPILoader.loadList(AgentPluginBootService.class).forEach(each -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                each.close(); // Close the plugin: execute the specific closing logic of the plugin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (final Throwable ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.error(&quot;Failed to close shenyu agent plugin&quot;, ex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Plugins are also started and closed with each plugin specifically to be implemented, and then loaded by <code>SPI</code>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="6-summary"></a>6. Summary<a class="hash-link" href="#6-summary" title="Direct link to heading">#</a></h3><ul><li>the <code>shenyu-agent</code> module is implemented mainly through the <code>Byte Buddy</code> toolkit.</li><li>specifying the plugin information in the configuration file <code>shenyu-agent.yaml</code>.</li><li>the plugin loading process is done via <code>SPI</code>.</li><li>interception points are specified through the configuration file, with a flexible design.</li><li>Separate plugin interface definition and implementation, supporting multiple plugin types.</li></ul></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_xD8n"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/zookeeper">zookeeper</a><a class="margin-horiz--sm" href="/blog/tags/data-sync">data sync</a><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div><div class="col margin-top--sm"><a href="https://github.com/apache/incubator-shenyu-website/edit/main/blog/Agent-SourceCode-Analysis.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/DataSync-SourceCode-Analysis-Etcd-Data-Sync"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Etcd Data Synchronization Source Code Analysis »</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#aboutaop" class="table-of-contents__link">AboutAOP</a></li><li><a href="#about-byte-buddy" class="table-of-contents__link">About Byte Buddy</a></li><li><a href="#1-premain-method" class="table-of-contents__link">1. premain method</a></li><li><a href="#2-read-config-file" class="table-of-contents__link">2. Read Config File</a></li><li><a href="#3-load-plugin" class="table-of-contents__link">3. Load Plugin</a></li><li><a href="#4-create-agent" class="table-of-contents__link">4. Create Agent</a></li><li><a href="#5-start-plugin" class="table-of-contents__link">5. Start Plugin</a></li><li><a href="#6-summary" class="table-of-contents__link">6. Summary</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">ShenYu</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/download">Download</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/index">Document</a></li><li class="footer__item"><a class="footer__link-item" href="/news">News</a></li><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/apache/incubator-shenyu/releases" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Releases<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/community/subscribe-email">Community</a></li><li class="footer__item"><a href="https://github.com/apache/incubator-shenyu" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/apache/incubator-shenyu/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Issue Tracker<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Subscribe mailing list</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/community/subscribe-email">How to subscribe</a></li><li class="footer__item"><a href="mailto://dev-subscribe@shenyu.apache.org" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Subscribe Mail<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://lists.apache.org/list.html?dev@shenyu.apache.org" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Mail Archive<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright"><div><img style="height:50px" alt="Apache Software Foundation" src="/img/incubator-logo.png"><p style="color:#ffffffcf;font-size:14px;text-align:left">Apache ShenYu is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.</p>
      <p style="color:white;font-size:14px;"> Copyright © 2022 The Apache Software Foundation. Licensed under the Apache License, Version 2.0. Apache ShenYu, Apache Incubator, Apache, the Apache feather logo, the Apache ShenYu logo and the Apache Incubator project logo are trademarks of The Apache Software Foundation.</p>
      <div></div></div></div></div></div></footer></div>
<script src="/assets/js/runtime~main.99a58cf7.js"></script>
<script src="/assets/js/main.1e439982.js"></script>
</body>
</html>